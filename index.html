<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- MODIFIED: SEO Meta Tags -->
    <meta name="keywords" id="meta-keywords" content="">
    <meta name="description" id="meta-description" content="">
    <!-- NEW: Favicon link -->
    <link id="favicon" rel="icon" href="https://placehold.co/32x32/facc15/000000?text=NB" type="image/x-icon">
    <title>NewBees - The Infants World</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- MODIFIED: Added new fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@400;700&family=Roboto+Mono:wght@400;700&family=Orbitron:wght@700&family=Anton&family=Fredoka:wght@400;700&family=Carlito:wght@400;700&family=Audiowide&display=swap" rel="stylesheet">
    <style id="dynamic-styles">
        /* CSS variables for dynamic colors and styles */
        :root {
            --product-card-bg: #ffffff;
            --add-to-cart-btn-bg: #111827;
            --product-text-color: #1f2937;
            --sale-badge-bg: #ef4444;
            --sale-badge-text: #ffffff;
            --sold-badge-bg: #3b82f6;
            --sold-badge-text: #ffffff;
            --original-price-color: #6b7280;
            --sale-price-color: #1f2937;
            /* NEW: Button customization variables */
            --btn-padding-y: 0.5rem;
            --btn-padding-x: 1rem;
            --add-to-cart-btn-radius: 0.375rem;
            --view-btn-radius: 0.375rem;
            --view-btn-bg: #e5e7eb;
            --view-btn-text: #ffffff;
            /* NEW: Category button gradient */
            --category-btn-gradient-from: #fb923c;
            --category-btn-gradient-to: #ea580c;
            /* NEW: Product card rounding */
            --product-card-radius: 0.5rem; /* Corresponds to rounded-lg */
            /* NEW: Stock Status Size */
            --product-stock-status-font-size: 0.875rem;
            /* NEW: Floating Reviews Button Gradient & Text Color */
            --reviews-btn-gradient-from: #f59e0b;
            --reviews-btn-gradient-to: #fbbf24;
            --reviews-btn-text-color: #1f2937;
            /* MODIFIED: Star color variable for products */
            --star-color: #facc15;
            /* NEW: Support Button Customization */
            --support-btn-gradient-from: #3b82f6;
            --support-btn-gradient-to: #60a5fa;
            --support-btn-text-color: #ffffff;
            /* NEW: Product Card Font Variables */
            --product-name-font-family: 'Inter', sans-serif;
            --product-name-font-weight: 700;
            --product-price-font-family: 'Inter', sans-serif;
            --product-price-font-weight: 700;
            --product-price-font-size: 1.125rem; /* Corresponds to text-lg */
             /* NEW: Product Detail Price Font Variables */
            --pd-original-price-font-family: 'Inter', sans-serif;
            --pd-original-price-font-weight: 400;
            --pd-original-price-color: #6b7280;
            --pd-sale-price-font-family: 'Inter', sans-serif;
            --pd-sale-price-font-weight: 700;
            --pd-sale-price-color: #1f2937;
             /* NEW: Review Font Variables */
            --review-font-family: 'Inter', sans-serif;
            --review-font-weight: 400;
            --review-text-color: #4b5563; /* gray-600 */
            --review-font-size: 16px;
        }
        .product-card { background-color: var(--product-card-bg); border-radius: var(--product-card-radius); }
        .product-card .product-text { color: var(--product-text-color); }
        .add-to-cart-btn {
            background-color: var(--add-to-cart-btn-bg);
            padding: var(--btn-padding-y) var(--btn-padding-x);
            border-radius: var(--add-to-cart-btn-radius);
        }
        .view-product-btn {
            background-color: var(--view-btn-bg);
            color: var(--view-btn-text);
            padding: var(--btn-padding-y) var(--btn-padding-x);
            border-radius: var(--view-btn-radius);
        }
        .sale-badge { background-color: var(--sale-badge-bg); color: var(--sale-badge-text); }
        .sold-badge { background-color: var(--sold-badge-bg); color: var(--sold-badge-text); }
        .price-original { color: var(--original-price-color); }
        .price-sale { color: var(--sale-price-color); }
        .category-btn {
            background-image: linear-gradient(to right, var(--category-btn-gradient-from), var(--category-btn-gradient-to), var(--category-btn-gradient-from));
        }
        .stock-status-container { font-size: var(--product-stock-status-font-size); }
        #floating-reviews-btn {
            background: linear-gradient(135deg, var(--reviews-btn-gradient-from), var(--reviews-btn-gradient-to));
            color: var(--reviews-btn-text-color);
        }
        /* MODIFIED: Apply star-color to ALL stars */
        .star-rating-display,
        .review-star-animated,
        .star-rating-input input:checked ~ label,
        .star-rating-input label:hover,
        .star-rating-input label:hover ~ label {
            color: var(--star-color);
        }
        /* NEW: Support button dynamic styles */
        #floating-support-btn {
             background: linear-gradient(135deg, var(--support-btn-gradient-from), var(--support-btn-gradient-to));
             color: var(--support-btn-text-color);
        }
        /* NEW: Product Card Font Styles */
        .product-card-name {
            font-family: var(--product-name-font-family);
            font-weight: var(--product-name-font-weight);
        }
        .product-card-price {
            font-family: var(--product-price-font-family);
            font-weight: var(--product-price-font-weight);
            font-size: var(--product-price-font-size);
        }
        .product-card .price-original {
             font-size: 0.8em; /* Make original price slightly smaller relative to sale price */
        }
         /* NEW: Product Detail Price Styles */
        #product-detail-price .price-original {
            font-family: var(--pd-original-price-font-family);
            font-weight: var(--pd-original-price-font-weight);
            color: var(--pd-original-price-color);
        }
        #product-detail-price .price-sale {
            font-family: var(--pd-sale-price-font-family);
            font-weight: var(--pd-sale-price-font-weight);
            color: var(--pd-sale-price-color);
        }
         /* NEW: Review Card Font Styles */
        .review-card .review-quote {
            font-family: var(--review-font-family);
            font-weight: var(--review-font-weight);
            color: var(--review-text-color);
            font-size: var(--review-font-size);
        }
    </style>
    <style>
        /* --- Base Styles & Fonts --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f7fa;
            background-image: linear-gradient(180deg, #f8f7fa 0%, #ffffff 100%);
        }
        .font-pricedown { font-family: 'Bebas Neue', sans-serif; letter-spacing: 1.5px; }
        .font-gta { font-family: 'Bebas Neue', sans-serif; }
        .font-serif-elegant { font-family: 'Playfair Display', serif; }
        .font-mono { font-family: 'Roboto Mono', monospace; }
        .font-scifi { font-family: 'Orbitron', sans-serif; }
        /* MODIFIED: Added new fonts */
        .font-anton { font-family: 'Anton', sans-serif; }
        .font-fredoka { font-family: 'Fredoka', sans-serif; }
        .font-calibri-alt { font-family: 'Carlito', sans-serif; }
        .font-horizon-alt { font-family: 'Audiowide', sans-serif; }

        /* --- Announcement Bar Animation --- */
        .announcement-bar-content { animation: scroll-left 40s linear infinite; }
        @keyframes scroll-left { 0% { transform: translateX(0%); } 100% { transform: translateX(-50%); } }
        
        /* MODIFIED: Countdown Timer Styling */
        .countdown-container-outer { display: inline-flex; align-items: center; gap: 0.5rem; font-family: 'Roboto Mono', monospace;}
        .timer-box { display: flex; flex-direction: column; align-items: center; background: rgba(0,0,0,0.2); padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
        .timer-digits { font-size: 1.1em; font-weight: 700; }
        .timer-label { font-size: 0.6em; text-transform: uppercase; }

        /* --- Hero Text Animations --- */
        .shiny-text {
            background: linear-gradient(to right, #9ca3af, #f9fafb, #9ca3af);
            background-size: 200% auto; color: #fff; background-clip: text;
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: shine 5s linear infinite;
        }
        @keyframes shine { to { background-position: 200% center; } }
        .fade-in { animation: fadeInAnimation 2s ease-in-out forwards; opacity: 0; }
        @keyframes fadeInAnimation { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .blur-in { animation: blurInAnimation 2s ease-out forwards; filter: blur(8px); opacity: 0; }
        @keyframes blurInAnimation { from { filter: blur(8px); opacity: 0; } to { filter: blur(0); opacity: 1; } }
        .typewriter-text {
            overflow: hidden; border-right: .15em solid orange; white-space: nowrap; margin: 0 auto;
            letter-spacing: .1em; animation: typing 3.5s steps(30, end), blink-caret .75s step-end infinite;
        }
        @keyframes typing { from { width: 0 } to { width: 100% } }
        @keyframes blink-caret { from, to { border-color: transparent } 50% { border-color: orange; } }

        /* --- Product Card & Slider--- */
        .product-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            transform-style: preserve-3d;
            flex-shrink: 0;
        }
        /* NEW: Product fade-in animation */
        .product-fade-in {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        .product-fade-in.is-visible {
            opacity: 1;
            transform: translateY(0);
        }
        .product-card:hover {
            transform: perspective(1000px) rotateY(5deg) rotateX(5deg) scale(1.05);
        }
        .product-card-default { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
        .product-card-default:hover { box-shadow: 0 20px 30px -10px rgba(0,0,0,0.3); }
        .product-card-minimal { border: 1px solid #e5e7eb; box-shadow: none; }
        .product-card-minimal:hover { border-color: #9ca3af; transform: scale(1.05); }

        .product-slider-container { scroll-behavior: smooth; -ms-overflow-style: none; scrollbar-width: none; }
        .product-slider-container::-webkit-scrollbar { display: none; }
        
        .color-swatch {
            width: 24px; height: 24px;
            border-radius: 50%;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .color-swatch:hover { transform: scale(1.1); }
        .color-swatch.selected {
            box-shadow: 0 0 0 3px white, 0 0 0 5px #1f2937; /* Ring effect */
        }
        
        /* --- Glowy Icon --- */
        .icon-glow {
            box-shadow: 0 0 25px rgba(250, 204, 21, 0.5), 0 0 10px rgba(250, 204, 21, 0.4);
        }
        
        /* --- Hero Background & NEW: Featured Header Slideshow --- */
        #hero-section, #featured-header-image-container { position: relative; }
        .hero-slide, .featured-slide {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center;
            opacity: 0;
            transition: opacity 1.5s ease-in-out;
            z-index: 1;
        }
        .hero-slide.active, .featured-slide.active { opacity: 1; }
        .hero-overlay {
            position: relative; z-index: 2;
            background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6));
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
        }
        #featured-header-image-container {
            height: 250px; /* Example height, can be adjusted */
            border-radius: 0.5rem;
            overflow: hidden;
            background-color: #e5e7eb;
        }


        /* MODIFIED: Modal Styles for better scaling */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 100; display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: white; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            color: #333; transform: scale(0.95); transition: transform 0.3s;
            width: 90vw; /* Use viewport width */
            height: 90vh; /* Use viewport height */
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        /* Specific max-widths to prevent modals from becoming too large on ultrawide screens */
        .modal-content.max-w-sm { max-width: 448px; height: auto; }
        .modal-content.max-w-md { max-width: 512px; height: auto; }
        .modal-content.max-w-lg { max-width: 576px; height: auto; }
        .modal-content.max-w-2xl { max-width: 768px; }
        .modal-content.max-w-3xl { max-width: 896px; }
        .modal-content.max-w-4xl { max-width: 1024px; }
        .modal-content.max-w-5xl { max-width: 1152px; }
        .modal-content.max-w-7xl { max-width: 1408px; }


        /* --- Admin Panel Styles --- */
        /* NEW: Make admin panel a side panel */
        .modal-overlay.admin-view {
            justify-content: flex-end;
            background-color: rgba(0, 0, 0, 0.4);
        }
        .modal-content.admin-panel {
            width: 60%;
            max-width: 900px;
            height: 100%;
            border-radius: 0;
            transform: translateX(100%);
            transition: transform 0.4s ease-in-out;
        }
        .modal-overlay.visible .modal-content.admin-panel {
            transform: translateX(0);
        }
        /* NEW: Rich Text Editor Toolbar */
        .editor-toolbar {
            display: flex;
            gap: 0.5rem;
            border: 1px solid #d1d5db;
            border-bottom: none;
            padding: 0.5rem;
            border-radius: 0.375rem 0.375rem 0 0;
            background-color: #f9fafb;
        }
        .editor-toolbar button {
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            background-color: #e5e7eb;
        }
        .admin-textarea.has-toolbar {
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
        }

        .admin-section { margin-bottom: 2rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 1rem; }
        .admin-section h3 { font-weight: 700; margin-bottom: 1rem; font-size: 1.1rem; }
        .admin-label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; }
        .admin-input, .admin-select, .checkout-input, .admin-textarea {
            width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem;
            font-size: 1rem;
        }
        .admin-input[type="color"] { padding: 0; height: 2.5rem; }
        .admin-product-card, .admin-category-card, .admin-order-card, .admin-review-card, .admin-coupon-card, .admin-abandoned-cart-card, .admin-user-management-card, .admin-ticket-card {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .admin-tab, .order-filter-btn, .account-tab, .dashboard-filter-btn, .ticket-filter-btn {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #6b7280;
            transition: all 0.3s ease;
        }
        .admin-tab.active, .order-filter-btn.active, .account-tab.active, .dashboard-filter-btn.active, .ticket-filter-btn.active {
            border-color: #1f2937;
            font-weight: 600;
            color: #1f2937;
        }
        .admin-tab-content {
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .upload-btn {
            background-color: #e5e7eb;
            padding: 0.75rem;
            text-align: center;
            border-radius: 0.375rem;
            cursor: pointer;
        }
        
        /* --- Search Dropdown & Nav Dropdown --- */
        #search-results, #nav-dropdown, #account-dropdown, #auth-dropdown {
            position: absolute;
            top: 100%;
            background: white;
            border: 1px solid #d1d5db;
            z-index: 50;
        }
        #search-results { left: 0; right: 0; border-top: none; border-radius: 0 0 0.5rem 0.5rem; max-height: 300px; overflow-y: auto; }
        /* MODIFIED: Nav dropdown positioned to the right */
        #nav-dropdown, #account-dropdown, #auth-dropdown {
            right: 0;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            width: 250px;
        }
        #auth-dropdown { width: 150px; }
        
        /* --- Floating WhatsApp Button --- */
        #whatsapp-fab {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            z-index: 90;
        }
        
        /* --- MODIFIED: Enhanced Toast Notification --- */
        .toast {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            transform: translateX(150%);
            background-color: #fff;
            color: #1f2937;
            padding: 1.25rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15), 0 6px 10px rgba(0,0,0,0.1);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            z-index: 200;
            display: flex;
            align-items: center;
            gap: 1rem;
            max-width: 400px;
            border-left: 5px solid #22c55e;
            overflow: hidden;
        }
        .toast.error {
            border-left-color: #ef4444;
        }
        .toast.show {
            transform: translateX(0);
        }
        .toast-img {
            width: 60px;
            height: 60px;
            border-radius: 0.5rem;
            object-fit: cover;
        }
        .toast::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            width: 100%;
            background-color: #22c55e;
            animation: toast-progress 4s linear forwards;
        }
        .toast.error::after {
            background-color: #ef4444;
        }
        @keyframes toast-progress {
            from { width: 100%; }
            to { width: 0%; }
        }
        .toast .close-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 1.5rem;
            line-height: 1;
            cursor: pointer;
        }


        /* --- Star Rating Styles --- */
        .star-rating-input { display: flex; flex-direction: row-reverse; justify-content: flex-end; }
        .star-rating-input input { display: none; }
        .star-rating-input label {
            color: #d1d5db; /* gray-300 */
            font-size: 2rem;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        /* MODIFIED: Category button uses background-size for hover effect */
        .category-btn {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            color: white;
            border-radius: 0.5rem;
            background-size: 200% auto;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(234, 88, 12, 0.3);
        }
        .category-btn:hover {
            background-position: right center;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(234, 88, 12, 0.4);
        }
        
        /* NEW: Styles for category display with images */
        #category-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }
        .category-item-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        .category-display-image {
            width: 150px; /* MODIFIED: Increased size */
            height: 150px; /* MODIFIED: Increased size */
            border-radius: 0.75rem;
            object-fit: cover;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        .reviews-marquee-container {
            overflow: hidden;
            width: 100%;
            display: flex;
        }
        .reviews-marquee-track {
            display: flex;
            flex-shrink: 0;
            gap: 2rem; /* Same as the grid gap */
            animation-name: marquee-scroll-left;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
        }
        .reviews-marquee-track > * {
            flex-shrink: 0;
            width: 350px; /* Example fixed width */
        }
        @keyframes marquee-scroll-left {
            from { transform: translateX(0%); }
            to { transform: translateX(-100%); }
        }
        /* NEW: Added scroll right animation */
        @keyframes marquee-scroll-right {
            from { transform: translateX(-100%); }
            to { transform: translateX(0%); }
        }

        /* REVAMPED: Spin Wheel Styles with SVG */
        #spin-wheel-game-area, #spin-wheel-preview-area {
            position: relative;
            width: 350px;
            height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #6b2a0c;
            border-radius: 50%;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.4), 0 5px 15px rgba(0,0,0,0.3);
            overflow: hidden; /* Prevent spinning wheel from going outside the border */
        }
        #spin-wheel-svg, #spin-wheel-preview-svg {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.2));
        }
        #spin-wheel-svg-g, #spin-wheel-preview-svg-g {
             transform-origin: center;
             transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        #spin-wheel-pointer {
            position: absolute;
            top: 50%;
            right: -10px;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 20px solid transparent;
            border-bottom: 20px solid transparent;
            border-left: 30px solid #a44f1e;
            z-index: 10;
            filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.3));
        }
        #spin-wheel-center-overlay {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #fff;
            border: 8px solid #f0e6d5; /* light inner ring */
            box-shadow: 0 0 0 6px #6b2a0c, inset 0 0 10px rgba(0,0,0,0.2); /* dark outer ring */
            z-index: 5;
        }

        /* NEW: Crate Opening Styles */
        #crate-game-area {
            position: relative;
            width: 300px;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #crate-image-container {
            position: relative;
            width: 250px;
            height: 250px;
            cursor: pointer;
        }
        #crate-image-closed, #crate-image-open {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: opacity 0.3s ease;
        }
        #crate-image-closed.glowing {
            animation: crate-glow 1.5s infinite ease-in-out;
        }
        #crate-image-closed.shaking {
            animation: crate-shake 0.5s infinite;
        }
        #crate-image-closed.opening {
            opacity: 0;
        }
        #crate-image-open {
            opacity: 0;
        }
        #crate-image-open.visible {
            opacity: 1;
        }

        @keyframes crate-glow {
            0%, 100% { filter: drop-shadow(0 0 5px rgba(251, 191, 36, 0.5)); transform: scale(1); }
            50% { filter: drop-shadow(0 0 20px rgba(251, 191, 36, 1)); transform: scale(1.05); }
        }
        @keyframes crate-shake {
            0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); }
        }


        .product-clickable-area {
            cursor: pointer;
        }
        /* NEW: Cart side panel styling */
        .modal-overlay.cart-view {
            justify-content: flex-end;
            background-color: rgba(0, 0, 0, 0.4);
        }
        .modal-content.cart-panel {
            width: 100%;
            max-width: 450px;
            height: 100%;
            border-radius: 0;
            transform: translateX(100%);
            transition: transform 0.4s ease-in-out;
            background-color: #f9fafb; /* gray-50 */
        }
        .modal-overlay.visible .modal-content.cart-panel {
            transform: translateX(0);
        }
        /* MODIFIED: Product Detail Countdown Styling */
        #product-detail-sale-countdown .timer-box { background: transparent; padding: 0.25rem; }
        #product-detail-sale-countdown .timer-digits { font-size: 1.5rem; color: #dd6b20; text-shadow: 0 0 8px rgba(221, 107, 32, 0.7); }
        #product-detail-sale-countdown .timer-label { font-size: 0.7rem; color: #dd6b20; }
        #product-detail-sale-countdown .flash-sale-title { font-size: 1.25rem; font-weight: bold; color: #dd6b20; text-shadow: 0 0 8px rgba(221, 107, 32, 0.7); margin-bottom: 0.5rem; }

        /* NEW: Stock Status Styling */
        .stock-status-container { display: flex; align-items: center; gap: 0.5rem; font-weight: 600; }
        .stock-status-container svg { width: 1.25em; height: 1.25em; } /* Use em for scalable icons */
        @keyframes stock-shine { to { background-position: 200% center; } }
        .stock-status-text { animation: stock-shine 4s linear infinite; background-size: 200% auto; color: #fff; background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .shiny-green { background-image: linear-gradient(to right, #10b981, #a7f3d0, #10b981); }
        .shiny-orange { background-image: linear-gradient(to right, #f97316, #fdba74, #f97316); }
        .shiny-red { background-image: linear-gradient(to right, #ef4444, #fca5a5, #ef4444); }

        /* NEW: Product Detail Media Thumbnail Styling */
        .media-thumbnail {
            position: relative;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 0.375rem;
            transition: border-color 0.2s;
        }
        .media-thumbnail.active { border-color: #1f2937; }
        .media-thumbnail .play-icon {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 2rem; height: 2rem;
            background-color: rgba(0,0,0,0.5);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }
        
        /* NEW: Messaging UI Styles */
        .chat-container {
            display: flex;
            height: 70vh; /* Example height */
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
        }
        .user-list-panel {
            width: 35%;
            border-right: 1px solid #e5e7eb;
            overflow-y: auto;
        }
        .user-list-item {
            padding: 1rem;
            cursor: pointer;
            border-bottom: 1px solid #e5e7eb;
        }
        .user-list-item:hover, .user-list-item.active {
            background-color: #f3f4f6;
        }
        .chat-window {
            width: 65%;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            font-weight: bold;
        }
        .messages-area {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .message-bubble {
            padding: 0.5rem 1rem;
            border-radius: 1.25rem;
            max-width: 75%;
        }
        .message-sent {
            background-color: #3b82f6;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
        }
        .message-received {
            background-color: #e5e7eb;
            color: #1f2937;
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
        }
        /* NEW: Message Ticks Styling */
        .message-ticks { font-size: 1.1em; color: #a3a3a3; font-weight: bold; }
        .message-ticks.seen { color: #4fc3f7; }
        .message-bubble .msg-meta {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 0.25rem;
            font-size: 0.65rem;
            margin-top: 0.25rem;
            color: #d1d5db; /* For sent messages */
        }
        .message-received .msg-meta {
             color: #6b7280; /* For received messages */
        }

        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        #spin-timer-container .timer-box { background-color: #f3f4f6; border: 1px solid #d1d5db; }
        #spin-timer-container .timer-digits { color: #1f2937; font-size: 1.5rem; }
        #spin-timer-container .timer-label { color: #6b7280; font-size: 0.7rem; }

        /* NEW: Spin wheel logo animations */
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .animate-breathe { animation: breathe 3s ease-in-out infinite; }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.4); } 70% { transform: scale(1.03); box-shadow: 0 0 0 10px rgba(249, 115, 22, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); } }
        .animate-pulse { animation: pulse 2s infinite; border-radius: 0.5rem; /* Match logo radius */}

        /* NEW: Notification Badge */
        .notification-badge-container { position: relative; }
        .notification-badge {
            position: absolute;
            top: -5px; right: -8px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }
        .message-bubble img {
            max-width: 100%;
            border-radius: 1rem;
            margin-top: 0.25rem;
        }
        
        /* MODIFIED: Category modal grid styling for vertical scroll */
        #category-modal .modal-content {
            height: 90vh;
        }
        #category-modal-grid-container {
            height: 100%;
            overflow-y: auto;
            padding: 1rem;
        }
        #category-modal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 2rem;
            align-content: start;
        }
        
        /* MODIFIED: Category modal search styling */
        .category-search-container {
            position: relative;
            transition: width 0.3s ease-in-out;
            width: 32px; /* Icon size */
        }
        .category-search-container.active {
            width: 100%;
            max-width: 250px;
        }
        #category-search-icon {
            position: absolute;
            top: 50%;
            left: 8px;
            transform: translateY(-50%);
            cursor: pointer;
            z-index: 2;
        }
        #category-search-input {
            width: 100%;
            border-radius: 9999px;
            border: 1px solid transparent;
            padding-left: 2rem;
            transition: all 0.3s ease-in-out;
            opacity: 0;
        }
        .category-search-container.active #category-search-input {
            border-color: #d1d5db;
            opacity: 1;
        }
        /* NEW: User ID selectable text */
        .selectable-uid {
            -webkit-user-select: text; /* Safari */
            -moz-user-select: text; /* Firefox */
            -ms-user-select: text; /* IE10+/Edge */
            user-select: text; /* Standard */
            cursor: copy;
            font-family: 'Roboto Mono', monospace;
            background-color: #e5e7eb;
            padding: 2px 4px;
            border-radius: 4px;
        }
        
        /* NEW: Checkout payment method styling */
        .payment-method-option {
            display: block;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .payment-method-option:hover {
            border-color: #6b7280;
        }
        .payment-method-input:checked + .payment-method-option {
            border-color: #1f2937;
            box-shadow: 0 0 0 2px #1f2937;
        }
        .payment-method-input {
            display: none;
        }

        /* NEW: WhatsApp Preview Styles */
        .whatsapp-preview-container {
            background-color: #e5ddd5;
            background-image: url('https://i.imgur.com/6f2Z5d4.png'); /* Subtle pattern */
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            border: 1px solid #ccc;
        }
        .whatsapp-preview-bubble {
            background-color: #dcf8c6;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            max-width: 85%;
            margin-left: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .whatsapp-preview-bubble.received {
            background-color: #ffffff;
            margin-left: 0;
            margin-right: auto;
        }
        .whatsapp-preview-bubble strong { font-weight: 700; }
        .whatsapp-preview-bubble pre { font-family: 'Roboto Mono', monospace; background-color: #f0f0f0; padding: 0.5rem; border-radius: 0.25rem; overflow-x: auto;}

        /* MODIFIED: SEO Preview Styles */
        .seo-preview-container {
            font-family: Arial, sans-serif;
            border: 1px solid #e5e7eb;
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: #f9fafb;
        }
        .seo-preview-title {
            font-size: 20px;
            color: #1a0dab;
            text-decoration: none;
            font-weight: 400;
        }
        .seo-preview-title:hover { text-decoration: underline; }
        .seo-preview-url {
            font-size: 14px;
            color: #006621;
        }
        .seo-preview-description {
            font-size: 14px;
            color: #4d5156;
            line-height: 1.57;
            margin-top: 4px;
        }
        .char-counter {
            font-size: 0.75rem;
            font-family: 'Roboto Mono', monospace;
        }
        .char-counter.ok { color: #16a34a; }
        .char-counter.warn { color: #f97316; }
        .char-counter.over { color: #dc2626; font-weight: bold; }

        /* NEW: Spin Prize Edit Preview Styles */
        #spin-prize-edit-preview-container {
            position: relative;
            width: 150px;
            height: 150px;
            background-color: #e5e7eb;
            border: 2px dashed #9ca3af;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        #spin-prize-edit-preview-text {
            position: absolute;
            top: 50%;
            left: 50%;
            font-weight: bold;
            text-align: center;
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        /* --- NEW: Premium Button & Cart Styles --- */
        .premium-btn {
            background: linear-gradient(to right, #374151, #111827);
            color: white;
            padding: 0.875rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease-in-out;
            border: none;
            cursor: pointer;
        }
        .premium-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        .premium-btn:disabled {
            background: #9ca3af;
            box-shadow: none;
            cursor: not-allowed;
        }
        .secondary-btn {
            background-color: #e5e7eb;
            color: #1f2937;
            transition: background-color 0.2s ease;
        }
        .secondary-btn:hover {
            background-color: #d1d5db;
        }
        #cart-items-container .cart-item {
            background-color: #fff;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 1rem;
            transition: transform 0.2s ease;
        }
        #cart-items-container .cart-item:hover {
            transform: scale(1.02);
        }
        .cart-quantity-changer {
            background-color: #f3f4f6;
            font-weight: bold;
            color: #4b5563;
            border-radius: 9999px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        .cart-quantity-changer:hover {
            background-color: #e5e7eb;
        }
        /* NEW: Password visibility toggle styles */
        .password-container {
            position: relative;
        }
        .password-toggle-icon {
            position: absolute;
            top: 50%;
            right: 1rem;
            transform: translateY(-50%);
            cursor: pointer;
            color: #6b7280;
        }
        
        /* --- MODIFIED: Floating Button Behavior --- */
        #floating-reviews-btn, #floating-support-btn {
            position: fixed;
            top: 50%;
            z-index: 90;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem 0.5rem 0 0;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            box-shadow: -2px -2px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        #floating-reviews-btn {
            right: 0;
            transform: translateY(-50%) rotate(-90deg);
            transform-origin: bottom right;
        }
        #floating-support-btn {
            left: 0;
            transform: translateY(-50%) rotate(90deg);
            transform-origin: bottom left;
            box-shadow: 2px -2px 15px rgba(0,0,0,0.2);
        }
        
        /* Hide text span by default */
        #floating-reviews-btn .btn-text, #floating-support-btn .btn-text {
            max-width: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-width 0.4s ease, opacity 0.3s ease;
            white-space: nowrap;
        }
        
        /* Expand on hover or when .is-open class is present */
        #floating-reviews-btn:hover, #floating-support-btn:hover,
        #floating-reviews-btn.is-open, #floating-support-btn.is-open {
            padding: 0.75rem 1.25rem;
        }
        
        #floating-reviews-btn:hover .btn-text, #floating-support-btn:hover .btn-text,
        #floating-reviews-btn.is-open .btn-text, #floating-support-btn.is-open .btn-text {
            max-width: 100px; /* Large enough value to show text */
            opacity: 1;
        }
        
        #floating-reviews-btn .star-icon {
            display: inline-block;
            transform: rotate(90deg);
            animation: star-glow 2s infinite ease-in-out;
        }
        #floating-support-btn .support-icon-container {
            display: inline-block;
            transform: rotate(-90deg);
        }

        /* --- NEW: Animated Glowing Star --- */
        @keyframes star-glow {
            0%, 100% {
                filter: drop-shadow(0 0 1px rgba(255, 255, 100, 0.7));
                transform: scale(1) rotate(90deg);
            }
            50% {
                filter: drop-shadow(0 0 6px rgba(255, 220, 50, 1));
                transform: scale(1.1) rotate(90deg);
            }
        }
        @keyframes star-glow-inline {
            0%, 100% { filter: drop-shadow(0 0 1px var(--star-color)); }
            50% { filter: drop-shadow(0 0 5px var(--star-color)); }
        }
        .review-star-animated:nth-child(2) { animation-delay: 0.2s; }
        .review-star-animated:nth-child(3) { animation-delay: 0.4s; }
        .review-star-animated:nth-child(4) { animation-delay: 0.6s; }
        .review-star-animated:nth-child(5) { animation-delay: 0.8s; }

        /* --- NEW: All Reviews Modal & Review Card --- */
        #all-reviews-modal .modal-content {
            height: 90vh;
        }
        #all-reviews-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            padding: 1.5rem;
            overflow-y: auto;
            max-height: 100%;
        }
        .review-card {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            text-align: left;
        }
        .review-card-stars {
            display: flex;
            gap: 0.125rem;
            margin-bottom: 0.75rem;
        }
        
        /* NEW: Animation for review cards in modal */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #all-reviews-modal .review-card {
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0; /* Initially hidden for animation */
        }


        /* --- NEW: Premium Admin Login Modal --- */
        #password-modal .modal-content {
            background: linear-gradient(145deg, #2d3748, #1a202c);
            color: #e2e8f0;
            border: 1px solid #4a5568;
            border-radius: 0.75rem;
        }
        #password-modal .admin-input {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid #4a5568;
            color: white;
            padding: 0.875rem 1rem;
            transition: all 0.2s ease-in-out;
        }
        #password-modal .admin-input:focus {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: #63b3ed;
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.3);
        }

        /* --- NEW: Premium Checkout Form --- */
        #checkout-form h3 {
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.75rem;
        }
        #checkout-form .checkout-input {
            border-radius: 0.5rem;
            padding: 0.875rem 1rem;
            transition: all 0.2s ease-in-out;
            border: 1px solid #d1d5db;
        }
        #checkout-form .checkout-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        /* MODIFIED: Sale Popup image sizing */
        #sale-popup-modal .modal-content {
            height: auto;
        }
        #sale-popup-image {
            width: 100%;
            max-height: 60vh; /* Allow image to be tall */
            object-fit: contain; /* Ensure it doesn't crop */
        }

        /* NEW: Premium Support Ticket Modal */
        #support-ticket-modal .modal-content {
            background: linear-gradient(145deg, #f9fafb, #e5e7eb);
        }
        #support-ticket-modal h2 {
            font-family: 'Playfair Display', serif;
        }
        #support-ticket-modal .admin-select,
        #support-ticket-modal .admin-textarea {
            border-radius: 0.5rem;
            padding: 0.875rem 1rem;
            transition: all 0.2s ease-in-out;
            border: 1px solid #d1d5db;
        }
        #support-ticket-modal .admin-select:focus,
        #support-ticket-modal .admin-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

    </style>
    
    <!-- NEW & CORRECTED: Mobile Responsive Styles -->
    <style>
        @media (max-width: 767px) {
            /* --- General Layout & Font Adjustments --- */
            .py-24 {
                padding-top: 4rem;
                padding-bottom: 4rem;
            }
            .p-8 {
                padding: 1.5rem;
            }
            .text-3xl {
                font-size: 1.875rem;
                line-height: 2.25rem;
            }
            .text-2xl {
                font-size: 1.5rem;
                line-height: 2rem;
            }
    
            /* --- Header --- */
            header nav {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            #store-name {
                font-size: 1.5rem;
            }
    
            /* --- Hero Section --- */
            #hero-section {
                height: 50vh;
            }
            #hero-title {
                font-size: 2.5rem !important;
            }
            #hero-subtitle {
                font-size: 1.1rem !important;
                margin-bottom: 1.5rem;
            }
            #hero-typewriter-wrapper {
                font-size: 1rem;
                height: 2rem;
            }
    
            /* --- Modals --- */
            .modal-content {
                width: 95vw;
                height: 90vh;
            }
            .modal-content.max-w-sm, .modal-content.max-w-md, .modal-content.max-w-lg {
                height: auto; /* Let smaller modals define their own height */
            }
            /* Side panels should be narrower on mobile */
            .modal-content.cart-panel {
                width: 85%;
                max-width: 380px;
            }
            .modal-content.admin-panel {
                width: 100%;
                max-width: 100%;
                height: 100vh;
                border-radius: 0;
            }
    
            /* Spin Wheel & Crate Modal */
            #spin-wheel-modal .modal-content {
                flex-direction: column;
                padding: 1rem;
                overflow-y: auto;
            }
            #spin-wheel-game-area,
            #spin-wheel-preview-area,
            #crate-game-area {
                width: 280px;
                height: 280px;
                flex-shrink: 0;
                margin-bottom: 1.5rem;
            }
            #spin-wheel-svg, #spin-wheel-preview-svg {
                width: 100%;
                height: 100%;
            }
            #spin-wheel-pointer {
                right: -8px;
                border-left-width: 25px;
                border-top-width: 18px;
                border-bottom-width: 18px;
            }
            #spin-wheel-modal .modal-content > .w-full.md\:w-1\/2 {
                width: 100%;
            }
            #luck-game-title {
                font-size: 1.75rem;
            }
            
            /* Product Detail Modal */
            #product-detail-modal .modal-content {
                flex-direction: column;
                height: 95vh;
            }
            #product-detail-modal .modal-content > div {
                width: 100% !important;
            }
            #product-detail-modal .modal-content > .md\:w-7\/12 { /* Details section */
                padding: 1rem 1.5rem;
            }
             #product-detail-modal .modal-content > .md\:w-5\/12 { /* Media section */
                padding: 1rem;
            }
            #product-detail-name {
                font-size: 1.75rem;
            }
            #product-detail-price span:first-child {
                font-size: 1.5rem;
            }
            #product-detail-purchase-box .flex.items-center.gap-4 {
                flex-direction: column;
                align-items: stretch;
            }
            #product-detail-quantity-selector {
                justify-content: space-between;
                padding: 0.25rem;
            }
            
            /* Checkout & Admin Modals */
            #checkout-form .grid-cols-1.md\:grid-cols-2,
            .admin-panel .grid-cols-1.md\:grid-cols-3,
            .admin-panel .grid-cols-1.md\:grid-cols-2,
            .admin-panel .grid-cols-2.md\:grid-cols-4 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }

            /* Admin Panel Specifics */
            .admin-tab {
                white-space: nowrap; /* Keep tabs from wrapping text */
            }
            .admin-panel .flex-col.md\:flex-row {
                flex-direction: column;
            }

            /* --- Sections --- */
            #featured .flex-col.md\:flex-row {
                flex-direction: column;
            }
    
            /* --- Footer --- */
            footer .grid {
                text-align: center;
            }
            footer .md\:text-left, footer .md\:text-right {
                text-align: center !important;
            }
            footer .flex.justify-center.md\:justify-start,
            footer .flex.justify-center.md\:justify-end {
                justify-content: center;
            }
    
            /* --- Chat UI --- */
            .chat-container {
                flex-direction: column;
                height: 75vh;
            }
            .user-list-panel,
            .chat-window {
                width: 100%;
            }
            .user-list-panel {
                height: 30%;
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Store Header -->
    <header class="bg-white shadow-md sticky top-0 z-40">
        <!-- Announcement Bar -->
        <div id="announcement-bar" class="bg-gray-900 text-white text-sm overflow-hidden whitespace-nowrap">
            <div class="announcement-bar-content inline-block">
                <span id="announcement-text-1" class="py-2 px-6 inline-block"></span>
                <span id="countdown-container" class="py-2 px-6 inline-block font-bold"></span>
                <span id="announcement-text-1-dup" class="py-2 px-6 inline-block"></span>
                <span id="countdown-container-dup" class="py-2 px-6 inline-block font-bold"></span>
            </div>
        </div>
        <!-- MODIFIED: Header nav for mobile friendliness -->
        <nav class="container mx-auto px-4 sm:px-6 py-4 flex flex-wrap justify-between items-center">
            <div id="store-identity" class="flex items-center">
                <img id="store-logo" src="https://placehold.co/40x40/000000/FFFFFF?text=V" alt="Store Logo" class="h-10 w-10 rounded-full mr-3">
                <h1 id="store-name" class="text-2xl font-bold font-scifi">NewBees</h1>
            </div>

            <!-- MODIFIED: Search bar takes less space on mobile and is centered -->
            <div class="w-full md:flex-1 md:w-auto order-3 md:order-2 mt-4 md:mt-0 px-0 md:px-8">
                 <div class="relative w-full max-w-md mx-auto">
                     <input type="search" id="search-bar" placeholder="Search for products..." class="w-full py-2 pl-10 pr-4 border rounded-full focus:outline-none focus:ring-2 focus:ring-gray-300">
                     <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                     <div id="search-results" class="hidden"></div>
                 </div>
             </div>

            <div class="flex items-center space-x-2 sm:space-x-4 order-2 md:order-3">
                <div id="spin-wheel-nav-btn-container"></div>
                
                <div id="auth-container" class="relative">
                    <!-- This will be replaced by user status -->
                </div>
                
                <div id="admin-actions-container" class="flex items-center">
                    <!-- Admin icon button will be injected here -->
                </div>

                <button id="cart-button" class="relative p-1">
                    <span id="cart-icon-container">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                    </span>
                    <span id="cart-counter" class="absolute -top-1 -right-1 sm:-top-2 sm:-right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </button>

                <div class="relative">
                     <button id="nav-toggle-btn" class="text-gray-600 hover:text-black p-1">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                     </button>
                     <div id="nav-dropdown" class="hidden p-4 space-y-3">
                         <h4 class="font-bold text-sm text-gray-500 uppercase">Links</h4>
                         <a id="nav-dropdown-store-locator" href="https://www.google.com/maps/place/Royal+Infants/@24.860793,67.017859,17z/data=!3m1!4b1!4m6!3m5!1s0x3eb33fdb5e1e8977:0x9f9c2b7a571d4a74!8m2!3d24.860793!4d67.017859!16s%2Fg%2F11mwsgb06q?entry=ttu&g_ep=EgoyMDI1MTAwNy4wIKXMDSoASAFQAw%3D%3D" target="_blank" rel="noopener noreferrer" class="block text-gray-700 hover:text-black">Store Locator</a>
                         <a href="#reviews" class="block text-gray-700 hover:text-black">Reviews</a>
                         <button type="button" id="shipping-policy-link-dropdown" class="block text-left w-full text-gray-700 hover:text-black">Shipping Policy</button>
                         <button type="button" id="faq-link-dropdown" class="block text-left w-full text-gray-700 hover:text-black">FAQ</button>
                         <button type="button" id="about-us-link-dropdown" class="block text-left w-full text-gray-700 hover:text-black">About Us</button>
                         <button type="button" id="payment-methods-link-dropdown" class="block text-left w-full text-gray-700 hover:text-black">Payment Methods</button>
                         <div class="border-t my-2"></div>
                         <h4 class="font-bold text-sm text-gray-500 uppercase">Collections</h4>
                         <div id="nav-dropdown-collections" class="space-y-2">
                            <!-- Collections will be injected here -->
                         </div>
                     </div>
                </div>
            </div>
        </nav>
        <!-- NEW: Account Dropdown (initially hidden) -->
        <div id="account-dropdown" class="hidden p-4 space-y-3" style="right: 100px;"> <!-- Adjust 'right' as needed -->
            <button type="button" id="account-dropdown-orders-link" class="block text-left w-full text-gray-700 hover:text-black">My Account</button>
            <div class="border-t"></div>
            <button type="button" id="account-dropdown-logout-link" class="block text-left w-full text-gray-700 hover:text-black">Logout</button>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <section id="hero-section" class="text-white h-[60vh] md:h-[80vh] flex items-center justify-center text-center overflow-hidden">
             <div id="hero-slideshow-container">
                 <!-- Slides will be injected here by JS -->
             </div>
             <div class="hero-overlay">
                 <div class="max-w-4xl px-4">
                    <h2 id="hero-title" class="font-pricedown mb-4 fade-in shiny-text" style="font-size: 4.5rem; line-height: 1.1;">SHOP FOR YOUR NEWBORN.</h2>
                    <p id="hero-subtitle" class="mb-8 blur-in" style="animation-delay: 0.5s; font-size: 1.5rem;">Affordable  Reliable  Exceptional</p>
                    <div id="hero-typewriter-wrapper" class="h-8 text-xl md:text-2xl font-mono text-orange-400 blur-in" style="animation-delay: 1s;"></div>
                </div>
             </div>
        </section>
        
        <!-- NEW: Secondary Announcement Bar -->
        <section id="secondary-announcement-bar" class="hidden text-sm overflow-hidden whitespace-nowrap">
            <div class="announcement-bar-content inline-block">
                <span id="secondary-announcement-text" class="py-2 px-6 inline-block"></span>
                <span id="secondary-announcement-text-dup" class="py-2 px-6 inline-block"></span>
            </div>
        </section>

        <!-- MODIFIED: Categories Section Structure -->
        <section id="categories" class="py-24 bg-white">
            <div class="container mx-auto px-6 text-center">
                <h2 class="text-3xl font-bold mb-2">Explore Our Collections</h2>
                <p class="text-gray-600 mb-10">Find exactly what you're looking for.</p>
                <!-- MODIFIED: Container for categories now supports images above buttons -->
                <div id="category-buttons" class="flex flex-wrap justify-center gap-4 mb-12">
                    <!-- Category buttons will be dynamically injected here -->
                </div>
            </div>
        </section>
        
        <section id="featured" class="py-24 bg-gray-100">
            <div class="container mx-auto px-6">
                 <div class="flex flex-col md:flex-row justify-between items-center mb-12 text-center md:text-left">
                     <div>
                         <h2 class="text-3xl font-bold mb-2">Featured Products</h2>
                         <p class="text-gray-600">Handpicked just for you.</p>
                     </div>
                     <div class="mt-4 md:mt-0">
                         <label for="sort-products" class="text-gray-600 mr-2">Sort by:</label>
                         <select id="sort-products" class="border rounded-md p-2">
                             <option value="default">Featured</option>
                             <option value="price-asc">Price: Low to High</option>
                             <option value="price-desc">Price: High to Low</option>
                             <option value="sales-desc">Best Selling</option>
                             <option value="review-desc">Top Rated</option>
                         </select>
                     </div>
                 </div>
                <!-- MODIFIED: Container for featured header image slideshow -->
                <div id="featured-header-image-container" class="mb-8 hidden">
                    <div id="featured-slideshow-container" class="absolute inset-0">
                        <!-- Slides will be injected here -->
                    </div>
                </div>
                <!-- Row 1 of Featured Products -->
                <div id="featured-row-1-container" class="mb-12">
                    <h3 id="featured-row-1-title" class="text-2xl font-bold mb-6 text-center md:text-left">Top Picks</h3>
                    <div class="relative">
                        <button id="featured-scroll-left-btn-1" class="absolute top-1/2 -left-4 -translate-y-1/2 bg-white/80 rounded-full p-2 shadow-md z-10 hover:bg-white transition hidden md:block">&lt;</button>
                        <div id="featured-product-slider-1" class="flex gap-10 overflow-x-auto pb-4 product-slider-container">
                            <div id="product-grid-1" class="flex flex-nowrap gap-10">
                                <!-- Featured products (Row 1) will be injected here -->
                            </div>
                        </div>
                        <button id="featured-scroll-right-btn-1" class="absolute top-1/2 -right-4 -translate-y-1/2 bg-white/80 rounded-full p-2 shadow-md z-10 hover:bg-white transition hidden md:block">&gt;</button>
                    </div>
                </div>
                 <!-- Row 2 of Featured Products -->
                <div id="featured-row-2-container" class="mb-12">
                    <h3 id="featured-row-2-title" class="text-2xl font-bold mb-6 text-center md:text-left">New Arrivals</h3>
                    <div class="relative">
                        <button id="featured-scroll-left-btn-2" class="absolute top-1/2 -left-4 -translate-y-1/2 bg-white/80 rounded-full p-2 shadow-md z-10 hover:bg-white transition hidden md:block">&lt;</button>
                        <div id="featured-product-slider-2" class="flex gap-10 overflow-x-auto pb-4 product-slider-container">
                            <div id="product-grid-2" class="flex flex-nowrap gap-10">
                                <!-- Featured products (Row 2) will be injected here -->
                            </div>
                        </div>
                        <button id="featured-scroll-right-btn-2" class="absolute top-1/2 -right-4 -translate-y-1/2 bg-white/80 rounded-full p-2 shadow-md z-10 hover:bg-white transition hidden md:block">&gt;</button>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="why-us" class="py-24 bg-white">
            <div class="container mx-auto px-6 text-center">
                <h2 id="why-us-title" class="text-3xl font-bold mb-4 text-gray-800">Why Shop With Us?</h2>
                <p id="why-us-subtitle" class="text-gray-600 mb-12 max-w-2xl mx-auto">Your peace of mind is our highest priority.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-12">
                    <div id="why-us-item-1" class="text-center">
                        <div class="flex justify-center mb-4">
                           <div class="bg-yellow-400 text-gray-900 rounded-full p-4 icon-glow"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                        </div>
                        <h3 class="text-xl font-bold mb-2 text-gray-800">Quality & Comfort</h3>
                        <p class="text-gray-600">Every item is crafted from the softest, safest materials, ensuring your baby's delicate skin is protected and comfortable.</p>
                    </div>
                     <div id="why-us-item-2" class="text-center">
                        <div class="flex justify-center mb-4">
                           <div class="bg-yellow-400 text-gray-900 rounded-full p-4 icon-glow"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg></div>
                        </div>
                        <h3 class="text-xl font-bold mb-2 text-gray-800">Adorable Designs</h3>
                        <p class="text-gray-600">From cute patterns to modern styles, our collection is curated to make your little one look even more adorable.</p>
                    </div>
                     <div id="why-us-item-3" class="text-center">
                        <div class="flex justify-center mb-4">
                            <div class="bg-yellow-400 text-gray-900 rounded-full p-4 icon-glow"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197M4 7a4 4 0 114 4"></path></svg></div>
                        </div>
                        <h3 class="text-xl font-bold mb-2 text-gray-800">Perfect Gifts</h3>
                        <p class="text-gray-600">Find the perfect, thoughtful gift for baby showers, birthdays, or just because. Beautifully packaged and a delight to receive.</p>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="reviews" class="py-24 bg-white">
            <div class="container mx-auto px-6 text-center">
                 <h2 class="text-3xl font-bold mb-2">What Our Customers Say</h2>
                 <p class="text-gray-600 mb-12">We're proud to have happy parents.</p>
                 <div id="reviews-marquee" class="reviews-marquee-container">
                    <div id="reviews-grid" class="reviews-marquee-track">
                        <!-- Reviews will be injected here -->
                    </div>
                 </div>
            </div>
        </section>

        <!-- NEW: Write a review section -->
        <section id="new-reviews-section" class="py-16 bg-gray-100">
            <div class="container mx-auto px-6 text-center">
                 <h2 class="text-3xl font-bold mb-2">Loved Your Purchase?</h2>
                 <p class="text-gray-600 mb-8">Let us know what you think and help other parents choose!</p>
                 <button id="write-review-btn" class="category-btn">Write a Review</button>
            </div>
        </section>

    </main>
    
     <a id="whatsapp-fab" href="https://wa.me/923012725158" target="_blank" class="bg-green-500 text-white rounded-full p-4 shadow-lg hover:bg-green-600 transition flex items-center gap-2 group">
        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 4.315 1.731 6.086l.287.468-1.171 4.284 4.372-1.142.456.287z"/></svg>
        <span class="font-semibold hidden group-hover:block">Contact Us</span>
    </a>
    
    <!-- MODIFIED: Floating Reviews Button -->
    <button id="floating-reviews-btn">
        <svg class="w-5 h-5 star-icon" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.957a1 1 0 00.95.69h4.162c.969 0 1.371 1.24.588 1.81l-3.368 2.448a1 1 0 00-.364 1.118l1.287 3.957c.3.921-.755 1.688-1.539 1.118l-3.368-2.448a1 1 0 00-1.175 0l-3.368 2.448c-.784.57-1.838-.197-1.539-1.118l1.287-3.957a1 1 0 00-.364-1.118L2.07 9.384c-.783-.57-.38-1.81.588-1.81h4.162a1 1 0 00.95-.69L9.049 2.927z"></path></svg>
        <span class="btn-text">Reviews</span>
    </button>
    <!-- MODIFIED: Floating Support Button -->
    <button id="floating-support-btn" class="hidden">
        <span id="support-icon-container" class="support-icon-container">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
        </span>
        <span class="btn-text">Support</span>
    </button>


    <footer class="bg-gray-900 text-white">
        <div class="container mx-auto px-6 py-12">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
                <div class="text-center md:text-left">
                    <h3 class="text-lg font-semibold mb-4">Reach Us Out</h3>
                    <div id="footer-contact-info" class="text-gray-400 space-y-3">
                        <!-- Contact info with icons will be injected here -->
                    </div>
                </div>
                <div class="text-center">
                     <h3 class="text-lg font-semibold mb-4">Follow Our Socials</h3>
                    <div id="social-links-container" class="flex justify-center space-x-6">
                        <!-- Social links with icons will be injected here -->
                    </div>
                </div>
                 <div class="text-center md:text-right">
                    <h3 class="text-lg font-semibold mb-4">Quick Links</h3>
                     <a href="#" class="block text-gray-400 hover:text-white">Home</a>
                     <a href="#categories" class="block text-gray-400 hover:text-white">Categories</a>
                     <a href="#featured" class="block text-gray-400 hover:text-white">Products</a>
                     <button type="button" id="shipping-policy-link" class="block text-left w-full text-gray-400 hover:text-white text-center md:text-right">Shipping Policy</button>
                     <button type="button" id="faq-link" class="block text-left w-full text-gray-400 hover:text-white text-center md:text-right">FAQ</button>
                     <button type="button" id="about-us-link" class="block text-left w-full text-gray-400 hover:text-white text-center md:text-right">About Us</button>
                     <!-- NEW: Store Locator in Footer -->
                     <a id="footer-store-locator-link" href="https://www.google.com/maps/place/Royal+Infants/@24.860793,67.017859,17z/data=!3m1!4b1!4m6!3m5!1s0x3eb33fdb5e1e8977:0x9f9c2b7a571d4a74!8m2!3d24.860793!4d67.017859!16s%2Fg%2F11mwsgb06q?entry=ttu&g_ep=EgoyMDI1MTAwNy4wIKXMDSoASAFQAw%3D%3D" target="_blank" rel="noopener noreferrer" class="block text-gray-400 hover:text-white">Store Locator</a>
                </div>
            </div>
            <div class="mt-8 border-t border-gray-800 pt-8 text-center text-gray-500">
                <p>&copy; 2025 NewBees. All Rights Reserved.</p>
            </div>
        </div>
    </footer>


    <!-- All Modals go here... -->
    
    <!-- MODIFIED: Category modal structure and styling -->
    <div id="category-modal" class="modal-overlay">
        <div class="modal-content max-w-7xl flex flex-col">
            <!-- MODIFIED: Category modal header with 3-column layout -->
            <div class="p-6 border-b grid grid-cols-3 items-center flex-shrink-0">
                <div class="flex items-center gap-4 justify-start">
                    <img id="category-modal-logo" src="" alt="Category Logo" class="h-12 w-auto hidden">
                    <h2 id="category-modal-title" class="text-2xl font-bold">Category Products</h2>
                </div>
                <div class="flex justify-center">
                    <div id="category-search-container" class="category-search-container">
                         <svg id="category-search-icon" class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                         <input type="search" id="category-search-input" class="admin-input" placeholder="Search in category...">
                    </div>
                </div>
                <div class="flex justify-end">
                    <button id="category-modal-close-btn" class="text-gray-500 hover:text-black text-3xl">&times;</button>
                </div>
            </div>
            <div id="category-modal-banner" class="w-full h-48 bg-center bg-no-repeat bg-cover flex-shrink-0"></div>
            <!-- MODIFIED: Grid container now scrolls vertically -->
            <div class="flex-grow relative overflow-hidden">
                <div id="category-modal-grid-container">
                    <div id="category-modal-grid">
                        <!-- Products for the category will be injected here -->
                    </div>
                </div>
            </div>
            <div id="category-modal-pagination" class="p-4 border-t flex justify-center items-center gap-4 flex-shrink-0">
                <!-- Pagination controls will be injected here -->
            </div>
        </div>
    </div>
    
    <div id="account-modal" class="modal-overlay">
        <div class="modal-content max-w-4xl flex flex-col">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold">My Account</h2>
                <button id="account-close-btn" class="text-gray-500 hover:text-black text-3xl">&times;</button>
            </div>
            <div class="p-6 flex-grow overflow-y-auto">
                <p id="user-id-display" class="text-sm text-gray-500 mb-4 bg-gray-100 p-2 rounded"></p>
                <div class="border-b border-gray-200 mb-6">
                    <nav class="flex space-x-4" aria-label="Tabs">
                        <button class="account-tab active" data-tab="orders">Order History</button>
                        <button class="account-tab notification-badge-container" data-tab="messages">
                            Messages
                            <!-- Notification badge will be injected here -->
                        </button>
                        <button class="account-tab notification-badge-container" data-tab="tickets">
                            My Tickets
                            <!-- Notification badge will be injected here -->
                        </button>
                        <!-- NEW: Security Tab -->
                        <button class="account-tab" data-tab="security">Security</button>
                    </nav>
                </div>
                <div id="account-tab-orders" class="account-tab-content">
                    <div id="order-history-container" class="space-y-4">
                        <!-- User's orders will be rendered here -->
                    </div>
                </div>
                <div id="account-tab-messages" class="account-tab-content hidden">
                    <div class="flex flex-col h-[60vh]">
                        <div id="user-messages-area" class="messages-area flex-grow bg-gray-50 rounded-t-lg">
                            <p class="text-center text-gray-500">Loading messages...</p>
                        </div>
                        <div class="chat-input-area bg-white rounded-b-lg">
                            <form id="user-message-form" class="flex gap-2 items-center">
                                <input type="file" id="user-message-image-upload" class="hidden" accept="image/*">                          
                                <button type="button" id="user-upload-image-btn" class="p-2 rounded-full hover:bg-gray-200">
                                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                </button>
                                <input type="text" id="user-message-input" class="admin-input" placeholder="Talk To Customer Support" required>
                                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Send</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div id="account-tab-tickets" class="account-tab-content hidden">
                    <div id="user-tickets-container" class="space-y-4">
                        <!-- User's tickets will be rendered here -->
                    </div>
                </div>
                <!-- NEW: Security Tab Content -->
                <div id="account-tab-security" class="account-tab-content hidden">
                    <h3 class="text-xl font-semibold mb-4">Change Password</h3>
                    <form id="user-password-change-form" class="space-y-4 max-w-md">
                        <div>
                            <label for="user-new-password" class="admin-label">New Password</label>
                            <input type="password" id="user-new-password" class="admin-input" required minlength="6">
                        </div>
                        <div>
                            <label for="user-confirm-password" class="admin-label">Confirm New Password</label>
                            <input type="password" id="user-confirm-password" class="admin-input" required minlength="6">
                        </div>
                        <button type="submit" class="premium-btn !rounded-md">Update Password</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div id="login-modal" class="modal-overlay">
        <div class="modal-content p-8 max-w-sm">
           <h2 class="text-2xl font-bold mb-4">Login</h2>
           <p class="text-gray-600 mb-6">Welcome back! Please login to your account.</p>
           <form id="login-form">
               <label for="login-email" class="admin-label">Email</label>
               <input type="email" id="login-email" class="admin-input mb-4" required>
               <label for="login-password" class="admin-label">Password</label>
               <input type="password" id="login-password" class="admin-input" required>
               <p id="login-error" class="text-red-500 text-sm mt-2 hidden"></p>
               <div class="mt-6 flex justify-end space-x-4">
                   <button type="button" id="login-cancel-btn" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                   <button type="submit" class="px-4 py-2 bg-black text-white rounded-md hover:bg-gray-800">Login</button>
               </div>
           </form>
            <!-- NEW: Google Login Button -->
            <div class="relative py-4">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>
                <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">OR</span></div>
            </div>
            <button id="google-login-btn" class="w-full flex items-center justify-center gap-3 py-2.5 border border-gray-300 rounded-md hover:bg-gray-50">
                <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.618-3.319-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.244,44,30.036,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                <span>Sign in with Google</span>
            </button>
            <!-- NEW: Link to Signup -->
            <p class="text-center text-sm text-gray-600 mt-4">
                Don't have an account? <button type="button" id="login-to-signup-link" class="font-semibold text-indigo-600 hover:text-indigo-500">Sign Up</button>
            </p>
       </div>
   </div>

    <div id="signup-modal" class="modal-overlay">
        <div class="modal-content p-8 max-w-sm">
           <h2 class="text-2xl font-bold mb-4">Create Account</h2>
           <p class="text-gray-600 mb-6">Sign up for a new account to get started.</p>
           <form id="signup-form">
                <!-- NEW: Name field for signup -->
               <label for="signup-name" class="admin-label">Full Name</label>
               <input type="text" id="signup-name" class="admin-input mb-4" required>
               <label for="signup-email" class="admin-label">Email</label>
               <input type="email" id="signup-email" class="admin-input mb-4" required>
               <label for="signup-password" class="admin-label">Password</label>
               <input type="password" id="signup-password" class="admin-input" required>
               <p id="signup-error" class="text-red-500 text-sm mt-2 hidden"></p>
               <div class="mt-6 flex justify-end space-x-4">
                   <button type="button" id="signup-cancel-btn" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                   <button type="submit" class="px-4 py-2 bg-black text-white rounded-md hover:bg-gray-800">Sign Up</button>
               </div>
           </form>
           <!-- NEW: Link to Login -->
           <p class="text-center text-sm text-gray-600 mt-4">
               Already have an account? <button type="button" id="signup-to-login-link" class="font-semibold text-indigo-600 hover:text-indigo-500">Log In</button>
           </p>
       </div>
   </div>

    <div id="password-modal" class="modal-overlay">
         <div class="modal-content password-prompt p-8 max-w-sm">
             <h2 class="text-2xl font-bold mb-4">Admin Access</h2>
             <p class="text-gray-600 mb-6">Please enter the password to access the editor.</p>
             <form id="password-form">
                 <label for="password-input" class="admin-label">Password</label>
                 <!-- MODIFIED: Added password visibility toggle -->
                 <div class="password-container">
                    <input type="password" id="password-input" class="admin-input" required>
                    <span id="password-toggle-icon" class="password-toggle-icon">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                    </span>
                 </div>
                 <p id="password-error" class="text-red-500 text-sm mt-2 hidden">Incorrect password. Please try again.</p>
                 <div class="mt-6 flex justify-end space-x-4">
                     <button type="button" id="password-cancel-btn" class="secondary-btn px-4 py-2 rounded-md">Cancel</button>
                     <button type="submit" class="premium-btn !rounded-md">Login</button>
                 </div>
             </form>
         </div>
    </div>
    <!-- NEW: Admin Panel Modal with new class for side-panel styling -->
    <div id="admin-panel-modal" class="modal-overlay admin-view">
        <div class="modal-content admin-panel flex flex-col">
            <div class="p-6 border-b flex justify-between items-center">
                 <h2 class="text-2xl font-bold">Live Store Editor</h2>
                 <button id="admin-close-btn" class="text-gray-500 hover:text-black text-3xl">&times;</button>
            </div>
            <div class="p-6 flex-grow overflow-y-auto">
                <!-- TABS for navigating admin sections -->
                <div class="border-b border-gray-200 mb-6">
                    <nav class="flex space-x-4 overflow-x-auto pb-2" aria-label="Tabs">
                        <button class="admin-tab active" data-tab="dashboard">Dashboard</button>
                        <button class="admin-tab" data-tab="general">General</button>
                        <button class="admin-tab" data-tab="products">Products</button>
                        <!-- MODIFIED: New "List Products" tab -->
                        <button class="admin-tab" data-tab="list-products">List Products</button>
                        <button class="admin-tab" data-tab="categories">Categories</button>
                        <button class="admin-tab" data-tab="orders">Orders</button>
                        <button class="admin-tab" data-tab="deleted-orders">Deleted Orders</button> <!-- NEW -->
                        <button class="admin-tab" data-tab="abandoned-carts">Abandoned Carts</button>
                        <!-- NEW: Messaging and Users Tabs -->
                        <button class="admin-tab notification-badge-container" data-tab="messaging">
                            Messaging
                            <!-- Notification badge will be injected here -->
                        </button>
                        <!-- NEW: Tickets Tab -->
                        <button class="admin-tab" data-tab="tickets">Tickets</button>
                        <button class="admin-tab" data-tab="users">UserIDs</button>
                        <button class="admin-tab" data-tab="spin-wheel">"Try Your Luck" Game</button>
                        <button class="admin-tab" data-tab="reviews-manage">Manage Reviews</button>
                        <button class="admin-tab" data-tab="coupons">Coupons</button>
                        <button class="admin-tab" data-tab="whatsapp">WhatsApp</button>
                        <button class="admin-tab" data-tab="footer">Footer</button>
                        <!-- MODIFIED: "Pages" tab added -->
                        <button class="admin-tab" data-tab="pages">Modals</button>
                        <button class="admin-tab" data-tab="settings">Settings</button>
                    </nav>
                </div>
                
                <div id="admin-tab-dashboard" class="admin-tab-content">
                    <div class="flex space-x-1 mb-4 border-b">
                        <button class="dashboard-filter-btn active" data-period="all">All Time</button>
                        <button class="dashboard-filter-btn" data-period="today">Today</button>
                        <button class="dashboard-filter-btn" data-period="7d">Last 7 Days</button>
                        <button class="dashboard-filter-btn" data-period="30d">This Month</button>
                        <button class="dashboard-filter-btn" data-period="365d">This Year</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-gray-100 p-6 rounded-lg text-center">
                            <h3 class="text-gray-500 text-sm font-medium">TOTAL REVENUE</h3>
                            <p id="stats-total-revenue" class="text-3xl font-bold mt-2">Rs. 0</p>
                        </div>
                         <div class="bg-gray-100 p-6 rounded-lg text-center">
                            <h3 class="text-gray-500 text-sm font-medium">TOTAL ORDERS</h3>
                            <p id="stats-total-orders" class="text-3xl font-bold mt-2">0</p>
                        </div>
                         <div class="bg-gray-100 p-6 rounded-lg text-center">
                            <h3 class="text-gray-500 text-sm font-medium">AVG. ORDER VALUE</h3>
                            <p id="stats-avg-order" class="text-3xl font-bold mt-2">Rs. 0</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="admin-section">
                            <h3>Top Selling Products</h3>
                            <div id="stats-top-products" class="space-y-2">
                               <p class="text-gray-500">No sales data yet.</p>
                            </div>
                        </div>
                         <div class="admin-section">
                            <h3>Top Customers</h3>
                            <div id="stats-top-customers" class="space-y-2">
                               <p class="text-gray-500">No sales data yet.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="admin-tab-general" class="admin-tab-content hidden">
                    <div class="admin-section">
                        <h3>Store Identity</h3>
                        <label class="admin-label">Store Logo</label>
                        <div class="flex items-center gap-4 mb-4">
                            <input type="text" id="store-logo-input" class="admin-input live-preview" data-target="#store-logo" data-property="src" placeholder="https://example.com/logo.png">
                            <label class="upload-btn"><input type="file" class="hidden file-input" data-target="store-logo-input">Upload</label>
                        </div>
                        <!-- NEW: Store Logo Sliders -->
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="store-logo-width-input" class="admin-label">Logo Width (<span id="store-logo-width-value">40</span>px)</label>
                                <input type="range" id="store-logo-width-input" class="w-full" min="20" max="150" value="40">
                            </div>
                            <div>
                                <label for="store-logo-height-input" class="admin-label">Logo Height (<span id="store-logo-height-value">40</span>px)</label>
                                <input type="range" id="store-logo-height-input" class="w-full" min="20" max="150" value="40">
                            </div>
                        </div>
                        <label class="admin-label" for="store-name-input">Store Name</label>
                        <input type="text" id="store-name-input" class="admin-input mb-4 live-preview" data-target="#store-name" value="NewBees">
                        <label class="admin-label" for="store-name-align-select">Header Layout</label>
                        <select id="store-name-align-select" class="admin-select mb-4">
                            <option value="justify-between">Standard (Spaced Apart)</option>
                            <option value="justify-start">Left Aligned</option>
                            <option value="justify-center">Center Aligned</option>
                        </select>
                        <label class="admin-label" for="store-font-select">Store Name Font</label>
                        <select id="store-font-select" class="admin-select">
                            <option value="font-scifi">Sci-Fi (Orbitron)</option>
                            <option value="font-pricedown">Pricedown (Bebas)</option>
                            <option value="font-serif-elegant">Elegant (Playfair)</option>
                            <option value="font-sans">Standard (Inter)</option>
                            <option value="font-mono">Mono (Roboto Mono)</option>
                            <option value="font-anton">Anton</option>
                            <option value="font-fredoka">Fredoka</option>
                            <option value="font-calibri-alt">Calibri (Carlito)</option>
                            <option value="font-horizon-alt">Horizon (Audiowide)</option>
                        </select>
                    </div>
                    <div class="admin-section">
                        <h3>Announcement Bar</h3>
                        <label class="admin-label" for="announcement-text-input">Announcement Text</label>
                        <input type="text" id="announcement-text-input" class="admin-input mb-4 live-preview" data-target="#announcement-text-1, #announcement-text-1-dup">
                        <label class="admin-label" for="announcement-bg-color-input">Background Color</label>
                        <input type="color" id="announcement-bg-color-input" class="admin-input" value="#111827">
                    </div>
                    <div class="admin-section">
                        <h3>Hero Banner</h3>
                        <div class="flex items-center gap-2 mb-4">
                            <input type="checkbox" id="hero-text-visible-input" class="h-4 w-4" checked>
                            <label class="admin-label !mb-0" for="hero-text-visible-input">Show Hero Text</label>
                        </div>
                        <label class="admin-label" for="hero-title-input">Main Title</label>
                        <input type="text" id="hero-title-input" class="admin-input mb-4 live-preview" data-target="#hero-title" value="">
                        <label class="admin-label" for="hero-subtitle-input">Subtitle</label>
                        <input type="text" id="hero-subtitle-input" class="admin-input mb-4 live-preview" data-target="#hero-subtitle" value="Affordable  Reliable  Exceptional">
                         <label class="admin-label" for="hero-images-input">Background Slideshow Images (one URL per line)</label>
                         <p class="text-xs text-gray-500 mb-2">Supports image URLs (JPG, PNG) and animated GIFs.</p>
                        <div class="flex items-center gap-4 mb-4">
                            <textarea id="hero-images-input" class="admin-textarea" rows="4" placeholder="https://example.com/image1.png&#10;https://example.com/image2.png"></textarea>
                            <label class="upload-btn"><input type="file" class="hidden file-input" data-target="hero-images-input">Upload</label>
                        </div>
                        <label class="admin-label" for="hero-font-select">Main Title Font</label>
                        <select id="hero-font-select" class="admin-select mb-4">
                            <option value="font-pricedown">Pricedown (Bebas)</option>
                            <option value="font-scifi">Sci-Fi (Orbitron)</option>
                            <option value="font-serif-elegant">Elegant (Playfair)</option>
                            <option value="font-sans">Standard (Inter)</option>
                            <option value="font-mono">Mono (Roboto Mono)</option>
                            <option value="font-anton">Anton</option>
                            <option value="font-fredoka">Fredoka</option>
                            <option value="font-calibri-alt">Calibri (Carlito)</option>
                            <option value="font-horizon-alt">Horizon (Audiowide)</option>
                        </select>
                        <label class="admin-label" for="hero-animation-select">Main Title Animation</label>
                        <select id="hero-animation-select" class="admin-select mb-4">
                            <option value="shiny-text fade-in">Shiny + Fade In</option>
                            <option value="fade-in">Fade In</option>
                            <option value="blur-in">Blur In</option>
                        </select>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="admin-label" for="hero-title-fontsize-input">Title Font Size (rem)</label>
                                <input type="number" id="hero-title-fontsize-input" class="admin-input" step="0.1" value="4.5">
                            </div>
                             <div>
                                <label class="admin-label" for="hero-subtitle-fontsize-input">Subtitle Font Size (rem)</label>
                                <input type="number" id="hero-subtitle-fontsize-input" class="admin-input" step="0.1" value="1.5">
                            </div>
                        </div>
                    </div>
                    <!-- NEW: Secondary Announcement Bar Settings -->
                    <div class="admin-section">
                        <h3>Secondary Announcement Bar (Under Hero)</h3>
                        <div class="flex items-center gap-4 mb-4">
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="secondary-announcement-enabled-input" class="h-4 w-4">
                                <label class="admin-label !mb-0" for="secondary-announcement-enabled-input">Enable this bar</label>
                            </div>
                             <div class="flex items-center gap-2">
                                <input type="checkbox" id="secondary-announcement-animated-input" class="h-4 w-4">
                                <label class="admin-label !mb-0" for="secondary-announcement-animated-input">Enable Animation</label>
                            </div>
                        </div>
                        <label class="admin-label" for="secondary-announcement-text-input">Text</label>
                        <input type="text" id="secondary-announcement-text-input" class="admin-input mb-4">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <label class="admin-label" for="secondary-announcement-bg-color-input">Background Color</label>
                                <input type="color" id="secondary-announcement-bg-color-input" class="admin-input" value="#facc15">
                            </div>
                             <div>
                                <label class="admin-label" for="secondary-announcement-text-color-input">Text Color</label>
                                <input type="color" id="secondary-announcement-text-color-input" class="admin-input" value="#1f2937">
                            </div>
                             <div>
                                <label class="admin-label" for="secondary-announcement-animation-direction-select">Direction</label>
                                <select id="secondary-announcement-animation-direction-select" class="admin-select">
                                    <option value="scroll-left">Left</option>
                                    <option value="scroll-right">Right</option>
                                </select>
                            </div>
                            <div>
                                <label class="admin-label" for="secondary-announcement-animation-speed-input">Speed (sec)</label>
                                <input type="number" id="secondary-announcement-animation-speed-input" class="admin-input" value="40">
                            </div>
                        </div>
                    </div>
                     <div class="admin-section">
                        <h3>"Why Us" Section</h3>
                        <label class="admin-label" for="why-us-title-input">Title</label>
                        <input type="text" id="why-us-title-input" class="admin-input mb-2 live-preview" data-target="#why-us-title">
                        <label class="admin-label" for="why-us-subtitle-input">Subtitle</label>
                        <input type="text" id="why-us-subtitle-input" class="admin-input mb-4 live-preview" data-target="#why-us-subtitle">
                        <!-- Item 1 -->
                        <label class="admin-label font-semibold">Item 1 Title</label>
                        <input type="text" id="why-us-item1-title-input" class="admin-input mb-2 live-preview" data-target="#why-us-item-1 h3">
                        <label class="admin-label">Item 1 Description</label>
                        <textarea id="why-us-item1-desc-input" class="admin-textarea mb-4 live-preview" data-target="#why-us-item-1 p" rows="2"></textarea>
                        <!-- Item 2 -->
                        <label class="admin-label font-semibold">Item 2 Title</label>
                        <input type="text" id="why-us-item2-title-input" class="admin-input mb-2 live-preview" data-target="#why-us-item-2 h3">
                        <label class="admin-label">Item 2 Description</label>
                        <textarea id="why-us-item2-desc-input" class="admin-textarea mb-4 live-preview" data-target="#why-us-item-2 p" rows="2"></textarea>
                        <!-- Item 3 -->
                        <label class="admin-label font-semibold">Item 3 Title</label>
                        <input type="text" id="why-us-item3-title-input" class="admin-input mb-2 live-preview" data-target="#why-us-item-3 h3">
                        <label class="admin-label">Item 3 Description</label>
                        <textarea id="why-us-item3-desc-input" class="admin-textarea live-preview" data-target="#why-us-item-3 p" rows="2"></textarea>
                    </div>
                     <div class="admin-section">
                        <h3>Promotional Popup</h3>
                        <label class="admin-label" for="promo-popup-image-input">Image URL</label>
                        <p class="text-xs text-gray-500 mb-2">Supports image URLs (JPG, PNG) and animated GIFs.</p>
                        <!-- MODIFIED: Added upload button -->
                        <div class="flex items-center gap-4 mb-2">
                            <input type="text" id="promo-popup-image-input" class="admin-input">
                            <label class="upload-btn"><input type="file" class="hidden file-input" data-target="promo-popup-image-input">Upload</label>
                        </div>
                         <label class="admin-label" for="promo-popup-title-input">Title</label>
                        <input type="text" id="promo-popup-title-input" class="admin-input mb-2">
                         <label class="admin-label" for="promo-popup-text-input">Text</label>
                        <input type="text" id="promo-popup-text-input" class="admin-input">
                    </div>
                     <div class="admin-section">
                        <h3>Sale Countdown</h3>
                        <label class="admin-label" for="sale-message-input">Countdown Message</label>
                        <input type="text" id="sale-message-input" class="admin-input mb-2">
                        <label class="admin-label" for="sale-end-date-input">Sale End Date & Time</label>
                        <input type="datetime-local" id="sale-end-date-input" class="admin-input">
                    </div>
                </div>

                <!-- MODIFIED: "Products" tab now only contains global display settings -->
                <div id="admin-tab-products" class="admin-tab-content hidden">
                    <div class="admin-section">
                        <h3 class="text-xl font-bold">Product Display Settings</h3>
                        <div class="admin-section mt-4">
                            <h4 class="text-lg font-semibold mb-4">Featured Products Header</h4>
                             <div class="flex items-center gap-2 mb-4">
                                 <input type="checkbox" id="featured-header-enabled-input" class="h-4 w-4">
                                 <label class="admin-label !mb-0" for="featured-header-enabled-input">Enable Header Above Featured Products</label>
                             </div>
                             <label class="admin-label" for="featured-header-images-input">Header Images (one URL per line for slideshow)</label>
                             <p class="text-xs text-gray-500 mb-2">Supports image URLs (JPG, PNG) and animated GIFs.</p>
                             <div class="flex items-center gap-4">
                                <textarea id="featured-header-images-input" class="admin-textarea" rows="3" placeholder="https://.../image1.png&#10;https://.../image2.gif"></textarea>
                                <label class="upload-btn"><input type="file" class="hidden file-input" data-target="featured-header-images-input">Upload</label>
                             </div>
                             <div class="grid grid-cols-2 gap-4 mt-4">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <input type="checkbox" id="featured-slideshow-enabled-input" class="h-4 w-4">
                                        <label class="admin-label !mb-0" for="featured-slideshow-enabled-input">Enable Slideshow</label>
                                    </div>
                                </div>
                                <div>
                                    <label class="admin-label" for="featured-slideshow-speed-input">Slideshow Speed (ms)</label>
                                    <input type="number" id="featured-slideshow-speed-input" class="admin-input" value="5000" placeholder="e.g., 5000">
                                </div>
                             </div>
                        </div>
                        <div class="admin-section mt-4">
                             <h4 class="text-lg font-semibold mb-4">Featured Row Titles</h4>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="admin-label" for="featured-row-1-title-input">Row 1 Title</label>
                                    <input type="text" id="featured-row-1-title-input" class="admin-input">
                                </div>
                                <div>
                                    <label class="admin-label" for="featured-row-2-title-input">Row 2 Title</label>
                                    <input type="text" id="featured-row-2-title-input" class="admin-input">
                                </div>
                             </div>
                        </div>
                        <div class="admin-section mt-4">
                            <h4 class="text-lg font-semibold mb-4">Product Card Display</h4>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h5>Style & Animations</h5>
                                    <div class="flex items-center gap-2 mb-4">
                                        <input type="checkbox" id="product-fade-animation-input" class="h-4 w-4">
                                        <label class="admin-label !mb-0" for="product-fade-animation-input">Enable Fade-In Animation on Scroll</label>
                                    </div>
                                    <div class="mb-4">
                                        <label class="admin-label" for="product-card-slideshow-speed-input">Hover Slideshow Speed (ms)</label>
                                        <input type="number" id="product-card-slideshow-speed-input" class="admin-input" placeholder="e.g., 2000">
                                    </div>
                                    <label class="admin-label" for="product-card-width-select">Card Width</label>
                                    <select id="product-card-width-select" class="admin-select mb-4">
                                        <option value="w-64">Small</option>
                                        <option value="w-72" selected>Medium</option>
                                        <option value="w-80">Large</option>
                                    </select>
                                    <label class="admin-label" for="product-card-style-select">Card Style</label>
                                    <select id="product-card-style-select" class="admin-select mb-4">
                                        <option value="product-card-default">Default (Shadow)</option>
                                        <option value="product-card-minimal">Minimal (Border)</option>
                                    </select>
                                    <label class="admin-label">Corner Rounding</label>
                                    <select id="product-card-radius-input" data-css-var="--product-card-radius" class="admin-select">
                                        <option value="0px">None</option>
                                        <option value="0.25rem">Small</option>
                                        <option value="0.5rem" selected>Medium</option>
                                        <option value="0.75rem">Large</option>
                                    </select>
                                </div>
                                 <div>
                                    <h5>Colors</h5>
                                    <div class="grid grid-cols-2 gap-4">
                                         <div><label class="admin-label" for="product-card-bg-color-input">Card Background</label><input type="color" id="product-card-bg-color-input" data-css-var="--product-card-bg" class="admin-input" value="#ffffff"></div>
                                         <div><label class="admin-label" for="product-text-color-input">Card Text</label><input type="color" id="product-text-color-input" data-css-var="--product-text-color" class="admin-input" value="#1f2937"></div>
                                         <!-- MODIFIED: Star Color input -->
                                         <div><label class="admin-label" for="star-color-input">Star Rating Color</label><input type="color" id="star-color-input" data-css-var="--star-color" class="admin-input" value="#facc15"></div>
                                         <div><label class="admin-label" for="sale-price-color-input">Sale Price</label><input type="color" id="sale-price-color-input" data-css-var="--sale-price-color" class="admin-input" value="#1f2937"></div>
                                         <div><label class="admin-label" for="original-price-color-input">Original Price</label><input type="color" id="original-price-color-input" data-css-var="--original-price-color" class="admin-input" value="#6b7280"></div>
                                         <div><label class="admin-label" for="sale-badge-bg-color-input">Sale Badge BG</label><input type="color" id="sale-badge-bg-color-input" data-css-var="--sale-badge-bg" class="admin-input" value="#ef4444"></div>
                                         <div><label class="admin-label" for="sale-badge-text-color-input">Sale Badge Text</label><input type="color" id="sale-badge-text-color-input" data-css-var="--sale-badge-text" class="admin-input" value="#ffffff"></div>
                                         <div><label class="admin-label" for="sold-badge-bg-color-input">Sold Badge BG</label><input type="color" id="sold-badge-bg-color-input" data-css-var="--sold-badge-bg" class="admin-input" value="#3b82f6"></div>
                                         <div><label class="admin-label" for="sold-badge-text-color-input">Sold Badge Text</label><input type="color" id="sold-badge-text-color-input" data-css-var="--sold-badge-text" class="admin-input" value="#ffffff"></div>
                                    </div>
                                 </div>
                            </div>
                        </div>
                         <div class="admin-section">
                            <h4 class="text-lg font-semibold mb-4">Button Customization</h4>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h5>"Add to Cart" Button</h5>
                                    <label class="admin-label">Background Color</label>
                                    <input type="color" id="add-to-cart-btn-bg-color-input" data-css-var="--add-to-cart-btn-bg" class="admin-input mb-4" value="#111827">
                                    <label class="admin-label">Corner Rounding</label>
                                    <select id="add-to-cart-btn-radius-input" data-css-var="--add-to-cart-btn-radius" class="admin-select">
                                        <option value="0px">None</option>
                                        <option value="0.25rem">Small</option>
                                        <option value="0.375rem" selected>Medium</option>
                                        <option value="0.5rem">Large</option>
                                        <option value="9999px">Full</option>
                                    </select>
                                </div>
                                <div>
                                    <h5>"View" Button</h5>
                                    <label class="admin-label">Background Color</label>
                                    <input type="color" id="view-btn-bg-input" data-css-var="--view-btn-bg" class="admin-input mb-4" value="#e5e7eb">
                                    <label class="admin-label">Text Color</label>
                                    <input type="color" id="view-btn-text-input" data-css-var="--view-btn-text" class="admin-input mb-4" value="#1f2937">
                                    <label class="admin-label">Corner Rounding</label>
                                    <select id="view-btn-radius-input" data-css-var="--view-btn-radius" class="admin-select">
                                        <option value="0px">None</option>
                                        <option value="0.25rem">Small</option>
                                        <option value="0.375rem" selected>Medium</option>
                                        <option value="0.5rem">Large</option>
                                        <option value="9999px">Full</option>
                                    </select>
                                </div>
                                <div class="col-span-2">
                                     <label class="admin-label">Button Size (Padding)</label>
                                     <select id="btn-padding-input" class="admin-select">
                                         <option value="0.375rem 0.75rem">Small</option>
                                         <option value="0.5rem 1rem" selected>Medium</option>
                                         <option value="0.75rem 1.5rem">Large</option>
                                     </select>
                                </div>
                             </div>
                         </div>
                        <!-- NEW: Product Card Font Customization -->
                        <div class="admin-section">
                            <h4 class="text-lg font-semibold mb-4">Product Card Fonts & Text</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="admin-label" for="product-name-font-select">Product Name Font</label>
                                    <select id="product-name-font-select" class="admin-select">
                                        <option value="'Inter', sans-serif">Standard (Inter)</option>
                                        <option value="'Playfair Display', serif">Elegant (Playfair)</option>
                                        <option value="'Orbitron', sans-serif">Sci-Fi (Orbitron)</option>
                                        <option value="'Bebas Neue', sans-serif">Pricedown (Bebas)</option>
                                        <option value="'Roboto Mono', monospace">Mono (Roboto Mono)</option>
                                        <option value="'Anton', sans-serif">Anton</option>
                                        <option value="'Fredoka', sans-serif">Fredoka</option>
                                        <option value="'Carlito', sans-serif">Calibri (Carlito)</option>
                                        <option value="'Audiowide', sans-serif">Horizon (Audiowide)</option>
                                    </select>
                                    <label class="admin-label mt-4" for="product-name-font-weight-select">Product Name Weight</label>
                                    <select id="product-name-font-weight-select" class="admin-select">
                                        <option value="400">Normal</option>
                                        <option value="700">Bold</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="admin-label" for="product-price-font-select">Price Font</label>
                                    <select id="product-price-font-select" class="admin-select">
                                        <option value="'Inter', sans-serif">Standard (Inter)</option>
                                        <option value="'Roboto Mono', monospace">Mono (Roboto Mono)</option>
                                        <option value="'Playfair Display', serif">Elegant (Playfair)</option>
                                        <option value="'Bebas Neue', sans-serif">Pricedown (Bebas)</option>
                                        <option value="'Orbitron', sans-serif">Sci-Fi (Orbitron)</option>
                                        <option value="'Anton', sans-serif">Anton</option>
                                        <option value="'Fredoka', sans-serif">Fredoka</option>
                                        <option value="'Carlito', sans-serif">Calibri (Carlito)</option>
                                        <option value="'Audiowide', sans-serif">Horizon (Audiowide)</option>
                                    </select>
                                    <label class="admin-label mt-4" for="product-price-font-weight-select">Price Weight</label>
                                    <select id="product-price-font-weight-select" class="admin-select">
                                        <option value="400">Normal</option>
                                        <option value="700">Bold</option>
                                    </select>
                                </div>
                                <!-- NEW: Price Font Size Slider -->
                                <div class="md:col-span-2">
                                     <label class="admin-label">Price Font Size (<span id="product-price-fs-val">18</span>px)</label>
                                     <input type="range" id="product-price-fontsize-input" class="w-full" min="12" max="32" value="18">
                                </div>
                                <div class="md:col-span-2 p-4 border rounded-md bg-white">
                                    <h5 class="text-center font-bold text-sm mb-2">Live Preview</h5>
                                    <h3 id="font-preview-name" class="text-xl mt-2 mb-2 truncate">Sample Product Name</h3>
                                    <div class="flex flex-col items-start mt-2">
                                        <p id="font-preview-price-original" class="text-sm line-through" style="color: var(--original-price-color);">Rs. 1,000</p>
                                        <p id="font-preview-price-sale" class="text-lg">Rs. 800</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                         <div class="admin-section">
                            <h4 class="text-lg font-semibold mb-4">Product Page Features</h4>
                            <label class="admin-label" for="product-detail-subtitle-input">Default Product Detail Subtitle</label>
                            <input type="text" id="product-detail-subtitle-input" class="admin-input mb-4" placeholder="This is a fallback subtitle for products without their own.">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 p-4 border rounded-md">
                                <div>
                                    <label class="admin-label">Name Font Size (<span id="pd-name-fs-val">30</span>px)</label>
                                    <input type="range" id="product-detail-name-fontsize-input" class="w-full" min="20" max="60" value="30">
                                </div>
                                <div>
                                    <label class="admin-label">Price Font Size (<span id="pd-price-fs-val">24</span>px)</label>
                                    <input type="range" id="product-detail-price-fontsize-input" class="w-full" min="16" max="50" value="24">
                                </div>
                                <div class="md:col-span-2 text-center text-sm">
                                    <p class="font-bold">Live Preview:</p>
                                    <h2 id="product-detail-name-preview" class="font-bold truncate" style="font-size: 30px;">Product Name</h2>
                                    <div id="product-detail-price-preview" class="font-bold text-right" style="font-size: 24px;">
                                        <span class="price-sale" style="font-size: 1em;">Rs. 1,234</span>
                                        <span class="price-original line-through ml-2" style="font-size: 0.7em;">Rs. 1,500</span>
                                    </div>
                                </div>
                            </div>
                            <!-- NEW: Product Detail Price Styling -->
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                                <div>
                                    <h5 class="font-semibold mb-2">Original Price Style</h5>
                                    <label class="admin-label">Font</label>
                                    <select id="pd-original-price-font-select" class="admin-select mb-2">
                                        <option value="'Inter', sans-serif">Standard (Inter)</option>
                                        <option value="'Roboto Mono', monospace">Mono (Roboto Mono)</option>
                                        <option value="'Playfair Display', serif">Elegant (Playfair)</option>
                                        <option value="'Bebas Neue', sans-serif">Pricedown (Bebas)</option>
                                        <option value="'Orbitron', sans-serif">Sci-Fi (Orbitron)</option>
                                        <option value="'Anton', sans-serif">Anton</option>
                                        <option value="'Fredoka', sans-serif">Fredoka</option>
                                        <option value="'Carlito', sans-serif">Calibri (Carlito)</option>
                                        <option value="'Audiowide', sans-serif">Horizon (Audiowide)</option>
                                    </select>
                                    <label class="admin-label">Weight</label>
                                    <select id="pd-original-price-font-weight-select" class="admin-select mb-2">
                                        <option value="400">Normal</option>
                                        <option value="700">Bold</option>
                                    </select>
                                    <label class="admin-label">Color</label>
                                    <input type="color" id="pd-original-price-color-input" class="admin-input">
                                </div>
                                <div>
                                    <h5 class="font-semibold mb-2">Sale Price Style</h5>
                                    <label class="admin-label">Font</label>
                                    <select id="pd-sale-price-font-select" class="admin-select mb-2">
                                         <option value="'Inter', sans-serif">Standard (Inter)</option>
                                        <option value="'Roboto Mono', monospace">Mono (Roboto Mono)</option>
                                        <option value="'Playfair Display', serif">Elegant (Playfair)</option>
                                        <option value="'Bebas Neue', sans-serif">Pricedown (Bebas)</option>
                                        <option value="'Orbitron', sans-serif">Sci-Fi (Orbitron)</option>
                                        <option value="'Anton', sans-serif">Anton</option>
                                        <option value="'Fredoka', sans-serif">Fredoka</option>
                                        <option value="'Carlito', sans-serif">Calibri (Carlito)</option>
                                        <option value="'Audiowide', sans-serif">Horizon (Audiowide)</option>
                                    </select>
                                    <label class="admin-label">Weight</label>
                                    <select id="pd-sale-price-font-weight-select" class="admin-select mb-2">
                                        <option value="400">Normal</option>
                                        <option value="700">Bold</option>
                                    </select>
                                    <label class="admin-label">Color</label>
                                    <input type="color" id="pd-sale-price-color-input" class="admin-input">
                                </div>
                            </div>
                            <p class="text-sm text-gray-500 my-4">Customize the text and icons on the product detail page. Leave text blank to hide a feature.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div><label class="admin-label">Feature 1 Text</label><input type="text" id="feature1-text-input" class="admin-input" placeholder="e.g., Nationwide Delivery"></div>
                                <div>
                                    <label class="admin-label">Feature 1 Icon (Image URL or paste SVG)</label>
                                    <div class="flex items-center gap-4">
                                        <textarea id="feature1-icon-input" class="admin-textarea font-mono" rows="3"></textarea>
                                        <label class="upload-btn !py-2.5"><input type="file" class="hidden file-input" data-target="feature1-icon-input">Upload</label>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div><label class="admin-label">Feature 2 Text</label><input type="text" id="feature2-text-input" class="admin-input" placeholder="e.g., Cash on Delivery"></div>
                                <div>
                                    <label class="admin-label">Feature 2 Icon (Image URL or paste SVG)</label>
                                    <div class="flex items-center gap-4">
                                        <textarea id="feature2-icon-input" class="admin-textarea font-mono" rows="3"></textarea>
                                        <label class="upload-btn !py-2.5"><input type="file" class="hidden file-input" data-target="feature2-icon-input">Upload</label>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="admin-label">Feature 3 Text</label><input type="text" id="feature3-text-input" class="admin-input" placeholder="e.g., Online Payments"></div>
                                <div>
                                    <label class="admin-label">Feature 3 Icon (Image URL or paste SVG)</label>
                                    <div class="flex items-center gap-4">
                                        <textarea id="feature3-icon-input" class="admin-textarea font-mono" rows="3"></textarea>
                                        <label class="upload-btn !py-2.5"><input type="file" class="hidden file-input" data-target="feature3-icon-input">Upload</label>
                                    </div>
                                </div>
                            </div>
                         </div>
                        <div class="admin-section">
                           <h4 class="text-lg font-semibold mb-4">Stock Status Display</h4>
                           <label for="product-stock-status-size-input" class="admin-label">Font Size (<span id="pd-stock-fs-val">14</span>px)</label>
                           <input type="range" id="product-stock-status-size-input" class="w-full" min="10" max="24" value="14">
                        </div>
                    </div>
                </div>

                <!-- MODIFIED: New tab for listing and editing products -->
                <div id="admin-tab-list-products" class="admin-tab-content hidden">
                    <div id="admin-products-list" class="space-y-4 mb-6"></div>
                    <div class="admin-section">
                        <h3 id="product-form-title" class="text-xl font-bold">Add New Product</h3>
                        <form id="product-form" class="space-y-4">
                            <input type="hidden" id="product-id-input">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="admin-label" for="product-name-input">Product Name</label>
                                    <input type="text" id="product-name-input" class="admin-input" required>
                                </div>
                                <div>
                                    <label class="admin-label" for="product-category-select">Category</label>
                                    <select id="product-category-select" class="admin-select" required></select>
                                </div>
                            </div>
                            <div>
                                <label class="admin-label" for="product-subtitle-input">Product Subtitle (Overrides default)</label>
                                <input type="text" id="product-subtitle-input" class="admin-input">
                            </div>
                             <div class="flex items-center gap-6 pt-2">
                                 <div>
                                    <label class="admin-label !mb-2" for="product-featured-select">Feature this product in</label>
                                    <select id="product-featured-select" class="admin-select">
                                        <option value="0">None</option>
                                        <option value="1">Row 1</option>
                                        <option value="2">Row 2</option>
                                    </select>
                                </div>
                                <div class="flex items-center gap-2 mt-8">
                                    <input type="checkbox" id="product-size-guide-input" class="h-4 w-4">
                                    <label class="admin-label !mb-0" for="product-size-guide-input">Show Size Guide</label>
                                </div>
                             </div>
                            
                            <div class="admin-section border-t pt-4">
                                <h3 class="text-lg">Main Product Details</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="admin-label" for="product-main-image-input">Main Image URLs (one per line)</label>
                                        <p class="text-xs text-gray-500 mb-2">Supports image URLs (JPG, PNG) and animated GIFs.</p>
                                         <div class="flex items-center gap-4">
                                            <textarea id="product-main-image-input" class="admin-textarea" rows="3" placeholder="https://..." required></textarea>
                                            <label class="upload-btn !py-2.5"><input type="file" class="hidden file-input" data-target="product-main-image-input">Upload</label>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="admin-label" for="product-stock-input">Stock Quantity (if no variants)</label>
                                        <input type="number" id="product-stock-input" class="admin-input" min="0" value="10">
                                    </div>
                                     <div class="md:col-span-2">
                                        <label class="admin-label" for="product-video-url-input">Main Video URL (YouTube or .mp4 link)</label>
                                        <input type="text" id="product-video-url-input" class="admin-input" placeholder="https://...">
                                    </div>
                                </div>
                            </div>

                             <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="admin-label" for="product-price-input">Price (Rs.)</label>
                                    <input type="number" id="product-price-input" class="admin-input" step="0.01" required>
                                </div>
                                <div>
                                    <label class="admin-label" for="product-sale-price-input">Sale Price (Rs., optional)</label>
                                    <input type="number" id="product-sale-price-input" class="admin-input" step="0.01">
                                </div>
                                <div>
                                    <label class="admin-label" for="product-delivery-charge-input">Delivery Charges (Rs.)</label>
                                    <input type="number" id="product-delivery-charge-input" class="admin-input" step="0.01" value="0" required>
                                </div>
                            </div>

                             <div>
                                <label class="admin-label" for="product-description-input">Description</label>
                                <div class="editor-toolbar" data-target="product-description-input">
                                    <button type="button"><b>B</b></button>
                                    <button type="button"><i>I</i></button>
                                    <button type="button">Image</button>
                                </div>
                                <textarea id="product-description-input" class="admin-textarea has-toolbar" rows="4"></textarea>
                            </div>
                            
                             <div class="admin-section border-t pt-4">
                                <h3 class="text-lg">Product Variants (for colors, sizes, etc.)</h3>
                                <p class="text-sm text-gray-500 mb-4">Add variants if this product comes in multiple versions. Each variant must have its own image and stock count. If you add variants, the main stock count above will be ignored.</p>
                                <div id="product-variants-container" class="space-y-4"></div>
                                <button type="button" id="add-variant-btn" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-sm">Add Variant</button>
                            </div>

                            <div class="admin-section border-t pt-4">
                                <h3 class="text-lg">SEO & Discovery</h3>
                                 <div>
                                    <label class="admin-label" for="product-tags-input">Tags (comma-separated)</label>
                                    <input type="text" id="product-tags-input" class="admin-input" placeholder="e.g. onesie, cotton, soft">
                                </div>
                                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                     <div>
                                        <div class="flex justify-between items-center">
                                            <label class="admin-label" for="product-meta-keywords-input">Meta Keywords</label>
                                            <span id="product-meta-keywords-counter" class="char-counter"></span>
                                        </div>
                                         <textarea id="product-meta-keywords-input" class="admin-textarea" rows="2"></textarea>
                                     </div>
                                     <div>
                                        <div class="flex justify-between items-center">
                                            <label class="admin-label" for="product-meta-description-input">Meta Description</label>
                                            <span id="product-meta-description-counter" class="char-counter"></span>
                                        </div>
                                         <textarea id="product-meta-description-input" class="admin-textarea" rows="2"></textarea>
                                     </div>
                                 </div>
                                <div class="seo-preview-container mt-4 p-4 border rounded-md bg-gray-50">
                                    <h4 class="font-semibold text-sm mb-2">Search Engine Listing Preview</h4>
                                    <div><a href="#" class="seo-preview-title" onclick="return false;">Product Name</a></div>
                                    <div class="seo-preview-url">https://yourstore.com/products/product-name</div>
                                    <div class="seo-preview-description">This is where the meta description for the product will appear.</div>
                                </div>
                             </div>

                            <div class="flex space-x-4">
                                <button type="submit" class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Save Product</button>
                                <button type="button" id="cancel-edit-product-btn" class="w-full px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300 hidden">Cancel Edit</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="admin-tab-categories" class="admin-tab-content hidden">
                     <div class="admin-section">
                        <h3>Edit Existing Categories</h3>
                        <div id="admin-categories-list" class="space-y-4 mb-6"></div>
                     </div>
                     <div class="admin-section">
                        <h3>Add New Category</h3>
                        <form id="category-form" class="space-y-4">
                            <div>
                                <label class="admin-label" for="category-name-input">Category Name</label>
                                <input type="text" id="category-name-input" class="admin-input" required>
                            </div>
                            <div>
                                <label class="admin-label" for="category-image-input">Category Banner Image URL</label>
                                <p class="text-xs text-gray-500 mb-2">You can use image URLs (JPG, PNG) or animated GIFs.</p>
                                <div class="flex items-center gap-4">
                                    <input type="text" id="category-image-input" class="admin-input" required>
                                    <label class="upload-btn !py-2.5"><input type="file" class="hidden file-input" data-target="category-image-input">Upload</label>
                                </div>
                            </div>
                            <!-- NEW: Input for category display image -->
                            <div>
                                <label class="admin-label" for="category-display-image-input-new">Category Display Image URL</label>
                                <p class="text-xs text-gray-500 mb-2">Small image shown above the category button. Supports GIFs.</p>
                                <div class="flex items-center gap-4">
                                    <input type="text" id="category-display-image-input-new" class="admin-input">
                                    <label class="upload-btn !py-2.5"><input type="file" class="hidden file-input" data-target="category-display-image-input-new">Upload</label>
                                </div>
                            </div>
                            <button type="submit" class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Add Category</button>
                        </form>
                    </div>
                    <!-- NEW: Category Display Settings -->
                    <div class="admin-section">
                        <h3>Display Settings</h3>
                        <!-- NEW: Category Display Image Toggle -->
                        <div class="flex items-center gap-2 mb-4">
                           <input type="checkbox" id="category-images-enabled-input" class="h-4 w-4">
                           <label class="admin-label !mb-0" for="category-images-enabled-input">Enable Category Display Images</label>
                        </div>
                        <!-- NEW: Category Modal Logo Input -->
                        <label class="admin-label" for="category-modal-logo-input">Modal Logo URL (for Categories, Product Detail & Cart)</label>
                        <div class="flex items-center gap-4 mb-4">
                            <input type="text" id="category-modal-logo-input" class="admin-input" placeholder="https://...">
                            <label class="upload-btn !py-2.5"><input type="file" class="hidden file-input" data-target="category-modal-logo-input">Upload</label>
                        </div>
                        <!-- NEW: Modal Logo Animation -->
                        <label class="admin-label" for="modal-logo-animation-select">Modal Logo Animation</label>
                        <select id="modal-logo-animation-select" class="admin-select mb-4">
                            <option value="">None</option>
                            <option value="animate-breathe">Breathing</option>
                            <option value="animate-pulse">Pulse</option>
                        </select>
                        <label for="category-banner-height-input" class="admin-label">Category Banner Height (<span id="category-banner-height-value">192</span>px)</label>
                        <input type="range" id="category-banner-height-input" class="w-full" min="100" max="400" value="192">
                    </div>
                    <!-- NEW: Category Button Style Section -->
                    <div class="admin-section">
                        <h3>Category Button Style</h3>
                        <p class="text-sm text-gray-500 mb-4">Customize the gradient colors of the category and "Write a Review" buttons.</p>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="admin-label" for="category-btn-color1-input">Gradient Start Color</label>
                                <input type="color" id="category-btn-color1-input" class="admin-input" value="#fb923c">
                            </div>
                            <div>
                                <label class="admin-label" for="category-btn-color2-input">Gradient End Color</label>
                                <input type="color" id="category-btn-color2-input" class="admin-input" value="#ea580c">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="admin-tab-orders" class="admin-tab-content hidden">
                    <div class="admin-section">
                        <h3>Order Settings</h3>
                        <label class="admin-label" for="order-id-prefix-input">Order ID Prefix</label>
                        <input type="text" id="order-id-prefix-input" class="admin-input mb-4" placeholder="e.g., NB-">
                        <!-- NEW: Order Success Popup Admin -->
                        <h4 class="text-lg font-semibold mt-4">Order Success Popup</h4>
                        <label class="admin-label mt-4" for="order-success-header-input">Header Image/GIF URL</label>
                        <input type="text" id="order-success-header-input" class="admin-input">
                        <label class="admin-label mt-4" for="order-success-message-input">Popup Message</label>
                        <textarea id="order-success-message-input" class="admin-textarea" rows="3"></textarea>
                        <h5 class="font-semibold text-sm mt-4 mb-2">Live Preview:</h5>
                        <div id="order-success-preview-container" class="border rounded-lg p-4 bg-gray-50 text-center">
                            <img id="order-success-preview-image" src="https://placehold.co/300x150/dcfce7/22c55e?text=Success!" class="w-full h-32 object-contain rounded-md mb-4">
                            <div id="order-success-preview-message" class="text-gray-700">Your message will appear here.</div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <input type="search" id="order-search-input" placeholder="Search by customer name or order ID..." class="admin-input">
                    </div>
                    <div class="flex space-x-1 mb-4 border-b">
                        <button class="order-filter-btn active" data-status="All">All</button>
                        <button class="order-filter-btn" data-status="Pending">Pending</button>
                        <button class="order-filter-btn" data-status="Contacted">Contacted</button>
                        <button class="order-filter-btn" data-status="On Hold">On Hold</button>
                        <button class="order-filter-btn" data-status="Delivered">Delivered</button>
                        <button class="order-filter-btn" data-status="Cancelled">Cancelled</button> <!-- NEW -->
                    </div>
                    <div id="admin-orders-list" class="space-y-4"></div>
                </div>

                <!-- NEW: Deleted Orders Tab -->
                <div id="admin-tab-deleted-orders" class="admin-tab-content hidden">
                    <div class="admin-section">
                        <h3>Deleted Orders</h3>
                        <p class="text-sm text-gray-600 mb-4">These orders have been removed from the main list. You can restore them if needed.</p>
                        <div id="admin-deleted-orders-list" class="space-y-4">
                            <!-- Deleted orders will be rendered here -->
                        </div>
                    </div>
                </div>

                <!-- NEW: Abandoned Carts Tab -->
                <div id="admin-tab-abandoned-carts" class="admin-tab-content hidden">
                    <div class="admin-section">
                        <h3>Abandoned Carts</h3>
                        <p class="text-sm text-gray-600 mb-4">Carts from logged-in users that were left without checkout for more than 1 hour.</p>
                        <div id="admin-abandoned-carts-list" class="space-y-4">
                            <!-- Abandoned carts will be rendered here -->
                        </div>
                    </div>
                </div>

                <!-- NEW: Messaging Tab -->
                <div id="admin-tab-messaging" class="admin-tab-content hidden">
                    <!-- NEW: Search bar -->
                    <div class="mb-4">
                        <input type="search" id="messaging-search-input" placeholder="Search users..." class="admin-input">
                    </div>
                    <div class="chat-container">
                        <div class="user-list-panel" id="message-user-list">
                            <p class="p-4 text-center text-gray-500">Loading users...</p>
                        </div>
                        <div class="chat-window" id="message-chat-window">
                            <div id="admin-chat-header" class="chat-header">Select a user to start chatting</div>
                            <div class="messages-area bg-gray-50" id="admin-messages-area">
                                <!-- Messages will be rendered here -->
                            </div>
                            <div class="chat-input-area">
                                <form id="admin-message-form" class="flex gap-2 items-center">
                                    <input type="file" id="admin-message-image-upload" class="hidden" accept="image/*">
                                    <button type="button" id="admin-upload-image-btn" class="p-2 rounded-full hover:bg-gray-200">
                                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                    </button>
                                    <input type="text" id="admin-message-input" class="admin-input" placeholder="Type your message..." required disabled>
                                    <button type="submit" id="admin-message-send-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400" disabled>Send</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NEW: Tickets Tab -->
                <div id="admin-tab-tickets" class="admin-tab-content hidden">
                    <div class="admin-section">
                        <h3>Ticket System Settings</h3>
                        <div class="flex items-center gap-2 mb-4">
                            <input type="checkbox" id="ticket-button-enabled-input" class="h-4 w-4">
                            <label class="admin-label !mb-0" for="ticket-button-enabled-input">Enable Floating Support Button</label>
                        </div>
                        <label class="admin-label">Ticket Subjects</label>
                        <div id="admin-ticket-subjects-list" class="space-y-2 mb-2"></div>
                        <form id="add-ticket-subject-form" class="flex items-center gap-2">
                            <input type="text" id="new-ticket-subject-input" class="admin-input" placeholder="Enter new subject..." required>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">Add</button>
                        </form>
                    </div>
                    <!-- NEW: Support Button Customization -->
                    <div class="admin-section">
                        <h3>Floating Button Customization</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                            <div class="md:col-span-2">
                                <p class="admin-label mb-2">Button Colors</p>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="admin-label !text-xs" for="support-btn-color1-input">Gradient Start</label>
                                        <input type="color" id="support-btn-color1-input" class="admin-input">
                                    </div>
                                    <div>
                                        <label class="admin-label !text-xs" for="support-btn-color2-input">Gradient End</label>
                                        <input type="color" id="support-btn-color2-input" class="admin-input">
                                    </div>
                                     <div class="col-span-2">
                                        <label class="admin-label !text-xs" for="support-btn-text-color-input">Text Color</label>
                                        <input type="color" id="support-btn-text-color-input" class="admin-input">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <p class="admin-label text-center">Live Preview</p>
                                <button id="floating-support-btn-preview" class="mx-auto w-40 h-10 rounded-md font-bold flex items-center justify-center gap-2" disabled>
                                    <span>Support</span>
                                </button>
                            </div>
                        </div>
                        <label class="admin-label mt-4">Floating Button Icon (Image URL or SVG)</label>
                        <div class="flex items-center gap-4">
                            <input type="text" id="support-icon-svg-input" class="admin-input">
                            <label class="upload-btn"><input type="file" class="hidden file-input" data-target="support-icon-svg-input">Upload</label>
                        </div>
                    </div>
                    <div class="admin-section">
                        <h3>All Tickets</h3>
                        <!-- NEW: Ticket Filters -->
                        <div class="flex space-x-1 mb-4 border-b">
                            <button class="ticket-filter-btn active" data-status="All">All</button>
                            <button class="ticket-filter-btn" data-status="Open">Open</button>
                            <button class="ticket-filter-btn" data-status="In Progress">In Progress</button>
                            <button class="ticket-filter-btn" data-status="Solved">Solved</button>
                            <button class="ticket-filter-btn" data-status="Closed">Closed</button>
                            <button class="ticket-filter-btn" data-status="Deleted">Deleted</button>
                        </div>
                        <div id="admin-tickets-list" class="space-y-4">
                            <p class="text-gray-500">Loading tickets...</p>
                        </div>
                    </div>
                </div>

                <!-- NEW: Users Tab -->
                <div id="admin-tab-users" class="admin-tab-content hidden">
                    <div class="admin-section">
                        <h3>Registered Users</h3>
                        <div class="mb-4">
                            <input type="search" id="users-search-input" placeholder="Search by name, email, or UID..." class="admin-input">
                        </div>
                        <div id="admin-users-list" class="space-y-2">
                            <!-- User list will be populated here -->
                            <p class="text-gray-500">Loading users...</p>
                        </div>
                    </div>
                </div>

                <!-- MODIFIED: "Try Your Luck" Game Admin Tab -->
                <div id="admin-tab-spin-wheel" class="admin-tab-content hidden">
                     <div class="admin-section">
                        <h3>Game Settings</h3>
                        <div class="flex items-center gap-2 mb-4">
                            <input type="checkbox" id="spin-wheel-enabled-input" class="h-4 w-4">
                            <label class="admin-label !mb-0" for="spin-wheel-enabled-input">Enable "Try Your Luck" Feature</label>
                        </div>
                        <label class="admin-label" for="luck-game-type-select">Game Type</label>
                        <select id="luck-game-type-select" class="admin-select mb-4">
                            <option value="wheel">Spin the Wheel</option>
                            <option value="crate">Crate Opening</option>
                        </select>
                        <label class="admin-label">Popup Logo</label>
                        <div class="flex items-center gap-4 mb-4">
                            <input type="text" id="spin-wheel-logo-input" class="admin-input" placeholder="https://example.com/logo.png">
                            <label class="upload-btn"><input type="file" class="hidden file-input" data-target="spin-wheel-logo-input">Upload</label>
                        </div>
                        <label class="admin-label" for="spin-wheel-logo-animation-select">Logo Animation</label>
                        <select id="spin-wheel-logo-animation-select" class="admin-select">
                            <option value="">None</option>
                            <option value="animate-breathe">Breathing</option>
                            <option value="animate-pulse">Pulse</option>
                        </select>
                     </div>
                     <!-- MODIFIED: Crate Image Settings -->
                     <div class="admin-section">
                        <h3>Crate Game Images</h3>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                             <div>
                                 <label class="admin-label">Crate Closed Image</label>
                                 <div class="flex items-center gap-4">
                                     <input type="text" id="crate-closed-image-input" class="admin-input" placeholder="https://...">
                                     <label class="upload-btn"><input type="file" class="hidden file-input" data-target="crate-closed-image-input">Upload</label>
                                 </div>
                             </div>
                             <div>
                                 <label class="admin-label">Crate Open Image</label>
                                 <div class="flex items-center gap-4">
                                     <input type="text" id="crate-open-image-input" class="admin-input" placeholder="https://...">
                                     <label class="upload-btn"><input type="file" class="hidden file-input" data-target="crate-open-image-input">Upload</label>
                                 </div>
                             </div>
                         </div>
                     </div>
                     <div class="admin-section">
                        <h3 id="spin-prize-form-title">Prizes & Wheel Preview</h3>
                        <p class="text-sm text-gray-500 mb-4">Add or edit up to 8 prizes for the spin wheel.</p>
                         <!-- MODIFIED: Live Preview and Controls -->
                        <div class="flex flex-col md:flex-row gap-8 items-center justify-center">
                            <div id="spin-wheel-preview-area">
                                <!-- SVG Preview will be rendered here -->
                            </div>
                        </div>
                        <div id="spin-wheel-prizes-list" class="space-y-4 my-6"></div>
                        <form id="spin-wheel-prize-form" class="space-y-4 p-4 border rounded-md bg-gray-50">
                            <input type="hidden" id="spin-prize-edit-index-input">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="admin-label">Prize Name</label>
                                    <input type="text" id="spin-prize-name-input" class="admin-input" placeholder="e.g., 10% OFF">
                                </div>
                                <div>
                                    <label class="admin-label">Segment Color</label>
                                    <input type="color" id="spin-prize-color-input" class="admin-input" value="#3b82f6">
                                </div>
                                <div>
                                    <label class="admin-label">Text Color</label>
                                    <input type="color" id="spin-prize-text-color-input" class="admin-input" value="#ffffff">
                                </div>
                            </div>
                            <div>
                                <label class="admin-label">Prize Image URL (Optional)</label>
                                <div class="flex items-center gap-4">
                                    <input type="text" id="spin-prize-image-input" class="admin-input" placeholder="https://...">
                                    <label class="upload-btn !py-2.5"><input type="file" class="hidden file-input" data-target="spin-prize-image-input">Upload</label>
                                </div>
                            </div>
                             <div>
                                <label class="admin-label">Winning Message (Optional)</label>
                                <input type="text" id="spin-prize-message-input" class="admin-input" placeholder="e.g., Your code is SAVE10!">
                            </div>
                            <div class="flex gap-4">
                                <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Save Prize</button>
                                <button type="button" id="cancel-edit-prize-btn" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300 hidden">Cancel Edit</button>
                            </div>
                        </form>
                     </div>
                     <div class="admin-section">
                        <h3>Winners / Leads</h3>
                        <div id="spin-wheel-winners-list" class="space-y-2">
                           <p class="text-gray-500">No winners yet.</p>
                        </div>
                     </div>
                </div>
                
                <div id="admin-tab-reviews-manage" class="admin-tab-content hidden">
                    <div class="admin-section">
                        <h3>Reviews Section Animation</h3>
                        <div class="flex items-center gap-2 mb-4">
                            <input type="checkbox" id="reviews-animation-enabled-input" class="h-4 w-4">
                            <label class="admin-label !mb-0" for="reviews-animation-enabled-input">Enable Marquee Animation</label>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="admin-label" for="reviews-animation-direction-select">Direction</label>
                                <select id="reviews-animation-direction-select" class="admin-select">
                                    <option value="marquee-scroll-left">Left</option>
                                    <option value="marquee-scroll-right">Right</option>
                                </select>
                            </div>
                            <div>
                                <label class="admin-label" for="reviews-animation-speed-input">Speed (in seconds)</label>
                                <input type="number" id="reviews-animation-speed-input" class="admin-input" step="1" value="40">
                            </div>
                        </div>
                    </div>
                     <!-- NEW: Floating Reviews Button Customization -->
                    <div class="admin-section">
                        <h3>Floating Button & Modal</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                            <div class="md:col-span-2">
                                <p class="admin-label mb-2">Button Colors</p>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="admin-label !text-xs" for="reviews-btn-color1-input">Gradient Start</label>
                                        <input type="color" id="reviews-btn-color1-input" class="admin-input">
                                    </div>
                                    <div>
                                        <label class="admin-label !text-xs" for="reviews-btn-color2-input">Gradient End</label>
                                        <input type="color" id="reviews-btn-color2-input" class="admin-input">
                                    </div>
                                     <div class="col-span-2">
                                        <label class="admin-label !text-xs" for="reviews-btn-text-color-input">Text Color</label>
                                        <input type="color" id="reviews-btn-text-color-input" class="admin-input">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <p class="admin-label text-center">Live Preview</p>
                                <button id="floating-reviews-btn-preview" class="mx-auto w-40 h-10 rounded-md font-bold flex items-center justify-center gap-2" disabled>
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.957a1 1 0 00.95.69h4.162c.969 0 1.371 1.24.588 1.81l-3.368 2.448a1 1 0 00-.364 1.118l1.287 3.957c.3.921-.755 1.688-1.539 1.118l-3.368-2.448a1 1 0 00-1.175 0l-3.368 2.448c-.784.57-1.838-.197-1.539-1.118l1.287-3.957a1 1 0 00-.364-1.118L2.07 9.384c-.783-.57-.38-1.81.588-1.81h4.162a1 1 0 00.95-.69L9.049 2.927z"></path></svg>
                                    <span>Reviews</span>
                                </button>
                            </div>
                        </div>
                         <div class="mt-4">
                            <label class="admin-label" for="all-reviews-header-image-input">Reviews Modal Header Image URL</label>
                            <input type="text" id="all-reviews-header-image-input" class="admin-input">
                         </div>
                         <!-- NEW: Review Modal Button URL -->
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div>
                                <label class="admin-label" for="all-reviews-url-input">Button URL (Optional)</label>
                                <input type="text" id="all-reviews-url-input" class="admin-input" placeholder="https://...">
                            </div>
                            <div>
                                <label class="admin-label" for="all-reviews-url-text-input">Button Text</label>
                                <input type="text" id="all-reviews-url-text-input" class="admin-input" placeholder="e.g., Shop Collection">
                            </div>
                        </div>
                    </div>
                     <!-- NEW: Review Card Styling -->
                    <div class="admin-section">
                        <h3>Review Card Styling</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="admin-label" for="review-font-family-select">Quote Font</label>
                                <select id="review-font-family-select" class="admin-select">
                                    <option value="'Inter', sans-serif">Standard (Inter)</option>
                                    <option value="'Playfair Display', serif">Elegant (Playfair)</option>
                                    <option value="'Roboto Mono', monospace">Mono (Roboto Mono)</option>
                                    <option value="'Bebas Neue', sans-serif">Pricedown (Bebas)</option>
                                    <option value="'Orbitron', sans-serif">Sci-Fi (Orbitron)</option>
                                    <option value="'Anton', sans-serif">Anton</option>
                                    <option value="'Fredoka', sans-serif">Fredoka</option>
                                    <option value="'Carlito', sans-serif">Calibri (Carlito)</option>
                                    <option value="'Audiowide', sans-serif">Horizon (Audiowide)</option>
                                </select>
                                <label class="admin-label mt-4" for="review-font-weight-select">Quote Weight</label>
                                <select id="review-font-weight-select" class="admin-select">
                                    <option value="400">Normal</option>
                                    <option value="700">Bold</option>
                                </select>
                                <div class="grid grid-cols-2 gap-4 mt-4">
                                     <div>
                                        <label class="admin-label">Quote Color</label>
                                        <input type="color" id="review-text-color-input" class="admin-input">
                                    </div>
                                    <div>
                                        <label class="admin-label">Font Size (<span id="review-font-size-val">16</span>px)</label>
                                        <input type="range" id="review-font-size-input" class="w-full" min="12" max="24" value="16">
                                    </div>
                                </div>
                            </div>
                            <div class="p-4 border rounded-md bg-white flex items-center justify-center">
                                <div id="review-style-preview" class="text-center">
                                    <p class="italic">"This is a sample review quote to show the new style."</p>
                                    <p class="font-bold mt-2">- Sample Customer</p>
                                </div>
                            </div>
                        </div>
                    </div>
                     <div id="admin-reviews-list" class="space-y-4 mb-6"></div>
                    <div class="admin-section">
                        <h3 id="review-form-title">Add New Review</h3>
                        <form id="review-form" class="space-y-4">
                            <input type="hidden" id="review-id-input">
                            <div>
                                <label class="admin-label" for="review-name-input">Customer Name</label>
                                <input type="text" id="review-name-input" class="admin-input" required>
                            </div>
                             <div>
                                <label class="admin-label" for="review-quote-input">Quote / Review Text</label>
                                <textarea id="review-quote-input" class="admin-textarea" rows="3" required></textarea>
                            </div>
                            <div>
                                <label class="admin-label" for="review-rating-input">Rating (1-5)</label>
                                <input type="number" id="review-rating-input" class="admin-input" min="1" max="5" required>
                            </div>
                            <div class="flex space-x-4">
                                <button type="submit" class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Save Review</button>
                                <button type="button" id="cancel-edit-review-btn" class="w-full px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300 hidden">Cancel Edit</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div id="admin-tab-coupons" class="admin-tab-content hidden">
                    <div id="admin-coupons-list" class="space-y-4 mb-6"></div>
                    <div class="admin-section">
                        <h3 id="coupon-form-title">Add New Coupon</h3>
                        <form id="coupon-form" class="space-y-4">
                            <input type="hidden" id="coupon-id-input">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="admin-label" for="coupon-code-input">Coupon Code</label>
                                    <input type="text" id="coupon-code-input" class="admin-input" placeholder="e.g., SALE10" required>
                                </div>
                                <div>
                                    <label class="admin-label" for="coupon-type-select">Discount Type</label>
                                    <select id="coupon-type-select" class="admin-select" required>
                                        <option value="percent">Percentage</option>
                                        <option value="fixed">Fixed Amount (Rs.)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="admin-label" for="coupon-value-input">Value</label>
                                    <input type="number" id="coupon-value-input" class="admin-input" placeholder="e.g., 10 or 500" required>
                                </div>
                            </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                <div>
                                    <label class="admin-label" for="coupon-total-uses-input">Total Usage Limit</label>
                                    <input type="number" id="coupon-total-uses-input" class="admin-input" placeholder="e.g., 100" min="0">
                                </div>
                                <div>
                                    <label class="admin-label" for="coupon-per-user-uses-input">Uses Per Customer</label>
                                    <input type="number" id="coupon-per-user-uses-input" class="admin-input" placeholder="e.g., 1" min="0">
                                </div>
                             </div>
                            <div class="flex space-x-4 mt-4">
                                <button type="submit" class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Save Coupon</button>
                                <button type="button" id="cancel-edit-coupon-btn" class="w-full px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300 hidden">Cancel Edit</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="admin-tab-whatsapp" class="admin-tab-content hidden">
                    <div class="admin-section">
                        <h3>WhatsApp Message Editor</h3>
                        <p class="text-sm text-gray-600 mb-4">Customize the message you receive for new orders and when contacting customers from the Orders tab. Use placeholders to automatically include order details.</p>
                        
                        <div class="p-4 bg-gray-100 rounded-md mb-4 text-sm">
                            <p><strong>Placeholders:</strong></p>
                            <ul class="list-disc list-inside grid grid-cols-2 gap-x-4 gap-y-1">
                                <li><code>{orderNumber}</code></li>
                                <li><code>{customerName}</code></li>
                                <li><code>{phone}</code></li>
                                <li><code>{shippingAddress}</code></li>
                                <li><code>{orderItems}</code></li>
                                <li><code>{subtotal}</code></li>
                                <li><code>{discountInfo}</code></li>
                                <li><code>{deliveryCharges}</code></li>
                                <li><code>{total}</code></li>
                                <li><code>{paymentMethod}</code></li>
                                <li><code>{storeLogoUrl}</code></li>
                            </ul>
                        </div>
                        
                        <label for="whatsapp-message-template" class="admin-label">Customer Checkout Message Template</label>
                        <textarea id="whatsapp-message-template" class="admin-textarea font-mono" rows="10"></textarea>
                        <!-- NEW: Live Preview for Customer Message -->
                        <div id="whatsapp-customer-preview" class="whatsapp-preview-container"></div>

                        <!-- NEW: Contact Customer Template -->
                        <label for="whatsapp-contact-template" class="admin-label mt-6">"Contact Customer" Message Template (from Orders tab)</label>
                        <textarea id="whatsapp-contact-template" class="admin-textarea font-mono" rows="6"></textarea>
                        <!-- NEW: Live Preview for Admin Contact Message -->
                        <div id="whatsapp-admin-preview" class="whatsapp-preview-container"></div>
                    </div>
                </div>

                <div id="admin-tab-footer" class="admin-tab-content hidden">
                     <div class="admin-section">
                        <h3>Footer Styling & Content</h3>
                         <label class="admin-label" for="footer-bg-color-input">Footer Background Color</label>
                        <input type="color" id="footer-bg-color-input" class="admin-input" value="#1f2937">
                        <label class="admin-label mt-4" for="footer-store-locator-input">Store Locator URL</label>
                        <input type="text" id="footer-store-locator-input" class="admin-input mb-4">
                        <h3>Contact Information</h3>
                         <label class="admin-label" for="footer-phone-input">Phone Number</label>
                        <input type="text" id="footer-phone-input" class="admin-input mb-2">
                         <label class="admin-label" for="footer-email-input">Email</label>
                        <input type="email" id="footer-email-input" class="admin-input mb-2">
                         <label class="admin-label" for="footer-address-input">Address</label>
                        <input type="text" id="footer-address-input" class="admin-input mb-4">

                        <h3>Social Media Links</h3>
                         <div>
                            <label class="admin-label" for="footer-tiktok-input">Tiktok Handle</label>
                            <input type="text" id="footer-tiktok-input" class="admin-input mb-2" placeholder="yourhandle (without @)">
                            <label class="admin-label" for="footer-tiktok-icon-input">Tiktok Icon (URL/SVG)</label>
                            <input type="text" id="footer-tiktok-icon-input" class="admin-input" placeholder="Leave blank for default">
                        </div>
                         <div class="mt-4">
                            <label class="admin-label" for="footer-instagram-input">Instagram Handle</label>
                            <input type="text" id="footer-instagram-input" class="admin-input mb-2" placeholder="yourhandle">
                            <label class="admin-label" for="footer-instagram-icon-input">Instagram Icon (URL/SVG)</label>
                            <input type="text" id="footer-instagram-icon-input" class="admin-input" placeholder="Leave blank for default">
                        </div>
                         <div class="mt-4">
                            <label class="admin-label" for="footer-facebook-input">Facebook Handle</label>
                            <input type="text" id="footer-facebook-input" class="admin-input mb-2" placeholder="yourhandle">
                            <label class="admin-label" for="footer-facebook-icon-input">Facebook Icon (URL/SVG)</label>
                            <input type="text" id="footer-facebook-icon-input" class="admin-input" placeholder="Leave blank for default">
                        </div>
                    </div>
                </div>
                
                <!-- NEW: Pages Tab -->
                <div id="admin-tab-pages" class="admin-tab-content hidden">
                    <div class="admin-section">
                        <h3>Shipping Policy Page</h3>
                        <label class="admin-label" for="shipping-policy-title-input">Policy Modal Title</label>
                        <input type="text" id="shipping-policy-title-input" class="admin-input mb-2">
                        <label class="admin-label" for="shipping-policy-image-input">Header Image URL (Optional)</label>
                        <div class="flex items-center gap-4 mb-4">
                            <input type="text" id="shipping-policy-image-input" class="admin-input">
                            <label class="upload-btn !py-2.5"><input type="file" class="hidden file-input" data-target="shipping-policy-image-input">Upload</label>
                        </div>
                        <label class="admin-label" for="shipping-policy-content-input">Policy Content</label>
                        <div class="editor-toolbar" data-target="shipping-policy-content-input"><button type="button"><b>B</b></button><button type="button"><i>I</i></button></div>
                        <textarea id="shipping-policy-content-input" class="admin-textarea has-toolbar" rows="8" placeholder="Enter your shipping policy details here..."></textarea>
                    </div>
                    <div class="admin-section">
                        <h3>FAQ Page</h3>
                        <label class="admin-label" for="faq-title-input">FAQ Modal Title</label>
                        <input type="text" id="faq-title-input" class="admin-input mb-2">
                        <label class="admin-label" for="faq-image-input">Header Image URL (Optional)</label>
                         <div class="flex items-center gap-4 mb-4">
                            <input type="text" id="faq-image-input" class="admin-input">
                            <label class="upload-btn !py-2.5"><input type="file" class="hidden file-input" data-target="faq-image-input">Upload</label>
                        </div>
                        <label class="admin-label" for="faq-content-input">FAQ Content</label>
                        <div class="editor-toolbar" data-target="faq-content-input"><button type="button"><b>B</b></button><button type="button"><i>I</i></button></div>
                        <textarea id="faq-content-input" class="admin-textarea has-toolbar" rows="8" placeholder="Enter your FAQ details here..."></textarea>
                    </div>
                    <div class="admin-section">
                        <h3>About Us Page</h3>
                        <label class="admin-label" for="about-us-title-input">About Us Modal Title</label>
                        <input type="text" id="about-us-title-input" class="admin-input mb-2">
                        <label class="admin-label" for="about-us-image-input">Header Image URL (Optional)</label>
                         <div class="flex items-center gap-4 mb-4">
                            <input type="text" id="about-us-image-input" class="admin-input">
                            <label class="upload-btn !py-2.5"><input type="file" class="hidden file-input" data-target="about-us-image-input">Upload</label>
                        </div>
                        <label class="admin-label" for="about-us-content-input">About Us Content</label>
                        <div class="editor-toolbar" data-target="about-us-content-input"><button type="button"><b>B</b></button><button type="button"><i>I</i></button></div>
                        <textarea id="about-us-content-input" class="admin-textarea has-toolbar" rows="8" placeholder="Enter your About Us details here..."></textarea>
                    </div>
                     <!-- MODIFIED: Payment Methods Editor -->
                    <div class="admin-section">
                        <h3>Payment Methods Page</h3>
                        <label class="admin-label" for="payment-methods-title-input">Modal Title</label>
                        <input type="text" id="payment-methods-title-input" class="admin-input mb-4" value="Accepted Payment Methods">
                        
                        <label class="admin-label" for="payment-methods-image-input">Header Image URL (Optional)</label>
                        <div class="flex items-center gap-4 mb-4">
                            <input type="text" id="payment-methods-image-input" class="admin-input">
                            <label class="upload-btn"><input type="file" class="hidden file-input" data-target="payment-methods-image-input">Upload</label>
                        </div>

                        <div id="payment-methods-list" class="space-y-4 mb-4"></div>
                        <button type="button" id="add-payment-method-btn" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-sm">Add Payment Method</button>
                    </div>
                </div>

                <div id="admin-tab-settings" class="admin-tab-content hidden">
                    <div class="admin-section">
                        <h3>SEO & Branding</h3>
                        <!-- NEW: Branding inputs -->
                        <label class="admin-label" for="tab-title-input">Browser Tab Title</label>
                        <input type="text" id="tab-title-input" class="admin-input mb-4" placeholder="e.g., My Awesome Store">
                        <label class="admin-label" for="favicon-url-input">Favicon URL</label>
                        <input type="text" id="favicon-url-input" class="admin-input mb-4" placeholder="https://example.com/icon.png">
                        
                        <label class="admin-label" for="meta-keywords-input">Meta Keywords (comma-separated)</label>
                        <textarea id="meta-keywords-input" class="admin-textarea mb-4" rows="2" placeholder="e.g., baby clothes, newborn, onesie, karachi"></textarea>
                        <label class="admin-label" for="meta-description-input">Meta Description</label>
                        <textarea id="meta-description-input" class="admin-textarea" rows="3" placeholder="A brief summary of your store."></textarea>
                        
                        <!-- NEW: Live Site SEO Preview -->
                        <div class="seo-preview-container mt-4">
                            <h4 class="font-semibold text-sm mb-2">Google Search Preview</h4>
                            <div><a href="#" class="seo-preview-title" id="site-seo-preview-title" onclick="return false;">Your Site Title</a></div>
                            <div class="seo-preview-url" id="site-seo-preview-url">https://yourstore.com</div>
                            <div class="seo-preview-description" id="site-seo-preview-description">Your site's meta description will appear here. Aim for around 155 characters.</div>
                        </div>
                    </div>
                    <!-- NEW: Icon Customization Section -->
                    <div class="admin-section">
                        <h3>Icon Customization</h3>
                        <p class="text-xs text-gray-500 mb-2">Provide a URL for an image (PNG, JPG, GIF) or an SVG file. Recommended size: 24x24 pixels.</p>
                        <label class="admin-label mt-4">Cart Icon URL</label>
                        <div class="flex items-center gap-4">
                            <input type="text" id="cart-icon-svg-input" class="admin-input">
                            <label class="upload-btn"><input type="file" class="hidden file-input" data-target="cart-icon-svg-input">Upload</label>
                        </div>
                        <label class="admin-label mt-4">Admin Panel Icon URL</label>
                        <div class="flex items-center gap-4">
                            <input type="text" id="admin-icon-svg-input" class="admin-input">
                            <label class="upload-btn"><input type="file" class="hidden file-input" data-target="admin-icon-svg-input">Upload</label>
                        </div>
                        <label class="admin-label mt-4">User/Login Icon URL</label>
                        <div class="flex items-center gap-4">
                            <input type="text" id="user-icon-svg-input" class="admin-input">
                            <label class="upload-btn"><input type="file" class="hidden file-input" data-target="user-icon-svg-input">Upload</label>
                        </div>
                    </div>
                     <div class="admin-section">
                        <h3>Admin Management</h3>
                        <div id="admin-users-list-container" class="space-y-2 mb-4">
                            <!-- Admin list will be rendered here -->
                        </div>
                        <form id="add-admin-form" class="flex items-center gap-2">
                            <input type="email" id="new-admin-email-input" class="admin-input" placeholder="Enter new admin's email" required>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Add</button>
                        </form>
                    </div>
                    <div class="admin-section">
                        <h3>Admin Password</h3>
                        <form id="password-change-form" class="space-y-4">
                             <div>
                                <label class="admin-label" for="current-password-input">Current Password</label>
                                <input type="password" id="current-password-input" class="admin-input" required>
                            </div>
                             <div>
                                <label class="admin-label" for="new-password-input">New Password</label>
                                <input type="password" id="new-password-input" class="admin-input" required>
                            </div>
                             <div>
                                <label class="admin-label" for="confirm-password-input">Confirm New Password</label>
                                <input type="password" id="confirm-password-input" class="admin-input" required>
                            </div>
                            <button type="submit" class="px-4 py-2 bg-black text-white rounded-md hover:bg-gray-800">Change Password</button>
                        </form>
                    </div>
                    <div class="admin-section">
                         <h3>Business Information</h3>
                         <label class="admin-label" for="owner-whatsapp-input">Owner's WhatsApp Number (for orders)</label>
                         <input type="text" id="owner-whatsapp-input" class="admin-input" placeholder="e.g., 923012725158">
                    </div>
                </div>
            </div>
            <div class="p-6 bg-gray-50 border-t flex justify-end">
                <button id="save-settings-btn" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- MODIFIED: PRODUCT DETAIL MODAL LAYOUT -->
    <div id="product-detail-modal" class="modal-overlay">
        <div class="modal-content max-w-5xl bg-white rounded-lg shadow-2xl flex flex-col md:flex-row p-0 overflow-hidden">
            <button id="product-detail-close-btn" class="absolute top-4 right-5 text-gray-400 hover:text-black text-4xl z-20">&times;</button>
            <!-- Left Side: Media -->
            <div class="w-full md:w-5/12 p-4 sm:p-8 flex flex-col">
                 <div id="product-detail-media-container" class="relative w-full aspect-square">
                    <div id="product-detail-media-display" class="w-full h-full rounded-lg flex items-center justify-center overflow-hidden bg-gray-100">
                        <!-- Main media injected here -->
                    </div>
                     <div id="product-detail-dots" class="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2">
                        <!-- Dots injected here -->
                    </div>
                </div>
                <div id="product-detail-thumbnails" class="flex gap-3 mt-4 justify-center overflow-x-auto">
                    <!-- Thumbnails injected here -->
                </div>
            </div>
            <!-- Right Side: Details -->
            <div class="w-full md:w-7/12 p-4 sm:p-8 flex flex-col overflow-y-auto">
                <div class="flex items-center gap-4 text-sm text-gray-500 mb-2">
                    <div id="product-detail-rating-display" class="flex items-center gap-2"></div>
                    <div class="border-l h-4"></div>
                    <div id="product-detail-view-count" class="flex items-center gap-1.5">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                        <span></span>
                    </div>
                </div>
                <h2 id="product-detail-name" class="font-serif-elegant text-3xl md:text-4xl font-bold text-gray-800">Product Name</h2>
                <div id="product-detail-stock-status" class="stock-status-container justify-start mt-2"></div>
                <p id="product-detail-subtitle" class="text-lg text-gray-500 mt-4">Vital nutrition for your little one's daily lifestyle and optimal health.</p>

                <div id="product-detail-features" class="space-y-3 my-6 text-gray-700">
                    <!-- Features injected here -->
                </div>

                <!-- MODIFIED: Container for variants in product detail view -->
                <div id="product-detail-variants-container" class="mb-6">
                    <!-- Variants like color swatches will be injected here by JS -->
                </div>

                <div id="product-detail-purchase-box" class="bg-gray-50 p-6 rounded-lg border">
                    <div id="product-detail-sale-countdown" class="hidden mb-4 text-center"></div>
                    <div class="flex justify-between items-baseline mb-4">
                        <span class="font-semibold text-lg">Total</span>
                        <div id="product-detail-price" class="text-right">
                            <span class="text-2xl font-bold price-sale">Rs. 0</span>
                            <span class="text-md line-through price-original ml-2">Rs. 0</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                         <div id="product-detail-quantity-selector" class="flex items-center border rounded-md">
                            <button class="px-3 py-2 text-lg" data-change="-1">-</button>
                            <span class="px-4 text-lg font-semibold">1</span>
                            <button class="px-3 py-2 text-lg" data-change="1">+</button>
                        </div>
                        <button id="product-detail-add-to-cart-btn" class="premium-btn w-full !rounded-md">Add to Cart</button>
                    </div>
                </div>
                
                <div class="mt-6 pt-6 border-t">
                    <h3 class="font-bold text-md mb-2 text-gray-800">Product Details</h3>
                    <div id="product-detail-description" class="text-gray-600 text-sm space-y-3"></div>
                </div>

                <div id="product-rating-container" class="mt-auto pt-6 border-t flex-shrink-0">
                    <h3 class="font-bold text-md mb-2">Rate This Product</h3>
                    <div id="rating-login-prompt" class="hidden text-sm text-gray-600">Please <button type="button" id="rating-login-link" class="underline font-bold">login</button> to leave a rating.</div>
                    <div id="rating-input-area">
                        <div class="star-rating-input">
                            <input type="radio" name="rating" id="star5" value="5"><label for="star5"></label>
                            <input type="radio" name="rating" id="star4" value="4"><label for="star4"></label>
                            <input type="radio" name="rating" id="star3" value="3"><label for="star3"></label>
                            <input type="radio" name="rating" id="star2" value="2"><label for="star2"></label>
                            <input type="radio" name="rating" id="star1" value="1"><label for="star1"></label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODIFIED: Cart Modal with premium styling -->
    <div id="cart-modal" class="modal-overlay cart-view">
        <div class="modal-content cart-panel w-full max-w-lg h-full flex flex-col">
            <div class="p-6 border-b flex justify-between items-center bg-white">
                 <div class="flex items-center gap-4">
                    <img id="cart-modal-logo" src="" alt="Logo" class="h-10 w-auto hidden">
                    <h2 class="text-2xl font-bold">Your Cart</h2>
                 </div>
                 <button id="cart-close-btn" class="text-gray-500 hover:text-black text-3xl">&times;</button>
            </div>
            <div id="cart-items-container" class="p-6 flex-grow overflow-y-auto"></div>
            <div class="p-6 bg-white border-t-2 shadow-[0_-4px_15px_rgba(0,0,0,0.05)]">
                <div class="mb-4">
                    <div class="flex">
                        <input type="text" id="discount-code-input" placeholder="Discount Code" class="checkout-input rounded-r-none">
                        <button id="apply-discount-btn" class="px-4 py-2 bg-gray-800 text-white rounded-r-md hover:bg-black secondary-btn">Apply</button>
                    </div>
                    <p id="discount-message" class="text-sm mt-2"></p>
                </div>
                <div id="cart-summary" class="space-y-2 text-gray-700">
                    <div class="flex justify-between"><span>Subtotal</span><span id="cart-subtotal">Rs. 0</span></div>
                    <div class="flex justify-between"><span>Discount</span><span id="cart-discount">-Rs. 0</span></div>
                    <div class="flex justify-between"><span>Delivery</span><span id="cart-delivery">Rs. 0</span></div>
                    <div class="flex justify-between font-bold text-lg border-t pt-2 mt-2"><span>Total</span><span id="cart-total">Rs. 0</span></div>
                </div>
                <button id="proceed-to-checkout-btn" class="w-full mt-6 premium-btn" disabled>Proceed to Checkout</button>
            </div>
        </div>
    </div>
    
    <div id="checkout-modal" class="modal-overlay">
        <div class="modal-content max-w-2xl flex flex-col">
            <div class="p-6 border-b flex justify-between items-center"><h2 class="text-2xl font-bold">Checkout</h2><button id="checkout-close-btn" class="text-gray-500 hover:text-black text-3xl">&times;</button></div>
            <div class="p-8 flex-grow overflow-y-auto">
                <form id="checkout-form" class="space-y-8">
                    <div>
                        <h3 class="text-lg font-medium mb-4">Shipping Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label><input type="text" id="name" name="name" class="checkout-input" required></div>
                            <div><label for="phone" class="block text-sm font-medium text-gray-700 mb-1">WhatsApp Number (e.g., 921234567890)</label><input type="tel" id="phone" name="phone" class="checkout-input" required></div>
                        </div>
                        <div class="mt-6"><label for="address" class="block text-sm font-medium text-gray-700 mb-1">Street Address</label><input type="text" id="address" name="address" class="checkout-input" required></div>
                        <div class="mt-6"><label for="city" class="block text-sm font-medium text-gray-700 mb-1">City</label><input type="text" id="city" name="city" class="checkout-input" required></div>
                    </div>
                    <!-- NEW: Payment Method Section -->
                    <div>
                         <h3 class="text-lg font-medium mb-4">Payment Method</h3>
                         <div class="space-y-4">
                            <div>
                                <input type="radio" name="paymentMethod" id="payment-cod" value="Cash on Delivery" class="payment-method-input" checked required>
                                <label for="payment-cod" class="payment-method-option">
                                    <span class="font-bold">Cash on Delivery</span>
                                    <p class="text-sm text-gray-600">Pay with cash upon delivery.</p>
                                </label>
                            </div>
                            <div>
                                <input type="radio" name="paymentMethod" id="payment-advanced" value="Advanced Payment" class="payment-method-input" required>
                                <label for="payment-advanced" class="payment-method-option">
                                     <span class="font-bold">Advanced Payment</span>
                                     <p class="text-sm text-gray-600">Pay via Bank Transfer, EasyPaisa, or JazzCash.</p>
                                </label>
                            </div>
                         </div>
                    </div>
                </form>
            </div>
            <div class="p-6 bg-gray-50 border-t flex justify-end">
                <button type="submit" form="checkout-form" class="premium-btn w-full md:w-auto">Place Order</button>
            </div>
        </div>
    </div>
    <div id="sale-popup-modal" class="modal-overlay">
        <div class="modal-content max-w-lg relative bg-white rounded-lg shadow-lg overflow-hidden flex flex-col">
             <button id="sale-popup-close-btn" class="absolute top-2 right-2 text-gray-500 hover:text-black text-3xl z-10">&times;</button>
             <img id="sale-popup-image" src="" alt="Sale">
             <div class="p-8 text-center">
                 <h2 id="sale-popup-title" class="text-3xl font-bold mb-4"></h2>
                 <p id="sale-popup-text" class="text-gray-600 mb-6"></p>
                 <a href="#featured" id="sale-popup-btn" class="inline-block bg-black text-white px-8 py-3 rounded-md hover:bg-gray-800 transition">Shop Now</a>
             </div>
        </div>
    </div>
     <div id="size-guide-modal" class="modal-overlay">
        <div class="modal-content max-w-lg relative bg-white rounded-lg shadow-lg p-8">
             <button id="size-guide-close-btn" class="absolute top-2 right-2 text-gray-500 hover:text-black text-3xl z-10">&times;</button>
            <h2 class="text-2xl font-bold mb-6 text-center">Size Guide</h2>
            <table class="w-full text-left">
                <thead><tr class="border-b"><th class="p-2">Size</th><th class="p-2">Weight (kg)</th><th class="p-2">Height (cm)</th></tr></thead>
                <tbody>
                    <tr class="border-b"><td class="p-2">Newborn (NB)</td><td class="p-2">2-4 kg</td><td class="p-2">Up to 55 cm</td></tr>
                    <tr class="border-b"><td class="p-2">0-3 Months</td><td class="p-2">4-6 kg</td><td class="p-2">55-61 cm</td></tr>
                    <tr class="border-b"><td class="p-2">3-6 Months</td><td class="p-2">6-8 kg</td><td class="p-2">61-67 cm</td></tr>
                    <tr class="border-b"><td class="p-2">6-9 Months</td><td class="p-2">8-9 kg</td><td class="p-2">67-72 cm</td></tr>
                    <tr><td class="p-2">9-12 Months</td><td class="p-2">9-10 kg</td><td class="p-2">72-78 cm</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    <div id="shipping-policy-modal" class="modal-overlay">
        <div class="modal-content max-w-2xl relative bg-white rounded-lg shadow-lg p-8 flex flex-col">
             <button id="shipping-policy-close-btn" class="absolute top-4 right-4 text-gray-500 hover:text-black text-3xl z-10">&times;</button>
            <h2 id="shipping-policy-modal-title" class="text-2xl font-bold mb-6 text-center">Shipping Policy</h2>
            <img id="shipping-policy-modal-image" src="" alt="Policy Image" class="w-full h-48 object-cover rounded-md mb-6 hidden">
            <div id="shipping-policy-modal-content" class="text-gray-700 overflow-y-auto"></div>
        </div>
    </div>
    <div id="faq-modal" class="modal-overlay">
        <div class="modal-content max-w-2xl relative bg-white rounded-lg shadow-lg p-8 flex flex-col">
             <button id="faq-close-btn" class="absolute top-4 right-4 text-gray-500 hover:text-black text-3xl z-10">&times;</button>
            <h2 id="faq-modal-title" class="text-2xl font-bold mb-6 text-center">Frequently Asked Questions</h2>
            <img id="faq-modal-image" src="" alt="FAQ Image" class="w-full h-48 object-cover rounded-md mb-6 hidden">
            <div id="faq-modal-content" class="text-gray-700 overflow-y-auto"></div>
        </div>
    </div>
    <!-- NEW: About Us Modal -->
    <div id="about-us-modal" class="modal-overlay">
        <div class="modal-content max-w-2xl relative bg-white rounded-lg shadow-lg p-8 flex flex-col">
             <button id="about-us-close-btn" class="absolute top-4 right-4 text-gray-500 hover:text-black text-3xl z-10">&times;</button>
            <h2 id="about-us-modal-title" class="text-2xl font-bold mb-6 text-center">About Us</h2>
            <img id="about-us-modal-image" src="" alt="About Us Image" class="w-full h-48 object-cover rounded-md mb-6 hidden">
            <div id="about-us-modal-content" class="text-gray-700 overflow-y-auto"></div>
        </div>
    </div>
    <!-- NEW: Payment Methods Modal -->
    <div id="payment-methods-modal" class="modal-overlay">
        <div class="modal-content max-w-3xl relative bg-white rounded-lg shadow-lg p-8 flex flex-col">
             <button id="payment-methods-close-btn" class="absolute top-4 right-4 text-gray-500 hover:text-black text-3xl z-10">&times;</button>
            <h2 id="payment-methods-modal-title" class="text-2xl font-bold mb-6 text-center">Payment Methods</h2>
            <img id="payment-methods-modal-image" src="" alt="Payment Methods Header" class="w-full h-48 object-cover rounded-md mb-6 hidden">
            <div id="payment-methods-modal-content" class="grid grid-cols-2 md:grid-cols-3 gap-4 overflow-y-auto"></div>
        </div>
    </div>
    <!-- NEW: Payment Method Detail Modal -->
    <div id="payment-detail-modal" class="modal-overlay">
        <div class="modal-content max-w-md relative bg-white rounded-lg shadow-lg p-8 text-center">
             <button id="payment-detail-close-btn" class="absolute top-2 right-2 text-gray-500 hover:text-black text-3xl">&times;</button>
            <img id="payment-detail-image" src="" class="w-full max-w-[200px] mx-auto object-contain rounded-md mb-4">
            <h3 id="payment-detail-title" class="text-xl font-bold mb-4"></h3>
            <div id="payment-detail-details" class="text-left bg-gray-100 p-4 rounded-md whitespace-pre-wrap font-mono"></div>
        </div>
    </div>


    <!-- MODIFIED: Spin Wheel Modal layout -->
    <div id="spin-wheel-modal" class="modal-overlay">
        <div class="modal-content max-w-4xl relative bg-white rounded-lg shadow-lg p-8 flex flex-col md:flex-row items-center gap-8">
            <button id="spin-wheel-close-btn" class="absolute top-2 right-2 text-gray-500 hover:text-black text-3xl z-10">&times;</button>
            
            <!-- MODIFIED: Game Area Container with fixed width -->
            <div class="w-full md:w-auto md:flex-shrink-0 flex items-center justify-center p-4">
                <!-- Spin Wheel Game -->
                <div id="spin-wheel-game-area" class="relative hidden items-center justify-center">
                    <!-- SVG wheel is injected here, pointer and overlay are placed on top -->
                </div>
                <!-- Crate Opening Game -->
                <div id="crate-game-area" class="relative hidden">
                    <div id="crate-image-container">
                        <img id="crate-image-closed" src="https://i.imgur.com/gO2nB5v.png" alt="Closed Crate">
                        <img id="crate-image-open" src="https://i.imgur.com/3w3e6Wg.png" alt="Open Crate">
                    </div>
                </div>
            </div>

            <!-- Right Side: Form -->
            <div class="w-full md:w-1/2 text-center">
                <img id="spin-wheel-logo" src="" alt="Logo" class="mx-auto mb-4 h-24 w-auto max-w-[150px] rounded-lg">
                <h2 id="luck-game-title" class="text-3xl font-bold text-orange-500">Try Your Luck</h2>
                <p class="text-gray-600 my-4">Enter your details for a chance to win a surprise gift!</p>
                <form id="spin-wheel-user-form" class="space-y-4">
                    <input type="text" id="spin-user-name" class="admin-input" placeholder="Your Name" required>
                    <input type="tel" id="spin-user-phone" class="admin-input" placeholder="Your Phone Number" required>
                    <button id="spin-now-btn" type="submit" class="w-full py-3 bg-orange-600 text-white rounded-md hover:bg-orange-700 font-bold text-lg transition-all" disabled>Login to Play</button>
                </form>
                <div id="spin-timer-container" class="hidden text-center mt-4">
                    <p class="font-semibold text-gray-700 mb-2">You can play again in:</p>
                    <div class="countdown-container-outer justify-center">
                        <div class="timer-box"><span class="timer-digits" data-unit="days-spin">00</span><span class="timer-label">Days</span></div>
                        <div class="timer-box"><span class="timer-digits" data-unit="hours-spin">00</span><span class="timer-label">Hours</span></div>
                        <div class="timer-box"><span class="timer-digits" data-unit="minutes-spin">00</span><span class="timer-label">Minutes</span></div>
                        <div class="timer-box"><span class="timer-digits" data-unit="seconds-spin">00</span><span class="timer-label">Seconds</span></div>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-4">By entering your details, you agree to receive marketing messages from our store.</p>
            </div>
        </div>
    </div>
    <!-- MODIFIED: Spin Wheel Result Modal -->
    <div id="spin-result-modal" class="modal-overlay">
        <div class="modal-content max-w-md relative bg-white rounded-lg shadow-lg p-8 flex flex-col items-center text-center">
            <h2 id="spin-result-title" class="text-2xl font-bold text-yellow-500">Congratulations!</h2>
            <img id="spin-result-image" src="" alt="Prize Image" class="w-32 h-32 object-contain my-4 hidden">
            <p class="text-gray-600 mt-2 mb-4">You have won:</p>
            <p id="spin-result-prize" class="text-4xl font-bold bg-gray-100 px-6 py-4 rounded-lg mb-6"></p>
            <p id="spin-result-message" class="text-sm text-gray-600"></p>
            <button id="spin-result-close-btn" class="mt-6 w-full py-2 bg-gray-800 text-white rounded-md hover:bg-black">Awesome!</button>
        </div>
    </div>
    <!-- NEW: Review Submission Modal -->
    <div id="review-submission-modal" class="modal-overlay">
        <div class="modal-content p-8 max-w-lg relative">
           <button id="review-submission-close-btn" class="absolute top-2 right-2 text-gray-500 hover:text-black text-3xl">&times;</button>
           <h2 class="text-2xl font-bold mb-4">Write a Review</h2>
           <p class="text-gray-600 mb-6">Share your experience with other customers!</p>
           <form id="review-submission-form">
               <label for="review-submission-name" class="admin-label">Your Name</label>
               <input type="text" id="review-submission-name" class="admin-input mb-4" required>
               <label for="review-submission-quote" class="admin-label">Your Review</label>
               <textarea id="review-submission-quote" class="admin-textarea mb-4" rows="4" required></textarea>
               <label class="admin-label">Your Rating</label>
               <div class="star-rating-input mb-6">
                    <input type="radio" name="review-rating" id="sub-star5" value="5" required><label for="sub-star5"></label>
                    <input type="radio" name="review-rating" id="sub-star4" value="4"><label for="sub-star4"></label>
                    <input type="radio" name="review-rating" id="sub-star3" value="3"><label for="sub-star3"></label>
                    <input type="radio" name="review-rating" id="sub-star2" value="2"><label for="sub-star2"></label>
                    <input type="radio" name="review-rating" id="sub-star1" value="1"><label for="sub-star1"></label>
                </div>
               <button type="submit" class="w-full py-2 bg-black text-white rounded-md hover:bg-gray-800">Submit Review</button>
           </form>
       </div>
   </div>
   
    <!-- NEW: All Reviews Modal -->
    <div id="all-reviews-modal" class="modal-overlay">
        <div class="modal-content max-w-5xl flex flex-col">
            <div class="p-6 border-b flex justify-between items-center flex-shrink-0">
                <h2 class="text-2xl font-bold">Customer Reviews</h2>
                <button id="all-reviews-close-btn" class="text-gray-500 hover:text-black text-3xl">&times;</button>
            </div>
             <!-- NEW: Reviews Header Image -->
            <img id="all-reviews-header-image" src="" class="w-full h-48 object-cover flex-shrink-0 hidden">
            <div class="flex-grow overflow-y-auto relative">
                <div id="all-reviews-grid">
                    <!-- Reviews will be rendered here -->
                </div>
            </div>
            <div id="all-reviews-footer" class="p-4 border-t text-center flex-shrink-0 flex justify-center items-center gap-4">
                <button id="all-reviews-add-new-btn" class="category-btn">Write Your Own Review</button>
                <!-- Container for optional URL button -->
                <div id="all-reviews-url-container"></div>
            </div>
        </div>
    </div>

    <!-- NEW: Order Success Modal -->
    <div id="order-success-modal" class="modal-overlay">
        <div class="modal-content max-w-md relative bg-white rounded-lg shadow-lg p-8 text-center">
             <button id="order-success-close-btn" class="absolute top-2 right-2 text-gray-500 hover:text-black text-3xl">&times;</button>
            <img id="order-success-image" src="" class="w-full h-40 object-contain rounded-md mb-4">
            <div id="order-success-message" class="text-gray-700 text-lg"></div>
        </div>
    </div>
    
    <!-- NEW: Support Ticket Modal -->
    <div id="support-ticket-modal" class="modal-overlay">
        <div class="modal-content p-8 max-w-lg relative">
           <button id="support-ticket-close-btn" class="absolute top-2 right-2 text-gray-500 hover:text-black text-3xl">&times;</button>
           <h2 class="text-2xl font-bold mb-4">Create a Support Ticket</h2>
           <p class="text-gray-600 mb-6">Have a question? Let us know how we can help.</p>
           <form id="support-ticket-form">
                <label for="support-ticket-subject" class="admin-label">What is this about?</label>
                <select id="support-ticket-subject" class="admin-select mb-4" required>
                    <option value="">-- Select a Topic --</option>
                    <!-- Subjects will be dynamically populated here -->
                </select>
               <label for="support-ticket-query" class="admin-label">Your Message</label>
               <textarea id="support-ticket-query" class="admin-textarea mb-6" rows="5" placeholder="Please describe your issue in detail..." required></textarea>
               <button type="submit" class="w-full premium-btn !rounded-md">Submit Ticket</button>
           </form>
       </div>
   </div>


    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getFirestore, doc, getDoc, setDoc, collection, getDocs, 
            updateDoc, arrayUnion, onSnapshot, query, orderBy, Timestamp, writeBatch, where, collectionGroup, addDoc, arrayRemove, deleteDoc
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            GoogleAuthProvider, // NEW: Import Google Auth
            signInWithPopup,     // NEW: Import Popup Sign in
            updatePassword
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        // NEW: Import Storage modules
        import {
            getStorage,
            ref,
            uploadBytes,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";

// =====================================================================================
// === IMPORTANT: PASTE YOUR FIREBASE CONFIGURATION HERE ===============================
const firebaseConfig = {
  apiKey: "AIzaSyC-P560mawjrG1dHY-0GuVkWO9AlcQ0UL8",
  authDomain: "my-newbee-store.firebaseapp.com",
  projectId: "my-newbee-store",
  storageBucket: "my-newbee-store.firebasestorage.app",
  messagingSenderId: "164905434419",
  appId: "1:164905434419:web:9e1ff9deb31344c7651246"
};
// --- END OF FIREBASE CONFIGURATION ---

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app); // NEW: Initialize Storage
        const siteDataRef = doc(db, "settings", "liveData");

        document.addEventListener('DOMContentLoaded', async function() {
            // --- DATA STORE ---
            let cart = [];
            let appliedDiscount = null;
            let products = [];
            let categories = [];
            let orders = [];
            let deletedOrders = []; // NEW: For deleted orders
            let reviews = [];
            let coupons = [];
            let spinWinners = []; 
            let siteSettings = {};
            let abandonedCarts = []; // NEW: For abandoned carts
            let tickets = []; // NEW: For support tickets
            let countdownInterval;
            let productDetailCountdownInterval;
            let heroSlideshowInterval;
            let featuredSlideshowInterval; // NEW: for featured header
            let spinTimerInterval;
            let currentUser = null;
            let currentUsersList = [];
            let productSalesCache = {};
            let currentDetailProductId = null;
            let currentDetailMediaAssets = [];
            let currentDetailMediaIndex = 0;
            let productDetailSlideshowInterval = null; // MODIFIED: For product detail image slideshow
            let isSpinning = false;
            let currentMessageListener = null; 
            let currentAdminChatUserId = null;
            let currentCategoryProducts = []; // NEW: To store products for the current category modal
            let userCooldownIntervals = {}; // NEW: Store timers for admin user list
            // NEW: Unsubscribe listeners for notifications
            let adminNotificationListener = null;
            let userNotificationListener = null;
            let userTicketNotificationListener = null;


            const CART_DATA_KEY = 'vibecart-cart';
            const $ = (selector) => document.querySelector(selector);
            const $$ = (selector) => document.querySelectorAll(selector);
            
            // --- DEFAULTS ---
             const defaultProducts = [];
             const defaultCategories = [
                { id: "1", name: "Apparel", image: "https://placehold.co/600x400/34d399/ffffff?text=Apparel", displayImage: "https://placehold.co/150x150/34d399/ffffff?text=Apparel" },
                { id: "2", name: "Toys", image: "https://placehold.co/600x400/fbbf24/ffffff?text=Toys", displayImage: "https://placehold.co/150x150/fbbf24/ffffff?text=Toys" },
            ];
            const defaultWhatsappTemplate = `Hi {storeName}, I have just placed an order!\n\n*My Details:*\nName: {customerName}\nContact: {phone}\n\n*Order Number:* {orderNumber}\n\n--- Items ---\n{orderItems}\n\n--- Summary ---\n*Subtotal:* {subtotal}\n*Discount:* {discountInfo}\n*Delivery:* {deliveryCharges}\n*Grand Total: {total}*\n\n*Payment Method:* {paymentMethod}\n\n*Please deliver to:*\n{shippingAddress}\n\nThank you!\n\nStore Logo: {storeLogoUrl}`;
            const defaultWhatsappContactTemplate = `Hello {customerName},\n\nThis is a message from {storeName} regarding your order #{orderNumber}.\n\nOur store: {storeLogoUrl}`;
            
             const defaultCoupons = [
                { id: "1", code: "SALE10", type: "percent", value: 10, totalUses: 1000, perUserUses: 1, currentUses: 0, users: {} },
                { id: "2", code: "SAVE500", type: "fixed", value: 500, totalUses: 100, perUserUses: 1, currentUses: 0, users: {} }
             ];

             const defaultSiteSettings = {
                'adminPassword': 'royalty123', 
                'adminEmails': ['saeedilyas59@gmail.com'],
                'ownerWhatsapp': '923012725158',
                'store-name': 'NewBee',
                'store-logo': 'https://placehold.co/40x40/facc15/000000?text=NB',
                'store-logo-width': '40',
                'store-logo-height': '40',
                'store-name-align': 'justify-between',
                'store-font': 'font-serif-elegant',
                'announcement-text': 'Shop Now',
                'announcement-bg-color': '#111827',
                'hero-title': 'Welcome to NewBee',
                'hero-subtitle': 'The sweetest essentials for your little one.',
                'hero-images': 'https://placehold.co/1600x900/1a1a1a/ffffff?text=Your+First+Banner\nhttps://placehold.co/1600x900/4a4a4a/ffffff?text=Your+Second+Banner',
                'hero-font': 'font-serif-elegant',
                'hero-animation': 'fade-in',
                'hero-text-visible': true,
                'hero-title-fontsize': '4.5',
                'hero-subtitle-fontsize': '1.5',
                'secondary-announcement-enabled': false,
                'secondary-announcement-animated': false,
                'secondary-announcement-text': 'Free shipping on orders over Rs. 2500!',
                'secondary-announcement-bg-color': '#facc15',
                'secondary-announcement-text-color': '#1f2937',
                'secondary-announcement-animation-direction': 'scroll-left',
                'secondary-announcement-animation-speed': '40',
                'order-id-prefix': 'NB',
                'footer-phone': '+92 301 1234567',
                'footer-email': 'contact@newbee.com',
                'footer-address': '123 Baby Lane, Karachi, Pakistan',
                'footer-store-locator': 'https://www.google.com/maps/place/Royal+Infants/@24.860793,67.017859,17z/data=!3m1!4b1!4m6!3m5!1s0x3eb33fdb5e1e8977:0x9f9c2b7a571d4a74!8m2!3d24.860793!4d67.017859!16s%2Fg%2F11mwsgb06q?entry=ttu&g_ep=EgoyMDI1MTAwNy4wIKXMDSoASAFQAw%3D%3D',
                'footer-tiktok': '', 
                'footer-instagram': '',
                'footer-facebook': '',
                'footer-tiktok-icon': '',
                'footer-instagram-icon': '',
                'footer-facebook-icon': '',
                'footer-bg-color': '#1f2937',
                'product-card-width': 'w-72',
                'product-card-style': 'product-card-default',
                'product-card-slideshow-speed': '2000',
                'product-card-radius': '0.5rem',
                'product-card-bg-color': '#ffffff',
                'add-to-cart-btn-bg-color': '#111827',
                'product-text-color': '#1f2937',
                'sale-badge-bg-color': '#ef4444',
                'sale-badge-text-color': '#ffffff',
                'sold-badge-bg-color': '#3b82f6',
                'sold-badge-text-color': '#ffffff',
                'original-price-color': '#6b7280',
                'sale-price-color': '#1f2937',
                'star-color': '#facc15',
                'product-name-font': "'Inter', sans-serif",
                'product-name-font-weight': '700',
                'product-price-font': "'Inter', sans-serif",
                'product-price-font-weight': '700',
                'product-price-fontsize': '18',
                'pd-original-price-font': "'Inter', sans-serif",
                'pd-original-price-font-weight': '400',
                'pd-original-price-color': '#6b7280',
                'pd-sale-price-font': "'Inter', sans-serif",
                'pd-sale-price-font-weight': '700',
                'pd-sale-price-color': '#1f2937',
                'review-font-family': "'Inter', sans-serif",
                'review-font-weight': '400',
                'review-text-color': '#4b5563',
                'review-font-size': '16',
                'promo-popup-image': 'https://placehold.co/600x400/f87171/ffffff?text=SALE!',
                'promo-popup-title': 'Big Sale!',
                'promo-popup-text': 'Get 2 % off on all newborn essentials this week only.',
                'sale-end-date': '',
                'sale-message': 'Sale Ends In:',
                'whatsapp-template': defaultWhatsappTemplate,
                'whatsapp-contact-template': defaultWhatsappContactTemplate,
                'meta-keywords': 'baby clothes, newborn, infant wear, pakistan',
                'meta-description': 'The best store for newborn baby essentials in Pakistan. Quality, comfort, and adorable designs.',
                'tab-title': 'NewBees - The Infants World',
                'favicon-url': 'https://placehold.co/32x32/facc15/000000?text=NB',
                'reviews-animation-enabled': true,
                'reviews-animation-direction': 'marquee-scroll-left',
                'reviews-animation-speed': '40',
                'reviews-btn-color1': '#f59e0b',
                'reviews-btn-color2': '#fbbf24',
                'reviews-btn-text-color': '#1f2937',
                'all-reviews-header-image': '',
                'all-reviews-url': '',
                'all-reviews-url-text': 'Shop Now',
                'shipping-policy-title': 'Our Shipping Policy',
                'shipping-policy-content': 'We deliver across Pakistan within <b>3-5 business days</b>. Delivery  charges are calculated at checkout. For any queries, please contact our support team.',
                'shipping-policy-image': '',
                'faq-title': 'Frequently Asked Questions',
                'faq-content': '<b>What are your shipping times?</b>\n<p>We deliver in 3-5 business days.</p>',
                'faq-image': '',
                'about-us-title': 'About Our Store',
                'about-us-content': 'Welcome to our store! We are passionate about providing the <i>highest quality</i> products for your little ones.',
                'about-us-image': '',
                'payment-methods': [], 
                'payment-methods-title': 'Accepted Payment Methods',
                'payment-methods-image': '',
                'product-fade-animation': true,
                'spin-wheel-enabled': true,
                'luck-game-type': 'wheel', // 'wheel' or 'crate'
                'spin-wheel-logo': 'https://placehold.co/150x80/f97316/ffffff?text=LOGO',
                'spin-wheel-prizes': [], 
                'spin-wheel-logo-animation': '', 
                'crate-closed-image': 'https://i.imgur.com/gO2nB5v.png',
                'crate-open-image': 'https://i.imgur.com/3w3e6Wg.png',
                'add-to-cart-btn-radius': '0.375rem',
                'view-btn-radius': '0.375rem',
                'view-btn-bg': '#e5e7eb',
                'view-btn-text': '#1f2937',
                'btn-padding': '0.5rem 1rem',
                'category-btn-color1': '#fb923c',
                'category-btn-color2': '#ea580c',
                'category-banner-height': '192',
                'category-modal-logo': '', 
                'modal-logo-animation': '',
                'feature1-text': 'The most potent & powerful sea moss on Earth',
                'feature2-text': 'Live limitless each and every day',
                'feature3-text': 'Include 200 capsules  (4-6 capsules daily)',
                'feature1-icon-input': `<svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.125-.504 1.125-1.125V14.25m-17.25 4.5v-1.875a3.375 3.375 0 003.375-3.375h1.5a1.125 1.125 0 011.125 1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375m15.75 0v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5c0-.621.504-1.125 1.125-1.125h1.5a3.375 3.375 0 003.375 3.375V18.75z" /></svg>`,
                'feature2-icon-input': `<svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 44.5h-15a2.25 2.25 0 00-2.25 2..25v10.5A2.25 2.25 0 004.5 21z" /></svg>`,
                'feature3-icon-input': `<svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.75A.75.75 0 012.25 4.5h.75m0 0h.75A.75.75 0 014.5 5.25v.75m0 0h-.75A.75.75 0 013 6v.75m0 0v.75A.75.75 0 013.75 8.25h.75m0 0h.75a.75.75 0 01.75.75v.75m0 0h-.75a.75.75 0 01-.75-.75V9m0 0h.75A.75.75 0 016 8.25v.75M9 12.75a.75.75 0 01.75-.75h.008a.75.75 0 01.75.75v.008a.75.75 0 01-.75.75H9.75a.75.75 0 01-.75-.75V12.75zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>`,
                 'featured-header-enabled': false,
                'featured-header-images': '', 
                'featured-slideshow-enabled': true, 
                'featured-slideshow-speed': 5000,
                'featured-row-1-title': 'Top Picks',
                'featured-row-2-title': 'New Arrivals',
                'product-detail-name-fontsize': '30',
                'product-detail-price-fontsize': '24',
                'order-success-header': 'https://cdn.dribbble.com/users/1751799/screenshots/5512482/check-mark-dribbble.gif',
                'order-success-message': '<h2>Order Placed!</h2><p>Thank you for your purchase. Your order details have been sent via WhatsApp for confirmation.</p>',
                'category-images-enabled': true,
                'product-detail-subtitle': "Vital nutrition for your little one's daily lifestyle and optimal health.",
                'product-stock-status-size': '14',
                'ticketButtonEnabled': true,
                'ticketSubjects': ['Spin Wheel Prize Redemption', 'Order Tracking', 'Order Cancellation', 'Product Inquiry', 'Other'],
                'support-btn-color1': '#3b82f6',
                'support-btn-color2': '#60a5fa',
                'support-btn-text-color': '#ffffff',
                'cartIconSvg': '',
                'adminIconSvg': '',
                'userIconSvg': '',
                'supportIconSvg': '',
            };
            const defaultReviews = [];
             const defaultWhyUs = {
                title: "Why Shop With Us?",
                subtitle: "Your peace of mind is our highest priority.",
                item1_title: "Quality & Comfort",
                item1_desc: "Every item is crafted from the softest, safest materials, ensuring your baby's delicate skin is protected and comfortable.",
                item2_title: "Adorable Designs",
                item2_desc: "From cute patterns to modern styles, our collection is curated to make your little one look even more adorable.",
                item3_title: "Perfect Gifts",
                item3_desc: "Find the perfect, thoughtful gift for baby showers, birthdays, or just because. Beautifully packaged and a delight to receive."
            };
            
            // --- All functions defined here ---

            // NEW: Client-side router logic
            const router = () => {
                const path = window.location.hash.slice(1) || '/';
                const parts = path.split('/').filter(p => p);

                // Close any open modals first as a baseline
                $$('.modal-overlay.visible').forEach(modal => modal.classList.remove('visible'));

                if (parts[0] === 'products' && parts[1]) {
                    const productName = decodeURIComponent(parts[1]).replace(/-/g, ' ');
                    const product = products.find(p => p.name.toLowerCase() === productName.toLowerCase());
                    if (product) {
                        openProductDetail(product.id, false); // Don't update URL again
                    }
                } else if (parts[0] === 'categories' && parts[1]) {
                    const categoryName = decodeURIComponent(parts[1]).replace(/-/g, ' ');
                    const category = categories.find(c => c.name.toLowerCase() === categoryName.toLowerCase());
                    if (category) {
                        handleCategoryClick(category.id, false); // Don't update URL again
                    }
                }
            };
            
            // NEW: Function to update the URL hash
            const updateUrl = (path) => {
                // Only update the hash if it's different to prevent loop
                if (window.location.hash !== `#${path}`) {
                    window.location.hash = path;
                }
            };

            const openModal = (name) => {
                const modal = $(`#${name}-modal`);
                if (modal) {
                    if (['cart', 'category'].includes(name)) {
                        const logoEl = $(`#${name}-modal-logo`);
                        if (logoEl && siteSettings['category-modal-logo']) {
                            logoEl.src = siteSettings['category-modal-logo'];
                            logoEl.className = 'h-10 w-auto'; // Reset classes
                            if(siteSettings['modal-logo-animation']) {
                                logoEl.classList.add(siteSettings['modal-logo-animation']);
                            }
                        }
                    }
                    modal.classList.add('visible');
                }
            };
            const closeModal = (name) => {
                 const modal = $(`#${name}-modal`);
                if (modal) modal.classList.remove('visible');

                // If closing a product or category modal, reset the URL
                if (['product-detail', 'category'].includes(name) && window.location.hash) {
                    updateUrl('/');
                }
            };
            const showToast = (message, imageUrl, isSuccess = true) => { 
                const toast = document.createElement('div');
                toast.className = `toast ${isSuccess ? '' : 'error'}`;
                let iconHTML = isSuccess 
                    ? `<svg class="w-6 h-6 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>`
                    : `<svg class="w-6 h-6 text-red-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>`;
                
                let content = iconHTML;
                if(imageUrl) content += `<img src="${imageUrl}" alt="" class="toast-img">`;
                content += `<div><p class="font-bold">${isSuccess ? "Success" : "Error"}</p><p class="text-sm">${message}</p></div>`;
                toast.innerHTML = content;

                const closeBtn = document.createElement('button');
                closeBtn.innerHTML = '&times;';
                closeBtn.className = 'close-btn';
                closeBtn.onclick = () => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 500);
                };
                toast.appendChild(closeBtn);
                
                document.body.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 500); }, 4000);
             };
            
            const updateCartView = () => {
                const container = $('#cart-items-container');
                if (!container) return;
                if (cart.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center p-4">Your cart is empty.</p>';
                    return;
                }
                container.innerHTML = cart.map(item => `
                    <div class="flex items-start justify-between py-4 cart-item" data-id="${item.id}">
                        <div class="flex items-start gap-4">
                           <img src="${item.image}" alt="${item.name}" class="w-20 h-20 rounded-md object-cover">
                           <div>
                               <p class="font-bold">${item.name}</p>
                               ${item.variant?.colorName ? `<p class="text-sm text-gray-600">Color: ${item.variant.colorName}</p>` : ''}
                               <p class="text-lg font-semibold text-gray-700 mt-1">Rs. ${item.price.toLocaleString()}</p>
                           </div>
                        </div>
                        <div class="flex flex-col items-end gap-2">
                            <button class="cart-remove-item text-gray-400 hover:text-red-600 text-2xl" type="button">&times;</button>
                            <div class="flex items-center gap-3 border rounded-full p-1">
                                <button class="cart-quantity-change cart-quantity-changer" data-change="-1">-</button>
                                <span class="px-1 font-bold text-lg">${item.quantity}</span>
                                <button class="cart-quantity-change cart-quantity-changer" data-change="1">+</button>
                            </div>
                        </div>
                    </div>`).join('');
            };

            const updateCartSummary = () => {
                const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                let discountAmount = 0;
                if (appliedDiscount) {
                    discountAmount = appliedDiscount.type === 'percent' ? subtotal * (appliedDiscount.value / 100) : appliedDiscount.value;
                }
                const delivery = cart.length > 0 ? Math.max(...cart.map(item => item.deliveryCharge)) : 0;
                
                const total = subtotal - discountAmount + delivery;
                $('#cart-subtotal').textContent = `Rs. ${subtotal.toLocaleString()}`;
                $('#cart-discount').textContent = `-Rs. ${discountAmount.toLocaleString()}`;
                $('#cart-delivery').textContent = `Rs. ${delivery.toLocaleString()}`;
                $('#cart-total').textContent = `Rs. ${total.toLocaleString()}`;
            };

            const saveCartToLocalStorage = () => {
                localStorage.setItem(CART_DATA_KEY, JSON.stringify(cart));
            };

            const loadCartFromLocalStorage = () => {
                const savedCart = localStorage.getItem(CART_DATA_KEY);
                cart = savedCart ? JSON.parse(savedCart) : [];
            };
            
            const debouncedSaveAbandonedCart = debounce(() => {
                if(currentUser && cart.length > 0) {
                    saveAbandonedCart(currentUser);
                }
            }, 2000); // Save 2 seconds after the last cart change

            const updateCartUI = () => {
                const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
                $('#cart-counter').textContent = totalItems;
                const checkoutBtn = $('#proceed-to-checkout-btn');
                if(checkoutBtn) checkoutBtn.disabled = totalItems === 0;
                updateCartView();
                updateCartSummary();
                saveCartToLocalStorage();
                debouncedSaveAbandonedCart();
            };
            
            const addToCart = (productId, variantData = null, quantity = 1) => {
                 const product = products.find(p => p.id == productId);
                 if (!product) return;
            
                 const cartItemId = variantData ? `${productId}-${variantData.colorName}` : productId;
            
                 if (product.stock <= 0 && (!product.variants || product.variants.length === 0)) {
                     showToast("This item is out of stock.", null, false);
                     return;
                 }
            
                 const toastImage = variantData ? variantData.image : (product.galleryImages[0] || product.mainImage);
                 const toastMessage = `${product.name} ${variantData ? `(${variantData.colorName})` : ''} has been added.`;
            
                 const existingItem = cart.find(item => item.id == cartItemId);
            
                 if (existingItem) {
                     existingItem.quantity += quantity;
                 } else {
                     const displayPrice = product.salePrice && product.salePrice < product.price ? product.salePrice : product.price;
                     cart.push({ 
                         id: cartItemId, 
                         productId: product.id,
                         name: product.name, 
                         price: parseFloat(displayPrice), 
                         quantity: quantity, 
                         image: toastImage,
                         deliveryCharge: parseFloat(product.deliveryCharge) || 0,
                         variant: variantData 
                     });
                 }
                 updateCartUI();
                 showToast(toastMessage, toastImage);
            };

            const updateCartItemQuantity = (id, newQuantity) => {
                if (newQuantity <= 0) {
                    cart = cart.filter(cartItem => cartItem.id != id);
                } else {
                    const item = cart.find(item => item.id == id);
                    if (item) item.quantity = newQuantity;
                }
                updateCartUI();
            };
            
            const getStarRatingHTML = (rating, count, isAnimated = false) => {
                const fullStars = Math.floor(rating);
                let starsHTML = '';
                const animatedClass = isAnimated ? 'review-star-animated' : '';
                for (let i = 0; i < 5; i++) {
                    starsHTML += `<svg class="w-4 h-4 ${i < rating ? `star-rating-display ${animatedClass}` : 'text-gray-300'}" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.957a1 1 0 00.95.69h4.162c.969 0 1.371 1.24.588 1.81l-3.368 2.448a1 1 0 00-.364 1.118l1.287 3.957c.3.921-.755 1.688-1.539 1.118l-3.368-2.448a1 1 0 00-1.175 0l-3.368 2.448c-.784.57-1.838-.197-1.539-1.118l1.287-3.957a1 1 0 00-.364-1.118L2.07 9.384c-.783-.57-.38-1.81.588-1.81h4.162a1 1 0 00.95-.69L9.049 2.927z"></path></svg>`;
                }
                
                const countText = count ? `<span class="text-xs text-gray-500 ml-1">(${count} Reviews)</span>` : '';
                return `<div class="flex items-center gap-1">${starsHTML} ${countText}</div>`;
            };
            
            const renderProducts = (productArray = [], gridElement, emptyMessage) => {
                if (!gridElement) return;
                
                if (productArray.length === 0) {
                    const message = emptyMessage || "No products found in this collection.";
                    gridElement.innerHTML = `<p class="text-gray-500 p-8 col-span-full">${message}</p>`;
                    return;
                }

                const cardWidthClass = siteSettings['product-card-width'] || 'w-72';
                const cardStyleClass = siteSettings['product-card-style'] || 'product-card-default';
                const animationClass = siteSettings['product-fade-animation'] ? 'product-fade-in' : '';

                const productHTML = productArray.map(p => {
                    const onSale = p.salePrice && p.salePrice < p.price;
                    const ratings = p.ratings || [];
                    const ratingCount = ratings.length;
                    const avgRating = ratingCount > 0 ? ratings.reduce((sum, r) => sum + r.rating, 0) / ratingCount : 0;
                    const salesCount = productSalesCache[p.id] || 0;
                    
                    const hasVariants = p.variants && p.variants.length > 0;
                    const defaultImage = hasVariants ? p.variants[0].image : (p.galleryImages ? p.galleryImages[0] : p.mainImage);
                    const totalStock = hasVariants ? p.variants.reduce((sum, v) => sum + (parseInt(v.stock) || 0), 0) : (parseInt(p.stock) || 0);
                    const isOutOfStock = totalStock <= 0;

                    let galleryImages = [];
                    if (p.galleryImages && p.galleryImages.length > 0) {
                        galleryImages = p.galleryImages;
                    } else if (hasVariants) {
                        galleryImages = p.variants.map(v => v.image);
                    } else {
                        galleryImages = [p.mainImage];
                    }
                    
                    let priceHTML = '';
                    if(onSale) {
                        priceHTML = `
                            <div class="flex flex-col items-start product-card-price">
                                <p class="text-sm line-through price-original">Rs. ${p.price.toLocaleString()}</p>
                                <p class="text-lg font-bold price-sale">Rs. ${p.salePrice.toLocaleString()}</p>
                            </div>`;
                    } else {
                        priceHTML = `<p class="text-lg font-bold product-text product-card-price">Rs. ${p.price.toLocaleString()}</p>`;
                    }

                    let buttonHTML = '';
                    buttonHTML = `
                        <button class="add-to-cart-btn flex-1 text-white hover:opacity-90 transition disabled:bg-gray-400 disabled:cursor-not-allowed" data-id="${p.id}" ${isOutOfStock ? 'disabled' : ''}>
                            ${isOutOfStock ? 'Out of Stock' : (hasVariants ? 'Add to Cart' : 'Add to Cart')}
                        </button>
                        <button class="view-product-btn flex-1 hover:opacity-90 transition" data-id="${p.id}">View</button>
                    `;
                    
                    let variantSwatchesHTML = '';
                    if (hasVariants) {
                        variantSwatchesHTML = `
                            <div class="flex items-center gap-2 mt-2 card-color-swatches">
                                ${p.variants.map((v, index) =>
                                    `<div class="color-swatch ${index === 0 ? 'selected' : ''}" style="background-color: ${v.colorHex};" data-color-name="${v.colorName}" data-image="${v.image}" title="${v.colorName}"></div>`
                                ).join('')}
                            </div>
                        `;
                    }


                    return `
                    <div class="product-card ${cardWidthClass} ${cardStyleClass} ${animationClass} overflow-hidden snap-start flex flex-col" data-id="${p.id}" data-gallery-images='${JSON.stringify(galleryImages)}' data-variants='${JSON.stringify(p.variants || [])}'>
                        <div class="relative product-clickable-area">
                            <img src="${defaultImage}" alt="${p.name}" class="product-card-image w-full h-64 object-cover transition-opacity duration-300">
                            ${onSale ? '<span class="absolute top-2 left-2 sale-badge text-xs font-bold px-3 py-1 rounded-full">SALE</span>' : ''}
                            ${isOutOfStock ? '<span class="absolute top-2 left-2 bg-gray-700 text-white text-full">OUT OF STOCK</span>' : ''}
                            <span class="absolute top-2 right-2 sold-badge text-xs font-bold px-3 py-1 rounded-full">${salesCount} Sold</span>
                        </div>
                        <div class="p-6 text-left flex flex-col flex-grow">
                            <div class="flex-grow">
                                ${getStarRatingHTML(avgRating, ratingCount)}
                                <div class="product-clickable-area">
                                    <h3 class="font-bold text-xl mt-2 mb-2 truncate product-text product-card-name">${p.name}</h3>
                                </div>
                            </div>
                            <div class="mt-4">
                                ${priceHTML}
                                ${variantSwatchesHTML}
                                <div class="my-4 h-6"></div>
                                <div class="flex space-x-2">
                                    ${buttonHTML}
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');

                gridElement.innerHTML = productHTML;

                if(siteSettings['product-fade-animation']) {
                    setupProductScrollAnimation();
                }
            };

            
            const renderCategories = () => {
                const buttonContainer = $('#category-buttons');
                const dropdownContainer = $('#nav-dropdown-collections');
                if (!buttonContainer || !dropdownContainer) return;
                
                const showImages = siteSettings['category-images-enabled'];

                if (showImages) {
                     buttonContainer.innerHTML = categories.map(c => `
                        <div class="category-item-wrapper">
                            ${c.displayImage ? `<img src="${c.displayImage}" alt="${c.name}" class="category-display-image">` : ''}
                            <button class="category-btn" data-id="${c.id}">${c.name}</button>
                        </div>
                    `).join('');
                } else {
                    buttonContainer.innerHTML = categories.map(c => `
                        <button class="category-btn" data-id="${c.id}">${c.name}</button>
                    `).join('');
                }
                
                dropdownContainer.innerHTML = categories.map(c => `
                    <button type="button" class="block text-left w-full text-gray-700 hover:text-black category-dropdown-link" data-id="${c.id}">${c.name}</button>
                `).join('');
            };

            const renderAdminOrders = (filter = 'All', searchTerm = '') => {
                const list = $('#admin-orders-list');
                if (!list) return;

                let filteredOrders = orders;
                if (filter !== 'All') {
                    filteredOrders = filteredOrders.filter(order => order.status === filter);
                }
                if(searchTerm) {
                    searchTerm = searchTerm.toLowerCase();
                    filteredOrders = filteredOrders.filter(order => {
                        const customerName = order.customer ? order.customer.name.toLowerCase() : '';
                        const orderId = order.id ? order.id.toLowerCase() : '';
                        return customerName.includes(searchTerm) || orderId.includes(searchTerm);
                    });
                }

                if (filteredOrders.length === 0) {
                    list.innerHTML = `<p class="text-gray-500 text-center">No orders found.</p>`;
                    return;
                }

                list.innerHTML = [...filteredOrders].reverse().map(order => {
                    const customer = order.customer || { name: 'N/A', address: 'N/A', city: 'N/A', phone: '' };
                    let whatsappMessage = siteSettings['whatsapp-contact-template'] || defaultWhatsappContactTemplate;
                    const orderItemsList = order.items.map(item => `- ${item.name} ${item.variant?.colorName || ''} (x${item.quantity})`).join('\n');
                    const shippingAddress = `${customer.address}, ${customer.city}`;
                    const subtotal = order.items.reduce((sum, item) => sum + item.price * item.quantity, 0);
                    const delivery = order.items.length > 0 ? Math.max(...order.items.map(item => item.deliveryCharge)) : 0;
                    const discountAmount = subtotal + delivery - order.total;
                    
                    whatsappMessage = whatsappMessage
                        .replace(/{storeName}/g, siteSettings['store-name'])
                        .replace(/{orderNumber}/g, order.id)
                        .replace(/{customerName}/g, customer.name)
                        .replace(/{phone}/g, customer.phone)
                        .replace(/{orderItems}/g, orderItemsList)
                        .replace(/{subtotal}/g, `Rs. ${subtotal.toLocaleString()}`)
                        .replace(/{discount}/g, `Rs. ${discountAmount.toLocaleString()}`)
                        .replace(/{total}/g, `Rs. ${order.total.toLocaleString()}`)
                        .replace(/{shippingAddress}/g, shippingAddress)
                        .replace(/{storeLogoUrl}/g, siteSettings['store-logo'] || '');
                    const whatsappUrl = `https://wa.me/${customer.phone}?text=${encodeURIComponent(whatsappMessage)}`;

                    return `
                    <div class="admin-order-card" data-id="${order.id}">
                        <div class="flex justify-between items-start">
                           <div>
                                <p class="font-bold text-lg">Order #${order.id}</p>
                                <p>${customer.name} - ${new Date(order.date).toLocaleString()}</p>
                                <p class="text-sm text-gray-600">${shippingAddress}</p>
                                ${order.paymentMethod ? `<p class="text-sm font-semibold text-blue-600">Payment: ${order.paymentMethod}</p>` : ''}
                           </div>
                           <div class="text-right">
                               <p class="font-bold text-lg">Rs. ${order.total.toLocaleString()}</p>
                               <a href="${whatsappUrl}" target="_blank" class="text-green-600 hover:underline text-sm">Contact Customer</a>
                           </div>
                        </div>
                        <div class="mt-4 pt-4 border-t flex items-center justify-between gap-4">
                             <div>
                                 <label class="admin-label">Order Status</label>
                                 <select class="admin-select order-status-select" data-id="${order.id}">
                                    <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                    <option value="Contacted" ${order.status === 'Contacted' ? 'selected' : ''}>Contacted</option>
                                    <option value="On Hold" ${order.status === 'On Hold' ? 'selected' : ''}>On Hold</option>
                                    <option value="Delivered" ${order.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                                    <option value="Cancelled" ${order.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                                 </select>
                             </div>
                             <button class="delete-order-btn mt-6 px-3 py-2 bg-red-100 text-red-700 rounded-md hover:bg-red-200 text-sm">Delete</button>
                        </div>
                    </div>`
                }).join('');
            };
            
            const renderAdminCoupons = () => {
                const list = $('#admin-coupons-list');
                if(!list) return;
                
                if (coupons.length === 0) {
                    list.innerHTML = `<p class="text-gray-500">No coupons created yet.</p>`;
                    return;
                }
                
                list.innerHTML = coupons.map(c => {
                    const totalUses = c.totalUses || '';
                    const currentUses = c.currentUses || 0;
                    return `
                    <div class="admin-coupon-card flex justify-between items-center" data-id="${c.id}">
                        <div>
                            <p class="font-bold text-lg text-indigo-600">${c.code}</p>
                            <p class="text-sm text-gray-700">Type: ${c.type} | Value: ${c.type === 'percent' ? c.value + '%' : 'Rs. ' + c.value}</p>
                            <p class="text-xs text-gray-500 mt-1">Usage: ${currentUses} / ${totalUses} | Per User: ${c.perUserUses || ''}</p>
                        </div>
                        <div class="space-x-2">
                            <button class="edit-coupon-btn text-blue-600 hover:underline" type="button">Edit</button>
                            <button class="delete-coupon-btn text-red-600 hover:underline" type="button">Delete</button>
                        </div>
                    </div>
                `}).join('');
            };

              const renderAdminPanels = () => {
                 const productList = $('#admin-products-list');
                 if (productList) {
                     productList.innerHTML = products.length > 0 ? products.map(p => `
                         <div class="admin-product-card flex justify-between items-center" data-id="${p.id}">
                             <p class="font-bold">${p.name}</p>
                             <div class="space-x-2">
                                 <button class="edit-product-btn text-blue-600 hover:underline" type="button">Edit</button>
                                 <button class="delete-product-btn text-red-600 hover:underline" type="button">Delete</button>
                             </div>
                         </div>
                     `).join('') : '<p class="text-gray-500">No products created yet.</p>';
                 }
                 const categoryList = $('#admin-categories-list');
                 if (categoryList) {
                     categoryList.innerHTML = categories.map(c => `
                         <div class="admin-category-card space-y-2 border p-4 rounded-md" data-id="${c.id}">
                             <div class="flex justify-between items-center">
                                 <h4 class="font-bold">Editing: ${c.name}</h4>
                                 <button class="delete-category-btn text-red-600 hover:underline text-sm" type="button">Delete</button>
                             </div>
                              <label class="admin-label">Name</label>
                              <input type="text" value="${c.name}" class="admin-input category-name-input">
                              <label class="admin-label">Banner Image URL</label>
                              <div class="flex items-center gap-4">
                                  <input id="category-image-input-${c.id}" type="text" value="${c.image}" class="admin-input category-image-input">
                                  <label class="upload-btn"><input type="file" class="hidden file-input" data-target="category-image-input-${c.id}">Upload</label>
                              </div>
                              <label class="admin-label">Display Image URL</label>
                              <div class="flex items-center gap-4">
                                  <input id="category-display-image-input-${c.id}" type="text" value="${c.displayImage || ''}" class="admin-input category-display-image-input">
                                  <label class="upload-btn"><input type="file" class="hidden file-input" data-target="category-display-image-input-${c.id}">Upload</label>
                              </div>
                         </div>
                     `).join('');
                 }
                
                  const reviewList = $('#admin-reviews-list');
                  if (reviewList) {
                      reviewList.innerHTML = reviews.length > 0 ? reviews.map(r => `
                          <div class="admin-review-card flex justify-between items-center" data-id="${r.id}">
                              <div>
                                  <p class="font-bold">${r.name} (${r.rating} )</p>
                                  <p class="text-sm text-gray-600 italic">"${r.quote}"</p>
                              </div>
                              <div class="space-x-2">
                                  <button class="edit-review-btn text-blue-600 hover:underline" type="button">Edit</button>
                                  <button class="delete-review-btn text-red-600 hover:underline" type="button">Delete</button>
                              </div>
                          </div>
                      `).join('') : '<p class="text-gray-500">No reviews yet.</p>';
                  }
                  renderAdminCoupons();
                  renderSpinWheelAdmin();
                  renderPaymentMethodsAdmin();
                  renderAdminTicketSubjects();
            };
            
            const renderReviews = () => {
                const grid = $('#reviews-grid');
                if(!grid) return;
                 if(reviews.length === 0){
                     grid.innerHTML = '<p class="text-gray-500 p-8">No customer reviews yet.</p>';
                     return;
                 }
                const reviewHTML = reviews.map(r => `
                    <div class="bg-gray-50 p-8 rounded-lg">
                        <div class="flex items-center mb-4">
                           ${getStarRatingHTML(r.rating, null, true)}
                        </div>
                        <p class="text-gray-600 italic mb-4 review-quote">"${r.quote}"</p>
                        <p class="font-bold text-gray-800">- ${r.name}</p>
                    </div>
                `).join('');
                
                // Duplicate for marquee effect
                grid.innerHTML = reviewHTML + reviewHTML;
            };

            const renderWhyUs = () => {
                  const s = siteSettings.whyUs;
                  if(!s) return;
                  $('#why-us-title').textContent = s.title;
                  $('#why-us-subtitle').textContent = s.subtitle;
                  const item1 = $('#why-us-item-1');
                  item1.querySelector('h3').textContent = s.item1_title;
                  item1.querySelector('p').textContent = s.item1_desc;
                  const item2 = $('#why-us-item-2');
                  item2.querySelector('h3').textContent = s.item2_title;
                  item2.querySelector('p').textContent = s.item2_desc;
                  const item3 = $('#why-us-item-3');
                  item3.querySelector('h3').textContent = s.item3_title;
                  item3.querySelector('p').textContent = s.item3_desc;
            };
            
            const renderDashboard = (period = 'all') => {
                let relevantOrders = orders.filter(order => order.status === 'Delivered');
                
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

                if (period !== 'all') {
                    let startDate;
                    if (period === 'today') {
                        startDate = today;
                    } else if (period === '7d') {
                        startDate = new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000);
                    } else if (period === '30d') {
                         startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    } else if (period === '365d') {
                         startDate = new Date(now.getFullYear(), 0, 1);
                    }
                    relevantOrders = relevantOrders.filter(order => new Date(order.date) >= startDate);
                }

                const totalRevenue =  relevantOrders.reduce((sum, order) => sum + order.total, 0);
                const totalOrdersCount = relevantOrders.length;
                const avgOrderValue = totalOrdersCount > 0 ? totalRevenue / totalOrdersCount : 0;

                $('#stats-total-revenue').textContent = `Rs. ${totalRevenue.toLocaleString()}`;
                $('#stats-total-orders').textContent = totalOrdersCount;
                $('#stats-avg-order').textContent = `Rs. ${Math.round(avgOrderValue).toLocaleString()}`;
                
                const productSales = {};
                relevantOrders.forEach(order => {
                    order.items.forEach(item => {
                        const id = item.productId; 
                        if(productSales[id]) {
                            productSales[id].quantity += item.quantity;
                        } else {
                            const product = products.find(p => p.id == id);
                            productSales[id] = { name: product ? product.name : 'Unknown Product', quantity: item.quantity };
                        }
                    });
                });

                const topProducts = Object.values(productSales)
                    .sort((a, b) => b.quantity - a.quantity)
                    .slice(0, 5);

                const topProductsContainer = $('#stats-top-products');
                if (topProducts.length > 0) {
                    topProductsContainer.innerHTML = topProducts.map(p => `
                        <div class="flex justify-between items-center p-2 bg-white rounded">
                            <p>${p.name}</p>
                            <p class="font-bold">${p.quantity} sold</p>
                        </div>
                    `).join('');
                } else {
                    topProductsContainer.innerHTML = '<p class="text-gray-500">No sales data in this period.</p>';
                }

                const customerSales = {};
                relevantOrders.forEach(order => {
                    const uid = order.userId;
                    if (uid) {
                        if (customerSales[uid]) {
                            customerSales[uid].orders += 1;
                            customerSales[uid].totalValue += order.total;
                        } else {
                             const user = currentUsersList.find(u => u.uid === uid);
                            customerSales[uid] = { 
                                name: user ? user.name : (order.customer ? order.customer.name : 'Unknown'), 
                                orders: 1, 
                                totalValue: order.total 
                            };
                        }
                    }
                });

                const topCustomers = Object.values(customerSales)
                    .sort((a, b) => b.orders - a.orders)
                    .slice(0, 5);

                const topCustomersContainer = $('#stats-top-customers');
                if (topCustomers.length > 0) {
                    topCustomersContainer.innerHTML = topCustomers.map(c => `
                        <div class="flex justify-between items-center p-2 bg-white rounded">
                            <div><p>${c.name}</p></div>
                            <p class="font-bold text-right">${c.orders} orders<br><span class="text-sm font-normal text-gray-600">Rs. ${c.totalValue.toLocaleString()}</span></p>
                        </div>
                    `).join('');
                } else {
                    topCustomersContainer.innerHTML = '<p class="text-gray-500">No customer data in this period.</p>';
                }
            };
            
            const renderFooter = () => {
                const contactContainer = $('#footer-contact-info');
                contactContainer.innerHTML = `
                    <p class="flex items-center justify-center md:justify-start gap-3"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg><span>${siteSettings['footer-phone']}</span></p>
                    <p class="flex items-center justify-center md:justify-start gap-3"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg><span>${siteSettings['footer-email']}</span></p>
                    <p class="flex items-center justify-center md:justify-start gap-3"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg><span>${siteSettings['footer-address']}</span></p>`;

                const socialContainer = $('#social-links-container');
                socialContainer.innerHTML = ''; 
                const socialPlatforms = ['tiktok', 'instagram', 'facebook'];
                const defaultIcons = {
                    tiktok: '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-2.43.03-4.83-.95-6.43-2.88-1.59-1.93-2.24-4.4-2.04-6.81.02-1.1.22-2.18.52-3.23.63-2.15 2.12-4.04 4.01-5.32 1.45-1.02 3.12-1.52 4.86-1.56.97-.02 1.94-.02 2.92-.01z"/></svg>',
                    instagram: '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.85s-.012 3.584-.07 4.85c-.148 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07s-3.584-.012-4.85-.07c-3.252-.148-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.85s.012-3.584.07-4.85c.148-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.85-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948s-.014-3.667-.072-4.947c-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.689-.073-4.948-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.162 6.162 6.162 6.162-2.759 6.162-6.162-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4s1.791-4 4-4 4 1.79 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44 1.441-.645 1.441-1.44-.645-1.44-1.441-1.44z"/></svg>',
                    facebook: '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M9 8h-3v4h3v12h5v-12h3.642l.358-4h-4v-1.667c0-.955.192-1.333 1.115-1.333h2.885v-5h-3.808c-3.596 0-5.192 1.583-5.192 4.615v3.385z"/></svg>'
                };

                socialPlatforms.forEach(platform => {
                    const handle = siteSettings[`footer-${platform}`];
                    if (handle) {
                        let url = '';
                        if (platform === 'tiktok') url = `https://www.tiktok.com/@${handle}`;
                        if (platform === 'instagram') url = `https://www.instagram.com/${handle}`;
                        if (platform === 'facebook') url = `https://www.facebook.com/${handle}`;
                        
                        const iconUrl = siteSettings[`footer-${platform}-icon`];
                        const link = document.createElement('a');
                        link.href = url;
                        link.target = '_blank';
                        link.rel = 'noopener noreferrer';
                        link.className = 'text-gray-400 hover:text-white';
                        updateIcon(link, iconUrl, defaultIcons[platform]);
                        socialContainer.appendChild(link);
                    }
                });
            };

            async function loadDataFromFirestore() {
                try {
                    const docSnap = await getDoc(siteDataRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        products = data.products || defaultProducts;
                        products.forEach(p => { 
                            if (!p.ratings) p.ratings = []; 
                            if (p.deliveryCharge === undefined) p.deliveryCharge = 0;
                            if (!p.variants) p.variants = [];
                            if (!p.galleryImages) p.galleryImages = [];
                            if (p.mainImage && p.galleryImages.length === 0) {
                                p.galleryImages.push(p.mainImage);
                            }
                            if (p.stock === undefined) p.stock = 10;
                            if (p.isFeatured === undefined) p.isFeatured = 0; // 0 for none, 1 for row 1, 2 for row 2
                            if (p.showSizeGuide === undefined) p.showSizeGuide = false; 
                            if (p.views === undefined) p.views = 0;
                        });
                        categories = data.categories || defaultCategories;
                        categories.forEach(c => {
                            if (c.displayImage === undefined) c.displayImage = '';
                        });
                        orders = data.orders || [];
                        deletedOrders = data.deletedOrders || [];
                        reviews = data.reviews || defaultReviews;
                        coupons = (data.coupons || defaultCoupons).map(c => ({ ...c, currentUses: c.currentUses || 0, users: c.users || {} }));
                        spinWinners = data.spinWinners || [];
                        tickets = data.tickets || [];
                        tickets.forEach(t => { if(t.lastUserView === undefined) t.lastUserView = 0; });
                        siteSettings = { ...defaultSiteSettings, whyUs: { ...defaultWhyUs, ...data.siteSettings?.whyUs }, ...data.siteSettings };
                        if (!siteSettings['whatsapp-template']) siteSettings['whatsapp-template'] = defaultWhatsappTemplate;
                        if (!siteSettings['whatsapp-contact-template']) siteSettings['whatsapp-contact-template'] = defaultWhatsappContactTemplate;
                        if (!siteSettings['payment-methods']) siteSettings['payment-methods'] = [];
                    } else {
                        console.log("No such document! Initializing with default data.");
                        products = defaultProducts; categories
                         await setDoc(siteDataRef, { products, categories, orders, deletedOrders, reviews, coupons, spinWinners, tickets, siteSettings });
                    }
                    
                    const abandonedCartsSnapshot = await getDocs(collection(db, "abandonedCarts"));
                    abandonedCarts = abandonedCartsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                } catch (error) {
                    console.error("Firebase Read Error:", error);
                    showToast("Could not load store data. Using defaults.", null, false);
                    products = defaultProducts; 
                    categories = defaultCategories;
                    reviews = defaultReviews; 
                    coupons = defaultCoupons;
                    siteSettings = defaultSiteSettings;
                    tickets = [];
                }
                calculateProductSales();
                await fetchUsers();
            }

            async function saveDataToFirestore(options = {}) {
                const defaults = { rerenderProducts: true, showAdminToast: true };
                const settings = { ...defaults, ...options };

                collectAllSettings();
                
                const dataToSave = { products, categories, orders, deletedOrders, reviews, coupons, spinWinners, tickets, siteSettings };
                try {
                    await setDoc(siteDataRef, dataToSave);
                    if (settings.showAdminToast && currentUser && siteSettings.adminEmails.includes(currentUser.email)) {
                         const activeTab = $('.admin-tab.active')?.dataset.tab || 'All';
                         const tabName = activeTab.charAt(0).toUpperCase() + activeTab.slice(1).replace('-', ' ');
                         showToast(`${tabName} settings saved successfully!`);
                    }
                    applyAllSettings(); 
                    if(settings.rerenderProducts) {
                        renderProducts(products.filter(p => p.isFeatured == 1), $('#product-grid-1'));
                        renderProducts(products.filter(p => p.isFeatured == 2), $('#product-grid-2'));
                        renderCategories();
                    }
                } catch (error) {
                    console.error("Error writing document: ", error);
                     if (currentUser && siteSettings.adminEmails.includes(currentUser.email)) {
                        showToast('Error saving changes. Check console for details.', null, false);
                    }
                }
            }

            const calculateProductSales = () => {
                const sales = {};
                products.forEach(p => sales[p.id] = 0); 
                orders.forEach(order => {
                    if (order.status === 'Delivered') {
                        order.items.forEach(item => {
                            const id = item.productId;
                            sales[id] = (sales[id] || 0) + item.quantity;
                        });
                    }
                });
                productSalesCache = sales;
            };

            function collectAllSettings() {
                const allTabs = ['general', 'products', 'categories', 'orders', 'spin-wheel', 'reviews-manage', 'whatsapp', 'footer', 'pages', 'settings', 'tickets'];
                allTabs.forEach(tabName => collectSettingsFromActiveTab(tabName));
            }
            
            const collectSettingsFromActiveTab = (activeTab) => {
                switch(activeTab) {
                    case 'general':
                        siteSettings['store-logo'] = $('#store-logo-input').value;
                        siteSettings['store-name'] = $('#store-name-input').value;
                        siteSettings['store-logo-width'] = $('#store-logo-width-input').value;
                        siteSettings['store-logo-height'] = $('#store-logo-height-input').value;
                        siteSettings['store-name-align'] = $('#store-name-align-select').value;
                        siteSettings['store-font'] = $('#store-font-select').value;
                        siteSettings['announcement-text'] = $('#announcement-text-input').value;
                        siteSettings['announcement-bg-color'] = $('#announcement-bg-color-input').value;
                        siteSettings['hero-text-visible'] = $('#hero-text-visible-input').checked;
                        siteSettings['hero-title'] = $('#hero-title-input').value;
                        siteSettings['hero-subtitle'] = $('#hero-subtitle-input').value;
                        siteSettings['hero-images'] = $('#hero-images-input').value;
                        siteSettings['hero-font'] = $('#hero-font-select').value;
                        siteSettings['hero-animation'] = $('#hero-animation-select').value;
                        siteSettings['hero-title-fontsize'] = $('#hero-title-fontsize-input').value;
                        siteSettings['hero-subtitle-fontsize'] = $('#hero-subtitle-fontsize-input').value;
                        siteSettings['secondary-announcement-enabled'] = $('#secondary-announcement-enabled-input').checked;
                        siteSettings['secondary-announcement-animated'] = $('#secondary-announcement-animated-input').checked;
                        siteSettings['secondary-announcement-text'] = $('#secondary-announcement-text-input').value;
                        siteSettings['secondary-announcement-bg-color'] = $('#secondary-announcement-bg-color-input').value;
                        siteSettings['secondary-announcement-text-color'] = $('#secondary-announcement-text-color-input').value;
                        siteSettings['secondary-announcement-animation-direction'] = $('#secondary-announcement-animation-direction-select').value;
                        siteSettings['secondary-announcement-animation-speed'] = $('#secondary-announcement-animation-speed-input').value;
                        siteSettings.whyUs = {
                            title: $('#why-us-title-input').value, subtitle: $('#why-us-subtitle-input').value,
                            item1_title: $('#why-us-item1-title-input').value, item1_desc: $('#why-us-item1-desc-input').value,
                            item2_title: $('#why-us-item2-title-input').value, item2_desc: $('#why-us-item2-desc-input').value,
                            item3_title: $('#why-us-item3-title-input').value, item3_desc: $('#why-us-item3-desc-input').value
                        };
                        siteSettings['promo-popup-image'] = $('#promo-popup-image-input').value;
                        siteSettings['promo-popup-title'] = $('#promo-popup-title-input').value;
                        siteSettings['promo-popup-text'] = $('#promo-popup-text-input').value;
                        siteSettings['sale-message'] = $('#sale-message-input').value;
                        siteSettings['sale-end-date'] = $('#sale-end-date-input').value;
                        break;
                    case 'products':
                        siteSettings['featured-header-enabled'] = $('#featured-header-enabled-input').checked;
                        siteSettings['featured-header-images'] = $('#featured-header-images-input').value;
                        siteSettings['featured-slideshow-enabled'] = $('#featured-slideshow-enabled-input').checked;
                        siteSettings['featured-slideshow-speed'] = $('#featured-slideshow-speed-input').value;
                        siteSettings['featured-row-1-title'] = $('#featured-row-1-title-input').value;
                        siteSettings['featured-row-2-title'] = $('#featured-row-2-title-input').value;
                        siteSettings['product-fade-animation'] = $('#product-fade-animation-input').checked;
                        siteSettings['product-card-slideshow-speed'] = $('#product-card-slideshow-speed-input').value;
                        siteSettings['product-card-width'] = $('#product-card-width-select').value;
                        siteSettings['product-card-style'] = $('#product-card-style-select').value;
                        siteSettings['product-card-radius'] = $('#product-card-radius-input').value;
                        siteSettings['product-card-bg-color'] = $('#product-card-bg-color-input').value;
                        siteSettings['product-text-color'] = $('#product-text-color-input').value;
                        siteSettings['sale-price-color'] = $('#sale-price-color-input').value;
                        siteSettings['original-price-color'] = $('#original-price-color-input').value;
                        siteSettings['sale-badge-bg-color'] = $('#sale-badge-bg-color-input').value;
                        siteSettings['sale-badge-text-color'] = $('#sale-badge-text-color-input').value;
                        siteSettings['sold-badge-bg-color'] = $('#sold-badge-bg-color-input').value;
                        siteSettings['sold-badge-text-color'] = $('#sold-badge-text-color-input').value;
                        siteSettings['star-color'] = $('#star-color-input').value;
                        siteSettings['add-to-cart-btn-bg-color'] = $('#add-to-cart-btn-bg-color-input').value;
                        siteSettings['add-to-cart-btn-radius'] = $('#add-to-cart-btn-radius-input').value;
                        siteSettings['view-btn-bg'] = $('#view-btn-bg-input').value;
                        siteSettings['view-btn-text'] = $('#view-btn-text-input').value;
                        siteSettings['view-btn-radius'] = $('#view-btn-radius-input').value;
                        siteSettings['btn-padding'] = $('#btn-padding-input').value;
                        siteSettings['product-name-font'] = $('#product-name-font-select').value;
                        siteSettings['product-name-font-weight'] = $('#product-name-font-weight-select').value;
                        siteSettings['product-price-font'] = $('#product-price-font-select').value;
                        siteSettings['product-price-font-weight'] = $('#product-price-font-weight-select').value;
                        siteSettings['product-price-fontsize'] = $('#product-price-fontsize-input').value;
                        siteSettings['product-detail-subtitle'] = $('#product-detail-subtitle-input').value;
                        siteSettings['product-detail-name-fontsize'] = $('#product-detail-name-fontsize-input').value;
                        siteSettings['product-detail-price-fontsize'] = $('#product-detail-price-fontsize-input').value;
                        siteSettings['pd-original-price-font'] = $('#pd-original-price-font-select').value;
                        siteSettings['pd-original-price-font-weight'] = $('#pd-original-price-font-weight-select').value;
                        siteSettings['pd-original-price-color'] = $('#pd-original-price-color-input').value;
                        siteSettings['pd-sale-price-font'] = $('#pd-sale-price-font-select').value;
                        siteSettings['pd-sale-price-font-weight'] = $('#pd-sale-price-font-weight-select').value;
                        siteSettings['pd-sale-price-color'] = $('#pd-sale-price-color-input').value;
                        siteSettings['feature1-text'] = $('#feature1-text-input').value;
                        siteSettings['feature1-icon-input'] = $('#feature1-icon-input').value;
                        siteSettings['feature2-text'] = $('#feature2-text-input').value;
                        siteSettings['feature2-icon-input'] = $('#feature2-icon-input').value;
                        siteSettings['feature3-text'] = $('#feature3-text-input').value;
                        siteSettings['feature3-icon-input'] = $('#feature3-icon-input').value;
                        siteSettings['product-stock-status-size'] = $('#product-stock-status-size-input').value;
                        break;
                    case 'categories':
                        siteSettings['category-images-enabled'] = $('#category-images-enabled-input').checked;
                        siteSettings['category-modal-logo'] = $('#category-modal-logo-input').value;
                        siteSettings['modal-logo-animation'] = $('#modal-logo-animation-select').value;
                        siteSettings['category-banner-height'] = $('#category-banner-height-input').value;
                        siteSettings['category-btn-color1'] = $('#category-btn-color1-input').value;
                        siteSettings['category-btn-color2'] = $('#category-btn-color2-input').value;
                        const updatedCategories = [];
                        $$('#admin-categories-list .admin-category-card').forEach(card => {
                            const id = card.dataset.id;
                            const name = card.querySelector('.category-name-input').value;
                            const image = card.querySelector('.category-image-input').value;
                            const displayImage = card.querySelector('.category-display-image-input').value;
                            if (name && image) updatedCategories.push({ id, name, image, displayImage });
                        });
                        categories = updatedCategories;
                        break;
                    case 'orders':
                        siteSettings['order-id-prefix'] = $('#order-id-prefix-input').value;
                        siteSettings['order-success-header'] = $('#order-success-header-input').value;
                        siteSettings['order-success-message'] = $('#order-success-message-input').value;
                        break;
                    case 'spin-wheel':
                        siteSettings['spin-wheel-enabled'] = $('#spin-wheel-enabled-input').checked;
                        siteSettings['luck-game-type'] = $('#luck-game-type-select').value;
                        siteSettings['spin-wheel-logo'] = $('#spin-wheel-logo-input').value;
                        siteSettings['spin-wheel-logo-animation'] = $('#spin-wheel-logo-animation-select').value;
                        siteSettings['crate-closed-image'] = $('#crate-closed-image-input').value;
                        siteSettings['crate-open-image'] = $('#crate-open-image-input').value;
                        break;
                    case 'reviews-manage':
                        siteSettings['reviews-animation-enabled'] = $('#reviews-animation-enabled-input').checked;
                        siteSettings['reviews-animation-direction'] = $('#reviews-animation-direction-select').value;
                        siteSettings['reviews-animation-speed'] = $('#reviews-animation-speed-input').value;
                        siteSettings['reviews-btn-color1'] = $('#reviews-btn-color1-input').value;
                        siteSettings['reviews-btn-color2'] = $('#reviews-btn-color2-input').value;
                        siteSettings['reviews-btn-text-color'] = $('#reviews-btn-text-color-input').value;
                        siteSettings['all-reviews-header-image'] = $('#all-reviews-header-image-input').value;
                        siteSettings['all-reviews-url'] = $('#all-reviews-url-input').value;
                        siteSettings['all-reviews-url-text'] = $('#all-reviews-url-text-input').value;
                        siteSettings['review-font-family'] = $('#review-font-family-select').value;
                        siteSettings['review-font-weight'] = $('#review-font-weight-select').value;
                        siteSettings['review-text-color'] = $('#review-text-color-input').value;
                        siteSettings['review-font-size'] = $('#review-font-size-input').value;
                        break;
                    case 'whatsapp':
                        siteSettings['whatsapp-template'] = $('#whatsapp-message-template').value;
                        siteSettings['whatsapp-contact-template'] = $('#whatsapp-contact-template').value;
                        break;
                    case 'footer':
                        siteSettings['footer-bg-color'] = $('#footer-bg-color-input').value;
                        siteSettings['footer-store-locator'] = $('#footer-store-locator-input').value;
                        siteSettings['footer-phone'] = $('#footer-phone-input').value;
                        siteSettings['footer-email'] = $('#footer-email-input').value;
                        siteSettings['footer-address'] = $('#footer-address-input').value;
                        siteSettings['footer-tiktok'] = $('#footer-tiktok-input').value;
                        siteSettings['footer-instagram'] = $('#footer-instagram-input').value;
                        siteSettings['footer-facebook'] = $('#footer-facebook-input').value;
                        siteSettings['footer-tiktok-icon'] = $('#footer-tiktok-icon-input').value;
                        siteSettings['footer-instagram-icon'] = $('#footer-instagram-icon-input').value;
                        siteSettings['footer-facebook-icon'] = $('#footer-facebook-icon-input').value;
                        break;
                    case 'pages':
                        siteSettings['shipping-policy-title'] = $('#shipping-policy-title-input').value;
                        siteSettings['shipping-policy-content'] = $('#shipping-policy-content-input').value;
                        siteSettings['shipping-policy-image'] = $('#shipping-policy-image-input').value;
                        siteSettings['faq-title'] = $('#faq-title-input').value;
                        siteSettings['faq-content'] = $('#faq-content-input').value;
                        siteSettings['faq-image'] = $('#faq-image-input').value;
                        siteSettings['about-us-title'] = $('#about-us-title-input').value;
                        siteSettings['about-us-content'] = $('#about-us-content-input').value;
                        siteSettings['about-us-image'] = $('#about-us-image-input').value;
                        siteSettings['payment-methods-title'] = $('#payment-methods-title-input').value;
                        siteSettings['payment-methods-image'] = $('#payment-methods-image-input').value;
                        const paymentMethods = [];
                        $$('#payment-methods-list .payment-method-card').forEach(card => {
                            paymentMethods.push({
                                id: card.dataset.id,
                                title: card.querySelector('.payment-title-input').value,
                                image: card.querySelector('.payment-image-input').value,
                                details: card.querySelector('.payment-details-input').value,
                            });
                        });
                        siteSettings['payment-methods'] = paymentMethods;
                        break;
                    case 'settings':
                        siteSettings['tab-title'] = $('#tab-title-input').value;
                        siteSettings['favicon-url'] = $('#favicon-url-input').value;
                        siteSettings['meta-keywords'] = $('#meta-keywords-input').value;
                        siteSettings['meta-description'] = $('#meta-description-input').value;
                        siteSettings['ownerWhatsapp'] = $('#owner-whatsapp-input').value;
                        siteSettings['cartIconSvg'] = $('#cart-icon-svg-input').value;
                        siteSettings['adminIconSvg'] = $('#admin-icon-svg-input').value;
                        siteSettings['userIconSvg'] = $('#user-icon-svg-input').value;
                        break;
                    case 'tickets':
                        siteSettings['ticketButtonEnabled'] = $('#ticket-button-enabled-input').checked;
                        siteSettings['support-btn-color1'] = $('#support-btn-color1-input').value;
                        siteSettings['support-btn-color2'] = $('#support-btn-color2-input').value;
                        siteSettings['support-btn-text-color'] = $('#support-btn-text-color-input').value;
                        siteSettings['supportIconSvg'] = $('#support-icon-svg-input').value;
                        const subjects = [];
                        $$('#admin-ticket-subjects-list input.ticket-subject-input').forEach(input => {
                            if(input.value) subjects.push(input.value)
                        });
                        siteSettings['ticketSubjects'] = subjects;
                        break;
                    default:
                        break;
                }
            };
            
            function handleFileUpload(event) {
                const file = event.target.files[0];
                const targetInputId = event.target.dataset.target;
                if (!file || !targetInputId) return;
                const targetInput = $(`#${targetInputId}`);
                if (!targetInput) return;

                const storageRef = ref(storage, `uploads/${Date.now()}-${file.name}`);
                uploadBytes(storageRef, file).then((snapshot) => {
                    getDownloadURL(snapshot.ref).then((downloadURL) => { if (targetInput.tagName.toLowerCase() === 'textarea') {
                             targetInput.value += (targetInput.value ? '\n' : '') + downloadURL;
                        } else {
                            targetInput.value = downloadURL;
                        }
                        targetInput.dispatchEvent(new Event('input')); 
                        showToast("File uploaded!", null, true);
                    });
                }).catch((error) => {
                    console.error("Upload failed", error);
                    showToast("Upload failed. This usually happens when running the page as a local file. Please use a web server.", null, false);
                });
            }
            
            const populateAdminUI = () => {
                const setValue = (id, value) => {
                    const el = $(`#${id}`);
                    if (el) {
                        if (el.type === 'checkbox') {
                            el.checked = value;
                        } else {
                            // Ensure null/undefined becomes an empty string
                            el.value = value || '';
                        }
                    }
                };

                // --- Generic Population for most fields ---
                for (const key in siteSettings) {
                    if (key === 'whyUs') { // Handle nested objects separately
                        setValue('why-us-title-input', siteSettings.whyUs.title);
                        setValue('why-us-subtitle-input', siteSettings.whyUs.subtitle);
                        setValue('why-us-item1-title-input', siteSettings.whyUs.item1_title);
                        setValue('why-us-item1-desc-input', siteSettings.whyUs.item1_desc);
                        setValue('why-us-item2-title-input', siteSettings.whyUs.item2_title);
                        setValue('why-us-item2-desc-input', siteSettings.whyUs.item2_desc);
                        setValue('why-us-item3-title-input', siteSettings.whyUs.item3_title);
                        setValue('why-us-item3-desc-input', siteSettings.whyUs.item3_desc);
                    } else {
                        const id = key.replace(/_/g, '-');
                        // Try to find inputs with common suffixes
                        setValue(`${id}-input`, siteSettings[key]);
                        setValue(`${id}-select`, siteSettings[key]);
                        setValue(id, siteSettings[key]);
                    }
                }

                const colorSettings = [
                    'announcement-bg-color', 'secondary-announcement-bg-color', 'secondary-announcement-text-color',
                    'product-card-bg-color', 'product-text-color', 'sale-price-color', 'original-price-color',
                    'sale-badge-bg-color', 'sale-badge-text-color', 'sold-badge-bg-color', 'sold-badge-text-color',
                    'add-to-cart-btn-bg-color', 'view-btn-bg', 'view-btn-text', 'category-btn-color1',
                    'category-btn-color2', 'footer-bg-color', 'reviews-btn-color1', 'reviews-btn-color2', 'reviews-btn-text-color',
                    'star-color', 'support-btn-color1', 'support-btn-color2', 'support-btn-text-color',
                    'pd-original-price-color', 'pd-sale-price-color', 'review-text-color'
                ];
                
                colorSettings.forEach(key => {
                    if ($(`#${key}-input`)) {
                        $(`#${key}-input`).value = siteSettings[key] || '#000000';
                    }
                });

                // --- Update Range Slider Text Values ---
                if ($('#store-logo-width-value')) $('#store-logo-width-value').textContent = siteSettings['store-logo-width'];
                if ($('#store-logo-height-value')) $('#store-logo-height-value').textContent = siteSettings['store-logo-height'];
                if ($('#category-banner-height-value')) $('#category-banner-height-value').textContent = siteSettings['category-banner-height'];
                if ($('#pd-name-fs-val')) $('#pd-name-fs-val').textContent = siteSettings['product-detail-name-fontsize'];
                if ($('#pd-price-fs-val')) $('#pd-price-fs-val').textContent = siteSettings['product-detail-price-fontsize'];
                if ($('#pd-stock-fs-val')) $('#pd-stock-fs-val').textContent = siteSettings['product-stock-status-size'];
                if ($('#product-price-fs-val')) $('#product-price-fs-val').textContent = siteSettings['product-price-fontsize'];
                if ($('#review-font-size-val')) $('#review-font-size-val').textContent = siteSettings['review-font-size'];

                populateCategoryDropdown();
                updateSiteSEOPreview();
                updateReviewsButtonPreview();
                updateSupportButtonPreview();
                updateFontPreview();
                updateReviewStylePreview();
                renderAdminUserManagement();
            };
            
            const populateCategoryDropdown = () => {
                const select = $('#product-category-select');
                if (!select) return;
                select.innerHTML = `<option value="">Select a Category</option>` + categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            };
            
            const openProductDetail = (productId, shouldUpdateUrl = true) => {
                const product = products.find(p => p.id == productId);
                if (!product) return;
                currentDetailProductId = productId;

                if(shouldUpdateUrl) {
                    const slug = product.name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                    updateUrl(`/products/${slug}`);
                }

                // Increment view count
                product.views = (product.views || 0) + 1;
            
                $('#product-detail-name').textContent = product.name;
                $('#product-detail-subtitle').textContent = product.subtitle || siteSettings['product-detail-subtitle'];
                $('#product-detail-description').innerHTML = product.description?.replace(/\n/g, '<br>');
                $('#product-detail-view-count span').textContent = `${product.views} views`;
                
                const onSale = product.salePrice && product.salePrice < product.price;
                const priceContainer = $('#product-detail-price');
                const salePriceEl = priceContainer.querySelector('.price-sale');
                const originalPriceEl = priceContainer.querySelector('.price-original');
                
                salePriceEl.textContent = `Rs. ${(onSale ? product.salePrice : product.price).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                
                if(onSale) {
                    originalPriceEl.textContent = `Rs. ${product.price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    originalPriceEl.classList.remove('hidden');
                } else {
                    originalPriceEl.classList.add('hidden');
                }

                $('#product-detail-add-to-cart-btn').dataset.id = product.id;
            
                renderProductDetailColorSwatches(product);
                renderProductMedia(product, product.variants && product.variants.length > 0 ? product.variants[0] : null);
                renderStockStatus(product, 1, product.variants && product.variants.length > 0 ? product.variants[0] : null);
                updateProductDetailRatingView(product);
                renderProductDetailFeatures();
                startProductDetailCountdown();
                updateAddToCartButtonPrice();
                openModal('product-detail');
                saveDataToFirestore({ rerenderProducts: false, showAdminToast: false });
            };

            const renderStockStatus = (product, quantity, selectedVariant = null) => {
                const stock = selectedVariant ? selectedVariant.stock : (product.variants && product.variants.length > 0 ? product.variants.reduce((sum, v) => sum + (parseInt(v.stock) || 0), 0) : product.stock || 0);
                const stockStatusEl = $('#product-detail-stock-status');
                const btn = $('#product-detail-add-to-cart-btn');

                if (stock <= 0) {
                     stockStatusEl.innerHTML = `<svg class="text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg> <span class="stock-status-text shiny-red">Out of Stock</span>`;
                    btn.disabled = true;
                } else if (stock < 10) {
                     stockStatusEl.innerHTML = `<svg class="text-orange-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.763-1.36 2.723-1.36 3.486 0l5.58 9.92c.75 1.334-.231 3.031-1.743 3.031H4.42c-1.512 0-2.493-1.697-1.743-3.031l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg> <span class="stock-status-text shiny-orange">Low Stock</span>`;
                    btn.disabled = false;
                } else {
                    stockStatusEl.innerHTML = `<svg class="text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg> <span class="stock-status-text shiny-green">In Stock</span>`;
                    btn.disabled = false;
                }
            };
            
            const renderProductMedia = (product, selectedVariant = null) => {
                stopProductDetailSlideshow(); 
                currentDetailMediaIndex = 0;
                currentDetailMediaAssets = [];

                const mainImages = product.galleryImages || [];
                const mainVideo = product.videoUrl;
                
                // Collect all unique media assets
                const allAssets = new Map();

                // Add main images and video first
                mainImages.forEach(imgUrl => {
                    if (imgUrl && !allAssets.has(imgUrl)) {
                        allAssets.set(imgUrl, { type: 'image', url: imgUrl, thumb: imgUrl });
                    }
                });
                if (mainVideo && !allAssets.has(mainVideo)) {
                    allAssets.set(mainVideo, { type: 'video', url: mainVideo, thumb: mainImages[0] || 'https://placehold.co/100x100?text=Video' });
                }

                // Add variant-specific media
                if (product.variants && product.variants.length > 0) {
                    product.variants.forEach(v => {
                        if (v.image && !allAssets.has(v.image)) {
                             allAssets.set(v.image, { type: 'image', url: v.image, thumb: v.image });
                        }
                        if (v.videoUrl && !allAssets.has(v.videoUrl)) {
                            allAssets.set(v.videoUrl, { type: 'video', url: v.videoUrl, thumb: v.image || mainImages[0] });
                        }
                    });
                }
                
                currentDetailMediaAssets = Array.from(allAssets.values());

                if (currentDetailMediaAssets.length === 0) {
                    currentDetailMediaAssets.push({ type: 'image', url: 'https://placehold.co/600x600/eee/ccc?text=No+Image', thumb: 'https://placehold.co/100x100/eee/ccc?text=No+Image' });
                }

                // Set initial index based on selected variant if available
                if(selectedVariant && selectedVariant.image) {
                    const variantIndex = currentDetailMediaAssets.findIndex(asset => asset.url === selectedVariant.image);
                    if(variantIndex !== -1) currentDetailMediaIndex = variantIndex;
                }

                updateProductMediaView();

                if (currentDetailMediaAssets.filter(a => a.type === 'image').length > 1) {
                    startProductDetailSlideshow();
                }
            };

            const updateProductMediaView = () => {
                const thumbnailsContainer = $('#product-detail-thumbnails');
                const dotsContainer = $('#product-detail-dots');
                
                thumbnailsContainer.innerHTML = currentDetailMediaAssets.map((asset, index) => `
                    <div class="media-thumbnail flex-shrink-0 ${index === currentDetailMediaIndex ? 'active' : ''}" data-index="${index}">
                        <img src="${asset.thumb}" class="w-20 h-20 object-cover rounded-md">
                        ${asset.type === 'video' ? `<div class="play-icon"><svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm3.586 2.586a.5.5 0 01.707 0l4.414 4.414a.5.5 0 010 .707l-4.414 4.414a.5.5 0 01-.707-.707L11.586 10 7.586 5.999a.5.5 0 010-.707z" clip-rule="evenodd"></path></svg></div>` : ''}
                    </div>
                `).join('');

                dotsContainer.innerHTML = currentDetailMediaAssets.map((_, index) => `
                    <button class="h-2 w-2 rounded-full ${index === currentDetailMediaIndex ? 'bg-gray-800' : 'bg-gray-300'}" data-index="${index}"></button>
                `).join('');

                if (currentDetailMediaAssets.length > 0) {
                    const currentAsset = currentDetailMediaAssets[currentDetailMediaIndex];
                    displayMedia(currentAsset.type, currentAsset.url);
                }
            };
            
            const displayMedia = (type, url) => {
                const displayArea = $('#product-detail-media-display');
                let content = '';
                if (type === 'image') {
                    content = `<img src="${url}" alt="Product Image" class="w-full h-full object-cover rounded-lg">`;
                } else if (type === 'video') {
                    if (url.includes("youtube.com") || url.includes("youtu.be")) {
                        const videoId = url.split('v=')[1]?.split('&')[0] || url.split('/').pop();
                        const embedUrl = `https://www.youtube.com/embed/${videoId}`;
                        content = `<iframe class="w-full h-full aspect-video" src="${embedUrl}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
                    } else {
                        content = `<video controls class="w-full h-full object-contain rounded-lg"><source src="${url}" type="video/mp4">Your browser does not support the video tag.</video>`;
                    }
                }
                displayArea.innerHTML = content;
            };
            
            function startProductDetailSlideshow() {
                stopProductDetailSlideshow();
                const imageAssets = currentDetailMediaAssets.filter(a => a.type === 'image');
                if (imageAssets.length <= 1) return;

                productDetailSlideshowInterval = setInterval(() => {
                    let nextIndex = (currentDetailMediaIndex + 1) % currentDetailMediaAssets.length;
                    while (currentDetailMediaAssets[nextIndex].type !== 'image') {
                        nextIndex = (nextIndex + 1) % currentDetailMediaAssets.length;
                        if(nextIndex === currentDetailMediaIndex) return; 
                    }
                    currentDetailMediaIndex = nextIndex;
                    updateProductMediaView();
                }, 4000); 
            }

            function stopProductDetailSlideshow() {
                if (productDetailSlideshowInterval) {
                    clearInterval(productDetailSlideshowInterval);
                    productDetailSlideshowInterval = null;
                }
            }

            const renderProductDetailColorSwatches = (product) => {
                const container = $('#product-detail-variants-container');
                if (!product.variants || product.variants.length === 0) {
                    container.innerHTML = '';
                    return;
                }
                container.innerHTML = `
                    <h3 class="font-bold text-md mb-2 text-gray-800">Color</h3>
                    <div class="flex items-center gap-2">
                        ${product.variants.map((v, index) =>
                            `<div class="color-swatch ${index === 0 ? 'selected' : ''}" style="background-color: ${v.colorHex};" data-color-name="${v.colorName}" title="${v.colorName}"></div>`
                        ).join('')}
                    </div>`;
            };

            const updateProductDetailRatingView = (product) => {
                const ratings = product.ratings || [];
                const ratingCount = ratings.length;
                const avgRating = ratingCount > 0 ? ratings.reduce((sum, r) => sum + r.rating, 0) / ratingCount : 0;
                $('#product-detail-rating-display').innerHTML = getStarRatingHTML(avgRating.toFixed(1), ratingCount);
                const ratingInputArea = $('#rating-input-area');
                const ratingLoginPrompt = $('#rating-login-prompt');
                if (currentUser) {
                    ratingInputArea.classList.remove('hidden'); ratingLoginPrompt.classList.add('hidden');
                    const userRating = ratings.find(r => r.userId === currentUser.uid);
                    $$('.star-rating-input input').forEach(input => input.checked = userRating && parseInt(input.value) === userRating.rating);
                } else {
                    ratingInputArea.classList.add('hidden'); ratingLoginPrompt.classList.remove('hidden');
                }
            };
            
            const renderProductDetailFeatures = () => {
                const container = $('#product-detail-features');
                if (!container) return;
                let html = '';
                const features = [
                    { text: siteSettings['feature1-text'], icon: siteSettings['feature1-icon-input'] },
                    { text: siteSettings['feature2-text'], icon: siteSettings['feature2-icon-input'] },
                    { text: siteSettings['feature3-text'], icon: siteSettings['feature3-icon-input'] },
                ];
                 features.forEach(feature => {
                    if (feature.text && feature.icon) {
                        let iconHtml = '';
                        const iconValue = feature.icon.trim();
                        if (iconValue.startsWith('<svg')) {
                            iconHtml = iconValue;
                        } else if (iconValue) { 
                            iconHtml = `<img src="${iconValue}" alt="${feature.text}" class="w-6 h-6 object-contain">`;
                        }
                        html += `<div class="flex items-center gap-4"><div class="w-6 h-6 flex items-center justify-center">${iconHtml}</div><span>${feature.text}</span></div>`;
                    }
                });
                container.innerHTML = html;
            };

            const startCountdown = () => {
                if(countdownInterval) clearInterval(countdownInterval);
                const endDate = siteSettings['sale-end-date'];
                const countdownElements = $$('[id^="countdown-container"]');
                if (!endDate) {
                    countdownElements.forEach(el => el.innerHTML = '');
                    return;
                }
                countdownElements.forEach(el => {
                    el.innerHTML = `<span class="py-2 pr-2 inline-block">${siteSettings['sale-message']}</span>
                    <div class="countdown-container-outer">
                        <div class="timer-box"><span class="timer-digits" data-unit="days">00</span><span class="timer-label">Days</span></div>
                        <div class="timer-box"><span class="timer-digits" data-unit="hours">00</span><span class="timer-label">Hours</span></div>
                        <div class="timer-box"><span class="timer-digits" data-unit="minutes">00</span><span class="timer-label">Minutes</span></div>
                        <div class="timer-box"><span class="timer-digits" data-unit="seconds">00</span><span class="timer-label">Seconds</span></div>
                    </div>`;
                });

                const tick = () => {
                    const distance = new Date(endDate).getTime() - new Date().getTime();
                    if(distance < 0) {
                        clearInterval(countdownInterval);
                        countdownElements.forEach(el => el.textContent = "Sale has ended!");
                        return;
                    }
                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                    
                    $$('[data-unit="days"]').forEach(el => el.textContent = String(days).padStart(2, '0'));
                    $$('[data-unit="hours"]').forEach(el => el.textContent = String(hours).padStart(2, '0'));
                    $$('[data-unit="minutes"]').forEach(el => el.textContent = String(minutes).padStart(2, '0'));
                    $$('[data-unit="seconds"]').forEach(el => el.textContent = String(seconds).padStart(2, '0'));
                }
                
                tick();
                countdownInterval = setInterval(tick, 1000);
            };

            const startProductDetailCountdown = () => {
                if(productDetailCountdownInterval) clearInterval(productDetailCountdownInterval);
                const endDate = siteSettings['sale-end-date'];
                const container = $('#product-detail-sale-countdown');
                if (!endDate || new Date(endDate).getTime() < Date.now()) {
                    container.classList.add('hidden');
                    return;
                }

                container.classList.remove('hidden');
                container.innerHTML = `
                    <p class="flash-sale-title"> Flash Sale Ends In </p>
                    <div class="countdown-container-outer justify-center">
                        <div class="timer-box"><span class="timer-digits" data-unit="days-detail">00</span><span class="timer-label">Days</span></div>
                        <div class="timer-box"><span class="timer-digits" data-unit="hours-detail">00</span><span class="timer-label">Hours</span></div>
                        <div class="timer-box"><span class="timer-digits" data-unit="minutes-detail">00</span><span class="timer-label">Minutes</span></div>
                        <div class="timer-box"><span class="timer-digits" data-unit="seconds-detail">00</span><span class="timer-label">Seconds</span></div>
                    </div>`;

                const tick = () => {
                     const distance = new Date(endDate).getTime() - new Date().getTime();
                     if(distance < 0) {
                         clearInterval(productDetailCountdownInterval);
                         container.classList.add('hidden');
                         return;
                     }
                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                    container.querySelector('[data-unit="days-detail"]').textContent = String(days).padStart(2, '0');
                    container.querySelector('[data-unit="hours-detail"]').textContent = String(hours).padStart(2, '0');
                    container.querySelector('[data-unit="minutes-detail"]').textContent = String(minutes).padStart(2, '0');
                    container.querySelector('[data-unit="seconds-detail"]').textContent = String(seconds).padStart(2, '0');
                };

                tick();
                productDetailCountdownInterval = setInterval(tick, 1000);
            };
            
            const updateAuthUI = (user) => {
                const authContainer = $('#auth-container');
                const adminActionsContainer = $('#admin-actions-container');
                const accountDropdown = $('#account-dropdown');
                const luckGameBtn = $('#spin-now-btn');
                
                adminActionsContainer.innerHTML = ''; 
                if (user) {
                    authContainer.innerHTML = `
                        <div class="notification-badge-container flex items-center gap-2">
                            <span id="user-icon-container"></span>
                            <button id="account-toggle-btn" class="text-gray-600 hover:text-black transition">My Account</button>
                        </div>`;
                    updateIcon('user-icon-container', siteSettings.userIconSvg, '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>');
                    
                    if (siteSettings.adminEmails.includes(user.email)) {
                        adminActionsContainer.innerHTML = `
                            <div class="notification-badge-container">
                                <button id="admin-login-btn" class="text-gray-600 hover:text-black transition ml-4">
                                    <span id="admin-icon-container"></span>
                                </button>
                            </div>`;
                        updateIcon('admin-icon-container', siteSettings.adminIconSvg, '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>');
                    }
                    if(luckGameBtn) {
                        luckGameBtn.disabled = false;
                        const gameType = siteSettings['luck-game-type'] || 'wheel';
                        luckGameBtn.textContent = gameType === 'wheel' ? 'Spin Now' : 'Open Chest';
                    }
                } else {
                    authContainer.innerHTML = `
                        <button id="auth-icon-btn" class="text-gray-600 hover:text-black transition">
                             <span id="user-icon-container"></span>
                        </button>
                        <div id="auth-dropdown" class="hidden p-4 space-y-3">
                            <button type="button" id="auth-dropdown-login-link" class="block text-left w-full text-gray-700 hover:text-black">Login</button>
                            <button type="button" id="auth-dropdown-signup-link" class="block text-left w-full text-gray-700 hover:text-black">Sign Up</button>
                        </div>
                    `;
                    updateIcon('user-icon-container', siteSettings.userIconSvg, '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>');
                    accountDropdown.classList.add('hidden');
                    if(luckGameBtn) {
                        luckGameBtn.disabled = true;
                        luckGameBtn.textContent = 'Login to Play';
                    }
                }
            };

            async function init() {
                await loadDataFromFirestore();
                loadCartFromLocalStorage();
                applyAllSettings();
                renderProducts(products.filter(p => p.isFeatured == 1), $('#product-grid-1'));
                renderProducts(products.filter(p => p.isFeatured == 2), $('#product-grid-2'));
                renderCategories();
                renderReviews();
                renderAdminPanels();
                renderAdminTickets();
                renderDashboard();
                updateCartUI();
                populateAdminUI();
                bindEventListeners();

                // Initial route handling
                router();
                
                 onAuthStateChanged(auth, (user) => {
                     currentUser = user;
                     updateAuthUI(user);
                     // Kill old listeners
                     if(adminNotificationListener) adminNotificationListener();
                     if(userNotificationListener) userNotificationListener();
                     if(userTicketNotificationListener) userTicketNotificationListener();

                     if(user) {
                        if (siteSettings.adminEmails.includes(user.email)) {
                            listenForAdminNotifications();
                        } else {
                            listenForUserNotifications(user.uid);
                            listenForUserTicketNotifications(user.uid);
                        }
                     } else { 
                        // Clear all badges on logout
                        updateNotificationBadge('admin-login-btn', 0);
                        updateNotificationBadge('account-toggle-btn', 0);
                        updateNotificationBadge('account-tab', 0, '[data-tab="messages"]');
                        updateNotificationBadge('account-tab', 0, '[data-tab="tickets"]');
                     }
                 });

                 if(!sessionStorage.getItem('promoShown')) {
                     setTimeout(() => {
                         const promoImg = siteSettings['promo-popup-image'];
                         if(promoImg && promoImg.trim() !== '') {
                            openModal('sale-popup');
                            sessionStorage.setItem('promoShown', 'true');
                         }
                     }, 2500);
                 }
            }
            
            function initHeroSlideshow() {
                if(heroSlideshowInterval) clearInterval(heroSlideshowInterval);
                const container = $('#hero-slideshow-container');
                const images = (siteSettings['hero-images'] || '').split('\n').filter(url => url.trim());
                if (images.length === 0) {
                    container.innerHTML = `<div class="hero-slide active" style="background-image: url('https://placehold.co/1600x900/1a1a1a/ffffff?text=Your+Store+Banner');"></div>`;
                    return;
                }
                container.innerHTML = images.map(img => `<div class="hero-slide" style="background-image: url('${img}');"></div>`).join('');
                const slides = $$('.hero-slide');
                if (slides.length <= 1) {
                    if(slides.length > 0) slides[0].classList.add('active');
                    return;
                }
                let currentSlide = 0;
                slides[currentSlide].classList.add('active');
                heroSlideshowInterval = setInterval(() => {
                    slides[currentSlide].classList.remove('active');
                    currentSlide = (currentSlide + 1) % slides.length;
                    slides[currentSlide].classList.add('active');
                }, 5000);
            }

            function applyReviewAnimationSettings() {
                const track = $('#reviews-grid');
                if (!track) return;
                const enabled = siteSettings['reviews-animation-enabled'];
                if (enabled) {
                    track.style.animationName = siteSettings['reviews-animation-direction'] || 'marquee-scroll-left';
                    track.style.animationDuration = `${siteSettings['reviews-animation-speed'] || '40'}s`;
                } else {
                    track.style.animationName = 'none';
                }
            }
            
            function renderPageModals() {
                // Shipping Policy
                $('#shipping-policy-modal-title').textContent = siteSettings['shipping-policy-title'];
                $('#shipping-policy-modal-content').innerHTML = siteSettings['shipping-policy-content']?.replace(/\n/g, '<br>');
                const shippingImg = $('#shipping-policy-modal-image');
                if (siteSettings['shipping-policy-image']) {
                    shippingImg.src = siteSettings['shipping-policy-image'];
                    shippingImg.classList.remove('hidden');
                } else {
                    shippingImg.classList.add('hidden');
                }

                // FAQ
                $('#faq-modal-title').textContent = siteSettings['faq-title'];
                $('#faq-modal-content').innerHTML = siteSettings['faq-content']?.replace(/\n/g, '<br>');
                const faqImg = $('#faq-modal-image');
                 if (siteSettings['faq-image']) {
                    faqImg.src = siteSettings['faq-image'];
                    faqImg.classList.remove('hidden');
                } else {
                    faqImg.classList.add('hidden');
                }

                // About Us
                $('#about-us-modal-title').textContent = siteSettings['about-us-title'];
                $('#about-us-modal-content').innerHTML = siteSettings['about-us-content']?.replace(/\n/g, '<br>');
                const aboutImg = $('#about-us-modal-image');
                 if (siteSettings['about-us-image']) {
                    aboutImg.src = siteSettings['about-us-image'];
                    aboutImg.classList.remove('hidden');
                } else {
                    aboutImg.classList.add('hidden');
                }

                // Payment Methods
                $('#payment-methods-modal-title').textContent = siteSettings['payment-methods-title'];
                const paymentMethodsImg = $('#payment-methods-modal-image');
                if(siteSettings['payment-methods-image']) {
                    paymentMethodsImg.src = siteSettings['payment-methods-image'];
                    paymentMethodsImg.classList.remove('hidden');
                } else {
                    paymentMethodsImg.classList.add('hidden');
                }
                const paymentMethods = siteSettings['payment-methods'] || [];
                $('#payment-methods-modal-content').innerHTML = paymentMethods.map(method => `
                    <div class="border rounded-lg p-4 text-center cursor-pointer hover:shadow-md transition payment-method-item" data-id="${method.id}">
                        <img src="${method.image}" class="h-20 mx-auto object-contain mb-2">
                        <p class="font-semibold">${method.title}</p>
                    </div>
                `).join('');
            }

            function applySecondaryAnnouncementSettings() {
                const bar = $('#secondary-announcement-bar');
                const contentWrapper = bar.querySelector('.announcement-bar-content');

                if (siteSettings['secondary-announcement-enabled'] && siteSettings['secondary-announcement-text']) {
                    bar.classList.remove('hidden');
                    $('#secondary-announcement-text').textContent = siteSettings['secondary-announcement-text'];
                    $('#secondary-announcement-text-dup').textContent = siteSettings['secondary-announcement-text'];
                    bar.style.backgroundColor = siteSettings['secondary-announcement-bg-color'];
                    bar.style.color = siteSettings['secondary-announcement-text-color'];
                    
                    if (siteSettings['secondary-announcement-animated']) {
                        const direction = siteSettings['secondary-announcement-animation-direction'] === 'scroll-right' ? 'marquee-scroll-right' : 'marquee-scroll-left';
                        contentWrapper.style.animation = `${direction} ${siteSettings['secondary-announcement-animation-speed'] || '40'}s linear infinite`;
                    } else {
                        contentWrapper.style.animation = 'none';
                        contentWrapper.style.transform = 'translateX(0)';
                    }

                } else {
                    bar.classList.add('hidden');
                }
            }

            function applyFeaturedHeaderSettings() {
                if (featuredSlideshowInterval) clearInterval(featuredSlideshowInterval);
                const container = $('#featured-header-image-container');
                const slideshowContainer = $('#featured-slideshow-container');
                const images = (siteSettings['featured-header-images'] || '').split('\n').filter(url => url.trim() !== '');

                if (siteSettings['featured-header-enabled'] && images.length > 0) {
                    container.classList.remove('hidden');
                    slideshowContainer.innerHTML = images.map(img => `<div class="featured-slide" style="background-image: url('${img}');"></div>`).join('');
                    const slides = $$('#featured-slideshow-container .featured-slide');
            
                    if (slides.length > 0) {
                        slides[0].classList.add('active');
                    }

                    if (siteSettings['featured-slideshow-enabled'] && slides.length > 1) {
                        let currentSlide = 0;
                        featuredSlideshowInterval = setInterval(() => {
                            slides[currentSlide].classList.remove('active');
                            currentSlide = (currentSlide + 1) % slides.length;
                            slides[currentSlide].classList.add('active');
                        }, parseInt(siteSettings['featured-slideshow-speed']) || 5000);
                    }
                } else {
                    container.classList.add('hidden');
                }
            }


            function applyAllSettings() {
                $('#meta-keywords').content = siteSettings['meta-keywords'];
                $('#meta-description').content = siteSettings['meta-description'];
                document.title = siteSettings['tab-title'] || `${siteSettings['store-name']} - The Infants World`;
                if (siteSettings['favicon-url']) {
                    $('#favicon').href = siteSettings['favicon-url'];
                }
                const paddingValues = (siteSettings['btn-padding'] || '0.5rem 1rem').split(' ');
                const padY = paddingValues[0];
                const padX = paddingValues[1] || padY;
                
                document.documentElement.style.setProperty('--product-stock-status-font-size', `${siteSettings['product-stock-status-size']}px`);
                document.documentElement.style.setProperty('--product-price-font-size', `${siteSettings['product-price-fontsize']}px`);
                document.documentElement.style.setProperty('--review-font-size', `${siteSettings['review-font-size']}px`);

                const styleSheet = $('#dynamic-styles');
                styleSheet.innerHTML = `
                    :root {
                        --product-card-bg: ${siteSettings['product-card-bg-color']};
                        --add-to-cart-btn-bg: ${siteSettings['add-to-cart-btn-bg-color']};
                        --product-text-color: ${siteSettings['product-text-color']};
                        --original-price-color: ${siteSettings['original-price-color']};
                        --sale-price-color: ${siteSettings['sale-price-color']};
                        --sale-badge-bg: ${siteSettings['sale-badge-bg-color']};
                        --sale-badge-text: ${siteSettings['sale-badge-text-color']};
                        --sold-badge-bg: ${siteSettings['sold-badge-bg-color']};
                        --sold-badge-text: ${siteSettings['sold-badge-text-color']};
                        --btn-padding-y: ${padY};
                        --btn-padding-x: ${padX};
                        --add-to-cart-btn-radius: ${siteSettings['add-to-cart-btn-radius']};
                        --view-btn-radius: ${siteSettings['view-btn-radius']};
                        --view-btn-bg: ${siteSettings['view-btn-bg']};
                        --view-btn-text: ${siteSettings['view-btn-text']};
                        --category-btn-gradient-from: ${siteSettings['category-btn-color1']};
                        --category-btn-gradient-to: ${siteSettings['category-btn-color2']};
                        --product-card-radius: ${siteSettings['product-card-radius']};
                        --product-stock-status-font-size: ${siteSettings['product-stock-status-size']}px;
                        --reviews-btn-gradient-from: ${siteSettings['reviews-btn-color1']};
                        --reviews-btn-gradient-to: ${siteSettings['reviews-btn-color2']};
                        --reviews-btn-text-color: ${siteSettings['reviews-btn-text-color']};
                        --star-color: ${siteSettings['star-color']};
                        --support-btn-gradient-from: ${siteSettings['support-btn-color1']};
                        --support-btn-gradient-to: ${siteSettings['support-btn-color2']};
                        --support-btn-text-color: ${siteSettings['support-btn-text-color']};
                        --product-name-font-family: ${siteSettings['product-name-font']};
                        --product-name-font-weight: ${siteSettings['product-name-font-weight']};
                        --product-price-font-family: ${siteSettings['product-price-font']};
                        --product-price-font-weight: ${siteSettings['product-price-font-weight']};
                        --product-price-font-size: ${siteSettings['product-price-fontsize']}px;
                        --pd-original-price-font-family: ${siteSettings['pd-original-price-font']};
                        --pd-original-price-font-weight: ${siteSettings['pd-original-price-font-weight']};
                        --pd-original-price-color: ${siteSettings['pd-original-price-color']};
                        --pd-sale-price-font-family: ${siteSettings['pd-sale-price-font']};
                        --pd-sale-price-font-weight: ${siteSettings['pd-sale-price-font-weight']};
                        --pd-sale-price-color: ${siteSettings['pd-sale-price-color']};
                        --review-font-family: ${siteSettings['review-font-family']};
                        --review-font-weight: ${siteSettings['review-font-weight']};
                        --review-text-color: ${siteSettings['review-text-color']};
                        --review-font-size: ${siteSettings['review-font-size']}px;
                    }
                    .product-card { background-color: var(--product-card-bg); border-radius: var(--product-card-radius); }
                    .product-card .product-text { color: var(--product-text-color); }
                    .add-to-cart-btn { background-color: var(--add-to-cart-btn-bg); padding: var(--btn-padding-y) var(--btn-padding-x); border-radius: var(--add-to-cart-btn-radius); }
                    .view-product-btn { background-color: var(--view-btn-bg); color: var(--view-btn-text); padding: var(--btn-padding-y) var(--btn-padding-x); border-radius: var(--view-btn-radius); }
                    .price-original { color: var(--original-price-color); }
                    .price-sale { color: var(--sale-price-color); }
                    .sale-badge { background-color: var(--sale-badge-bg); color: var(--sale-badge-text); }
                    .sold-badge { background-color: var(--sold-badge-bg); color: var(--sold-badge-text); }
                    .category-btn { background-image: linear-gradient(to right, var(--category-btn-gradient-from), var(--category-btn-gradient-to), var(--category-btn-gradient-from)); }
                    .stock-status-container { font-size: var(--product-stock-status-font-size); }
                    #floating-reviews-btn { background: linear-gradient(135deg, var(--reviews-btn-gradient-from), var(--reviews-btn-gradient-to)); color: var(--reviews-btn-text-color); }
                    #floating-reviews-btn:hover { background: linear-gradient(135deg, var(--reviews-btn-gradient-to), var(--reviews-btn-gradient-from)); }
                    #floating-support-btn { background: linear-gradient(135deg, var(--support-btn-gradient-from), var(--support-btn-gradient-to)); color: var(--support-btn-text-color); }
                    .star-rating-display, .review-star-animated, .star-rating-input input:checked ~ label, .star-rating-input label:hover, .star-rating-input label:hover ~ label { color: var(--star-color); }
                    .product-card-name { font-family: var(--product-name-font-family); font-weight: var(--product-name-font-weight); }
                    .product-card-price { font-family: var(--product-price-font-family); font-weight: var(--product-price-font-weight); font-size: var(--product-price-font-size); }
                    .product-card .price-original { font-size: 0.8em; }
                    #product-detail-price .price-original { font-family: var(--pd-original-price-font-family); font-weight: var(--pd-original-price-font-weight); color: var(--pd-original-price-color); }
                    #product-detail-price .price-sale { font-family: var(--pd-sale-price-font-family); font-weight: var(--pd-sale-price-font-weight); color: var(--pd-sale-price-color); }
                    .review-card .review-quote { font-family: var(--review-font-family); font-weight: var(--review-font-weight); color: var(--review-text-color); font-size: var(--review-font-size); }
                    @keyframes star-glow-inline {
                        0%, 100% { filter: drop-shadow(0 0 1px var(--star-color)); }
                        50% { filter: drop-shadow(0 0 5px var(--star-color)); }
                    }
                `;
                
                const storeLogo = $('#store-logo');
                storeLogo.src = siteSettings['store-logo'];
                storeLogo.style.width = `${siteSettings['store-logo-width']}px`;
                storeLogo.style.height = `${siteSettings['store-logo-height']}px`;

                $('#store-name').textContent = siteSettings['store-name'];
                const navElement = $('header nav');
                navElement.classList.remove('justify-start', 'justify-center', 'justify-between');
                if (siteSettings['store-name-align']) {
                    navElement.classList.add(siteSettings['store-name-align']);
                }
                $('#store-name').className = `text-2xl font-bold ${siteSettings['store-font']}`;
                $('#announcement-text-1').textContent = siteSettings['announcement-text'];
                $('#announcement-text-1-dup').textContent = siteSettings['announcement-text'];
                $('#announcement-bar').style.backgroundColor = siteSettings['announcement-bg-color'];
             
                const heroTitle = $('#hero-title'), heroSubtitle = $('#hero-subtitle'), heroTypewriter = $('#hero-typewriter-wrapper');
                if (siteSettings['hero-text-visible']) {
                    [heroTitle, heroSubtitle, heroTypewriter].forEach(el => el.style.display = '');
                    heroTitle.textContent = siteSettings['hero-title'];
                    heroSubtitle.textContent = siteSettings['hero-subtitle'];
                    heroTitle.className = `mb-4 ${siteSettings['hero-font']} ${siteSettings['hero-animation']}`;
                    heroTitle.style.fontSize = `${siteSettings['hero-title-fontsize']}rem`;
                    heroTitle.style.lineHeight = '1.1';
                    heroSubtitle.style.fontSize = `${siteSettings['hero-subtitle-fontsize']}rem`;
                } else {
                    [heroTitle, heroSubtitle, heroTypewriter].forEach(el => el.style.display = 'none');
                }
                $('#category-modal-banner').style.height = `${siteSettings['category-banner-height']}px`;
                const catModalLogo = $('#category-modal-logo');
                if(siteSettings['category-modal-logo']){
                    catModalLogo.src = siteSettings['category-modal-logo'];
                    catModalLogo.classList.remove('hidden');
                } else {
                    catModalLogo.classList.add('hidden');
                }
                const reviewsHeaderImg = $('#all-reviews-header-image');
                if(siteSettings['all-reviews-header-image']) {
                    reviewsHeaderImg.src = siteSettings['all-reviews-header-image'];
                    reviewsHeaderImg.style.height = `${siteSettings['category-banner-height']}px`;
                    reviewsHeaderImg.classList.remove('hidden');
                } else {
                     reviewsHeaderImg.classList.add('hidden');
                }

                $('#featured-row-1-title').textContent = siteSettings['featured-row-1-title'];
                $('#featured-row-2-title').textContent = siteSettings['featured-row-2-title'];

                $('#footer-store-locator-link').href = siteSettings['footer-store-locator'];
                $('#nav-dropdown-store-locator').href = siteSettings['footer-store-locator'];

                if (siteSettings.ticketButtonEnabled) {
                    $('#floating-support-btn').classList.remove('hidden');
                } else {
                    $('#floating-support-btn').classList.add('hidden');
                }
                
                updateIcon('cart-icon-container', siteSettings.cartIconSvg, '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>');
                updateIcon('support-icon-container', siteSettings.supportIconSvg, '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>');

                applySecondaryAnnouncementSettings();
                applyFeaturedHeaderSettings();
                initHeroSlideshow(); renderWhyUs();
                $('footer').style.backgroundColor = siteSettings['footer-bg-color'];
                renderFooter(); renderPageModals(); startCountdown();
             
                $('#sale-popup-image').src = siteSettings['promo-popup-image'];
                $('#sale-popup-title').textContent = siteSettings['promo-popup-title'];
                $('#sale-popup-text').textContent = siteSettings['promo-popup-text'];
            
                applyReviewAnimationSettings();
                applyLuckGameSettings();
                renderWhatsappPreviews();
                renderAllReviewsModal(); // To apply URL button setting
            }
        
            function applyLivePreview(input) {
                const targets = document.querySelectorAll(input.dataset.target);
                const property = input.dataset.property || 'textContent'; 
                targets.forEach(target => {
                    if (property === 'src') target.src = input.value;
                    else target.textContent = input.value;
                });
            }

            function renderDeletedOrders() {
                const list = $('#admin-deleted-orders-list');
                if (!list) return;

                if (deletedOrders.length === 0) {
                    list.innerHTML = `<p class="text-gray-500 text-center">No deleted orders.</p>`;
                    return;
                }

                list.innerHTML = [...deletedOrders].reverse().map(order => {
                    const customer = order.customer || { name: 'N/A' };
                    return `
                    <div class="admin-order-card opacity-70" data-id="${order.id}">
                        <div class="flex justify-between items-start">
                           <div>
                                <p class="font-bold text-lg">Order #${order.id}</p>
                                <p>${customer.name} - ${new Date(order.date).toLocaleString()}</p>
                           </div>
                           <div class="text-right">
                               <p class="font-bold text-lg">Rs. ${order.total.toLocaleString()}</p>
                               <button class="restore-order-btn text-green-600 hover:underline text-sm font-semibold" data-id="${order.id}">Restore</button>
                           </div>
                        </div>
                    </div>`;
                }).join('');
            }


            function bindEventListeners() {
                 // Listen for hash changes to handle routing
                window.addEventListener('hashchange', router);

                $$('.file-input').forEach(input => input.addEventListener('change', handleFileUpload));
                $('#admin-tab-general').addEventListener('input', e => { 
                    if (e.target.classList.contains('live-preview')) applyLivePreview(e.target);
                    if(e.target.id === 'store-logo-width-input') {
                        const val = e.target.value;
                        $('#store-logo').style.width = `${val}px`;
                        $('#store-logo-width-value').textContent = val;
                    }
                    if(e.target.id === 'store-logo-height-input') {
                        const val = e.target.value;
                        $('#store-logo').style.height = `${val}px`;
                        $('#store-logo-height-value').textContent = val;
                    }
                });
            
                $('#admin-tab-categories').addEventListener('input', e => {
                    if(e.target.id === 'category-banner-height-input') {
                        const val = e.target.value;
                        $('#category-modal-banner').style.height = `${val}px`;
                        $('#category-banner-height-value').textContent = val;
                    }
                });

                $('#admin-panel-modal').addEventListener('input', e => {
                    const el = e.target;
                    const cssVar = el.dataset.cssVar;
                    if (cssVar) {
                        document.documentElement.style.setProperty(cssVar, el.value);
                    }
                    if(el.id === 'btn-padding-input') {
                        const [padY, padX] = el.value.split(' ');
                        document.documentElement.style.setProperty('--btn-padding-y', padY);
                        document.documentElement.style.setProperty('--btn-padding-x', padX || padY);
                    }
                    if (el.id === 'product-detail-name-fontsize-input') {
                        $('#pd-name-fs-val').textContent = el.value;
                        $('#product-detail-name-preview').style.fontSize = `${el.value}px`;
                    }
                    if (el.id === 'product-detail-price-fontsize-input') {
                        $('#pd-price-fs-val').textContent = el.value;
                        $('#product-detail-price-preview .price-sale').style.fontSize = `${el.value}px`;
                        $('#product-detail-price-preview .price-original').style.fontSize = `${el.value * 0.7}px`;
                    }
                    if (el.id === 'product-price-fontsize-input') {
                        const size = el.value;
                        $('#product-price-fs-val').textContent = size;
                         $('#font-preview-price-sale').style.fontSize = `${size}px`;
                         $('#font-preview-price-original').style.fontSize = `${size * 0.8}px`;
                        document.documentElement.style.setProperty('--product-price-font-size', `${size}px`);
                    }
                    if (el.id === 'product-stock-status-size-input') {
                        const size = el.value;
                        $('#pd-stock-fs-val').textContent = size;
                        document.documentElement.style.setProperty('--product-stock-status-font-size', `${size}px`);
                    }
                    if (el.id === 'review-font-size-input') {
                        const size = el.value;
                        $('#review-font-size-val').textContent = size;
                        $('#review-style-preview p:first-child').style.fontSize = `${size}px`;
                    }
                });

                document.body.addEventListener('click', e => {
                    if (e.target.id === 'auth-dropdown-login-link') { e.preventDefault(); openModal('login'); }
                    if (e.target.id === 'auth-dropdown-signup-link') { e.preventDefault(); openModal('signup'); }
                    if (e.target.id === 'rating-login-link') { e.preventDefault(); openModal('login'); }
                    if (e.target.id === 'login-to-signup-link') { e.preventDefault(); closeModal('login'); openModal('signup'); }
                    if (e.target.id === 'signup-to-login-link') { e.preventDefault(); closeModal('signup'); openModal('login'); }
                    if (e.target.id === 'google-login-btn') { e.preventDefault(); signInWithGoogle(); }
                    if (e.target.closest('#account-toggle-btn')) { e.preventDefault(); $('#account-dropdown').classList.toggle('hidden'); }
                    if (e.target.closest('#auth-icon-btn')) { e.preventDefault(); $('#auth-dropdown').classList.toggle('hidden'); }
                    if (e.target.id === 'account-dropdown-orders-link') { 
                        e.preventDefault(); 
                        if(currentUser) {
                            $('#user-id-display').innerHTML = `Your User ID: <span class="selectable-uid" title="Click to copy">${currentUser.uid}</span>`;
                        }
                        renderOrderHistory(); 
                        renderUserTickets();
                        openModal('account'); 
                        $('#account-dropdown').classList.add('hidden'); 
                    }
                    if (e.target.id === 'account-dropdown-logout-link') { e.preventDefault(); signOut(auth).catch(error => console.error("Logout failed:", error)); $('#account-dropdown').classList.add('hidden'); }
                    if (e.target.id === 'shipping-policy-link' || e.target.id === 'shipping-policy-link-dropdown') { e.preventDefault(); $('#nav-dropdown').classList.add('hidden'); openModal('shipping-policy'); }
                    if (e.target.id === 'faq-link' || e.target.id === 'faq-link-dropdown') { e.preventDefault(); $('#nav-dropdown').classList.add('hidden'); openModal('faq'); }
                    if (e.target.id === 'about-us-link' || e.target.id === 'about-us-link-dropdown') { e.preventDefault(); $('#nav-dropdown').classList.add('hidden'); openModal('about-us'); }
                    if (e.target.id === 'payment-methods-link-dropdown') { e.preventDefault(); $('#nav-dropdown').classList.add('hidden'); openModal('payment-methods'); }
                    if (e.target.closest('.category-dropdown-link')) { 
                        e.preventDefault(); 
                        $('#nav-dropdown').classList.add('hidden'); 
                        handleCategoryClick(e.target.closest('.category-dropdown-link').dataset.id); 
                    }
                    if (e.target.matches('.selectable-uid')) {
                        navigator.clipboard.writeText(e.target.textContent).then(() => {
                            showToast('User ID copied to clipboard!');
                        });
                    }
                    if (!e.target.closest('#nav-toggle-btn') && !e.target.closest('#nav-dropdown')) {
                        $('#nav-dropdown').classList.add('hidden');
                    }
                    if (!e.target.closest('#account-toggle-btn') && !e.target.closest('#account-dropdown')) {
                        $('#account-dropdown').classList.add('hidden');
                    }
                    if (!e.target.closest('#auth-icon-btn') && !e.target.closest('#auth-dropdown')) {
                        const authDropdown = $('#auth-dropdown');
                        if(authDropdown) authDropdown.classList.add('hidden');
                    }
                });

                $('#login-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    signInWithEmailAndPassword(auth, $('#login-email').value, $('#login-password').value).then(() => {
                        closeModal('login'); e.target.reset(); $('#login-error').classList.add('hidden');
                        if(currentDetailProductId) {
                            const product = products.find(p => p.id === currentDetailProductId);
                            if(product) updateProductDetailRatingView(product);
                        }
                    }).catch(error => { $('#login-error').textContent = error.message; $('#login-error').classList.remove('hidden'); });
                });

                $('#signup-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const signupName = $('#signup-name').value;
                    const signupEmail = $('#signup-email').value;
                    const signupPassword = $('#signup-password').value;
                    try {
                        const userCredential = await createUserWithEmailAndPassword(auth, signupEmail, signupPassword);
                        const user = userCredential.user;
                        await setDoc(doc(db, "users", user.uid), {
                            name: signupName,
                            email: user.email,
                            uid: user.uid,
                            displayName: signupName,
                            photoURL: ''
                        });
                        await fetchUsers();
                        closeModal('signup'); e.target.reset(); $('#signup-error').classList.add('hidden');
                    } catch (error) {
                        $('#signup-error').textContent = error.message; 
                        $('#signup-error').classList.remove('hidden');
                    }
                });

                $('#login-cancel-btn').addEventListener('click', () => closeModal('login'));
                $('#signup-cancel-btn').addEventListener('click', () => closeModal('signup'));

                $('#admin-orders-list').addEventListener('change', e => {
                    if(e.target.classList.contains('order-status-select')) {
                        const order = orders.find(o => o.id === e.target.dataset.id);
                        if(order) { 
                            order.status = e.target.value; 
                            showToast(`Order #${order.id} status updated.`); 
                            calculateProductSales();
                            renderDashboard($('.dashboard-filter-btn.active').dataset.period);
                        }
                    }
                });
            
                document.body.addEventListener('click', e => {
                    const adminBtn = e.target.closest('#admin-login-btn');
                    if (adminBtn) {
                        if(currentUser && siteSettings.adminEmails.includes(currentUser.email)) openModal('password');
                        else showToast("You are not authorized to access the admin panel.", null, false);
                    }
                });

                $('#password-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    if ($('#password-input').value === siteSettings.adminPassword) {
                        closeModal('password'); openModal('admin-panel');
                        e.target.reset(); $('#password-error').classList.add('hidden');
                    } else {
                        $('#password-error').classList.remove('hidden');
                    }
                });

                $('#save-settings-btn').addEventListener('click', () => {
                     const activeTab = $('.admin-tab.active').dataset.tab;
                     const shouldRerenderProducts = ['products', 'list-products', 'orders', 'categories', 'reviews-manage'].includes(activeTab);
                     saveDataToFirestore({ rerenderProducts: shouldRerenderProducts });
                });
                $('#password-cancel-btn').addEventListener('click', () => closeModal('password'));
                $('#admin-close-btn').addEventListener('click', () => closeModal('admin-panel'));
                $('#cart-button').addEventListener('click', () => openModal('cart'));
                $('#cart-close-btn').addEventListener('click', () => closeModal('cart'));
                $('#checkout-close-btn').addEventListener('click', () => closeModal('checkout'));
                $('#product-detail-close-btn').addEventListener('click', () => { 
                    closeModal('product-detail'); 
                    currentDetailProductId = null; 
                    stopProductDetailSlideshow();
                    if(productDetailCountdownInterval) clearInterval(productDetailCountdownInterval);
                    const mediaDisplay = $('#product-detail-media-display');
                    if (mediaDisplay) mediaDisplay.innerHTML = '';
                });
                $('#sale-popup-close-btn').addEventListener('click', () => closeModal('sale-popup'));
                $('#sale-popup-btn').addEventListener('click', () => closeModal('sale-popup'));
                $('#size-guide-close-btn').addEventListener('click', () => closeModal('size-guide'));
                $('#shipping-policy-close-btn').addEventListener('click', () => closeModal('shipping-policy'));
                $('#faq-close-btn').addEventListener('click', () => closeModal('faq'));
                $('#about-us-close-btn').addEventListener('click', () => closeModal('about-us'));
                $('#payment-methods-close-btn').addEventListener('click', () => closeModal('payment-methods'));
                $('#payment-detail-close-btn').addEventListener('click', () => closeModal('payment-detail'));
                $('#account-close-btn').addEventListener('click', () => closeModal('account'));
                $('#category-modal-close-btn').addEventListener('click', () => closeModal('category')); 
                $('#nav-toggle-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    $('#nav-dropdown').classList.toggle('hidden');
                });
                $('#write-review-btn').addEventListener('click', () => openModal('review-submission'));
                $('#review-submission-close-btn').addEventListener('click', () => closeModal('review-submission'));
                
                $('#all-reviews-close-btn').addEventListener('click', () => closeModal('all-reviews'));
                $('#all-reviews-add-new-btn').addEventListener('click', () => { closeModal('all-reviews'); openModal('review-submission'); });
                $('#order-success-close-btn').addEventListener('click', () => closeModal('order-success'));


                $('#proceed-to-checkout-btn').addEventListener('click', () => {
                    if (!currentUser) { showToast("Please login to proceed to checkout.", null, false); openModal('login'); return; }
                    const checkoutNameInput = $('#name');
                    if (currentUser.displayName && checkoutNameInput) checkoutNameInput.value = currentUser.displayName;
                    closeModal('cart'); openModal('checkout');
                });
            
                document.body.addEventListener('click', e => { if (e.target.id === 'product-detail-size-guide-btn') openModal('size-guide'); });
            
                $$('.admin-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabName = tab.dataset.tab;
                        $$('.admin-tab').forEach(t => t.classList.remove('active'));
                        $$('.admin-tab-content').forEach(c => c.classList.add('hidden'));
                        tab.classList.add('active');
                        $(`#admin-tab-${tabName}`).classList.remove('hidden');
                        if (tabName === 'orders') renderAdminOrders($('.order-filter-btn.active').dataset.status, $('#order-search-input').value);
                        if (tabName === 'deleted-orders') renderDeletedOrders();
                        if (tabName === 'dashboard') renderDashboard($('.dashboard-filter-btn.active').dataset.period);
                        if (tabName === 'users') renderAdminUsers();
                        if (tabName === 'abandoned-carts') renderAbandonedCarts();
                        if (tabName === 'messaging') {
                            initAdminMessaging();
                            markMessagesAsRead('admin', currentAdminChatUserId); // Also clear badge
                        }
                        if (tabName === 'tickets') renderAdminTickets($('.ticket-filter-btn.active').dataset.status);
                    });
                });
            
                $$('.account-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabName = tab.dataset.tab;
                        $$('.account-tab').forEach(t => t.classList.remove('active'));
                        $$('.account-tab-content').forEach(c => c.classList.add('hidden'));
                        tab.classList.add('active');
                        $(`#account-tab-${tabName}`).classList.remove('hidden');
                        if(tabName === 'messages' && currentUser) {
                            loadUserConversation(currentUser.uid);
                            markMessagesAsRead(currentUser.uid, currentUser.uid);
                        }
                        if(tabName === 'tickets' && currentUser) {
                            updateUserTicketView(currentUser.uid);
                            updateNotificationBadge('account-tab', 0, '[data-tab="tickets"]');
                        }
                    });
                });
            
                $$('.dashboard-filter-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        $$('.dashboard-filter-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        renderDashboard(btn.dataset.period);
                    });
                });
                const debouncedSearch = debounce(() => renderAdminOrders($('.order-filter-btn.active').dataset.status, $('#order-search-input').value), 300);
                $('#order-search-input').addEventListener('input', debouncedSearch);

                $$('.order-filter-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        $$('.order-filter-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        renderAdminOrders(btn.dataset.status, $('#order-search-input').value);
                    });
                });
            
                $('#product-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const id = $('#product-id-input').value;
                    const variants = [];
                    $$('#product-variants-container .variant-card').forEach(card => {
                        variants.push({
                            colorName: card.querySelector('.variant-color-name').value, colorHex: card.querySelector('.variant-color-hex').value,
                            image: card.querySelector('.variant-image-url').value, stock: parseInt(card.querySelector('.variant-stock').value) || 0,
                            videoUrl: card.querySelector('.variant-video-url').value, sku: card.querySelector('.variant-sku').value,
                        });
                    });
                    const galleryImages = ($('#product-main-image-input').value || '').split('\n').filter(url => url.trim() !== '');

                    const productData = {
                        name: $('#product-name-input').value, price: parseFloat($('#product-price-input').value),
                        salePrice: parseFloat($('#product-sale-price-input').value) || null, description: $('#product-description-input').value,
                        subtitle: $('#product-subtitle-input').value,
                        deliveryCharge: parseFloat($('#product-delivery-charge-input').value) || 0, 
                        galleryImages: galleryImages,
                        mainImage: galleryImages[0] || '',
                        stock: parseInt($('#product-stock-input').value) || 0, videoUrl: $('#product-video-url-input').value, 
                        variants: variants, categoryId: $('#product-category-select').value,
                        isFeatured: parseInt($('#product-featured-select').value) || 0, 
                        showSizeGuide: $('#product-size-guide-input').checked,
                        tags: $('#product-tags-input').value,
                        metaKeywords: $('#product-meta-keywords-input').value, metaDescription: $('#product-meta-description-input').value,
                    };
                    if (id) {
                        const index = products.findIndex(p => p.id == id);
                        if (index !== -1) products[index] = { ...products[index], ...productData };
                    } else {
                        products.push({ ...productData, id: Date.now().toString(), ratings: [], views: 0 });
                    }
                    showToast('Product saved!'); renderAdminPanels(); 
                    renderProducts(products.filter(p => p.isFeatured == 1), $('#product-grid-1'));
                    renderProducts(products.filter(p => p.isFeatured == 2), $('#product-grid-2'));
                    e.target.reset(); $('#product-variants-container').innerHTML = ''; $('#product-id-input').value = '';
                    $('#product-form-title').textContent = 'Add New Product'; $('#cancel-edit-product-btn').classList.add('hidden');
                    updateProductSEOPreview();
                });
            
                $('#review-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const id = $('#review-id-input').value;
                    const review = { name: $('#review-name-input').value, quote: $('#review-quote-input').value, rating: parseInt($('#review-rating-input').value) };
                    if (id) {
                        const index = reviews.findIndex(r => r.id == id);
                        if (index !== -1) reviews[index] = { ...reviews[index], ...review };
                    } else {
                        review.id = Date.now().toString(); reviews.push(review);
                    }
                    showToast('Review saved!'); renderAdminPanels(); renderReviews(); e.target.reset();
                    $('#review-id-input').value = ''; $('#review-form-title').textContent = 'Add New Review'; $('#cancel-edit-review-btn').classList.add('hidden');
                });

                $('#admin-products-list').addEventListener('click', e => {
                    const card = e.target.closest('.admin-product-card'); if (!card) return;
                    const id = card.dataset.id;
                    if (e.target.matches('.edit-product-btn')) {
                        const product = products.find(p => p.id == id);
                        $('#product-id-input').value = product.id; $('#product-name-input').value = product.name;
                        $('#product-price-input').value = product.price; $('#product-sale-price-input').value = product.salePrice;
                        $('#product-description-input').value = product.description;
                        $('#product-subtitle-input').value = product.subtitle || '';
                        $('#product-delivery-charge-input').value = product.deliveryCharge || 0;
                        $('#product-main-image-input').value = (product.galleryImages || [product.mainImage]).join('\n');
                        $('#product-video-url-input').value = product.videoUrl || '';
                        $('#product-stock-input').value = product.stock !== undefined ? product.stock : 10;
                        $('#product-category-select').value = product.categoryId; $('#product-featured-select').value = product.isFeatured || 0;
                        $('#product-size-guide-input').checked = product.showSizeGuide; 
                        $('#product-tags-input').value = product.tags; $('#product-meta-keywords-input').value = product.metaKeywords;
                        $('#product-meta-description-input').value = product.metaDescription;
                        const variantsContainer = $('#product-variants-container'); variantsContainer.innerHTML = ''; 
                        if(product.variants) product.variants.forEach(v => addVariantRow(v));
                        $('#product-form-title').textContent = 'Edit Product'; $('#cancel-edit-product-btn').classList.remove('hidden');
                        updateProductSEOPreview();
                        window.scrollTo(0, document.body.scrollHeight);
                    }
                    if (e.target.matches('.delete-product-btn')) {
                        if (confirm('Are you sure you want to delete this product?')) {
                            products = products.filter(p => p.id != id);
                            renderAdminPanels(); 
                            renderProducts(products.filter(p => p.isFeatured == 1), $('#product-grid-1'));
                            renderProducts(products.filter(p => p.isFeatured == 2), $('#product-grid-2'));
                        }
                    }
                });

                $('#category-form').addEventListener('submit', e => {
                    e.preventDefault();
                    categories.push({ 
                        id: Date.now().toString(), 
                        name: $('#category-name-input').value, 
                        image: $('#category-image-input').value,
                        displayImage: $('#category-display-image-input-new').value
                    });
                    showToast('Category added!'); renderAdminPanels(); renderCategories(); populateCategoryDropdown(); e.target.reset();
                });

                $('#admin-categories-list').addEventListener('click', e => {
                    if (e.target.matches('.delete-category-btn') && confirm('Are you sure?')) {
                        const idToDelete = e.target.closest('.admin-category-card').dataset.id;
                        categories = categories.filter(c => c.id !== idToDelete);
                        renderAdminPanels(); renderCategories(); populateCategoryDropdown();
                    }
                });
                $('#admin-reviews-list').addEventListener('click', e => {
                    const card = e.target.closest('.admin-review-card'); if (!card) return; const id = card.dataset.id;
                    if (e.target.matches('.edit-review-btn')) {
                        const review = reviews.find(r => r.id == id);
                        $('#review-id-input').value = review.id; $('#review-name-input').value = review.name;
                        $('#review-quote-input').value = review.quote; $('#review-rating-input').value = review.rating;
                        $('#review-form-title').textContent = 'Edit Review'; $('#cancel-edit-review-btn').classList.remove('hidden');
                    }
                    if (e.target.matches('.delete-review-btn')) {
                        reviews = reviews.filter(r => r.id != id); renderAdminPanels(); renderReviews();
                    }
                });

                $('#cancel-edit-product-btn').addEventListener('click', () => {
                    $('#product-form').reset(); $('#product-variants-container').innerHTML = ''; $('#product-id-input').value = '';
                    $('#product-form-title').textContent = 'Add New Product'; $('#cancel-edit-product-btn').classList.add('hidden');
                    updateProductSEOPreview();
                });
                $('#cancel-edit-review-btn').addEventListener('click', () => {
                    $('#review-form').reset(); $('#review-id-input').value = '';
                    $('#review-form-title').textContent = 'Add New Review'; $('#cancel-edit-review-btn').classList.add('hidden');
                });

                $('#cart-items-container').addEventListener('click', (e) => {
                    const itemEl = e.target.closest('[data-id]'); if (!itemEl) return;
                    const itemId = itemEl.dataset.id; const item = cart.find(i => i.id == itemId);
                    if (e.target.matches('.cart-quantity-change')) updateCartItemQuantity(itemId, item.quantity + parseInt(e.target.dataset.change));
                    else if (e.target.matches('.cart-remove-item')) updateCartItemQuantity(itemId, 0);
                });
        
                $('#apply-discount-btn').addEventListener('click', () => {
                    const code = $('#discount-code-input').value.toUpperCase();
                    const coupon = coupons.find(c => c.code.toUpperCase() === code);
                    const messageEl = $('#discount-message');

                    if (!coupon) {
                        appliedDiscount = null;
                        messageEl.textContent = 'Invalid code.'; messageEl.className = 'text-sm mt-2 text-red-500';
                    } else if (coupon.totalUses && (coupon.currentUses || 0) >= coupon.totalUses) {
                        appliedDiscount = null;
                        messageEl.textContent = 'This coupon has reached its usage limit.'; messageEl.className = 'text-sm mt-2 text-red-500';
                    } else if (currentUser && coupon.perUserUses && ((coupon.users && coupon.users[currentUser.uid]) || 0) >= coupon.perUserUses) {
                        appliedDiscount = null;
                        messageEl.textContent = 'You have already used this coupon the maximum number of times.'; messageEl.className = 'text-sm mt-2 text-red-500';
                    } else {
                        appliedDiscount = coupon;
                        messageEl.textContent = `Code "${code}" applied!`; messageEl.className = 'text-sm mt-2 text-green-600';
                    }
                    updateCartSummary();
                });
        
                $('#search-bar').addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const resultsContainer = $('#search-results');
                    if (searchTerm.length < 1) { resultsContainer.innerHTML = ''; resultsContainer.classList.add('hidden'); return; }
                    
                    const filtered = products.filter(p => p.name.toLowerCase().includes(searchTerm) || (p.tags && p.tags.toLowerCase().includes(searchTerm)));
                    resultsContainer.classList.remove('hidden');

                    if (filtered.length === 0) {
                        resultsContainer.innerHTML = `<div class="p-4 text-center text-gray-500">No products found.</div>`;
                        return;
                    }
                    
                    resultsContainer.innerHTML = filtered.map(p => {
                        const onSale = p.salePrice && p.salePrice < p.price;
                        const defaultImage = (p.galleryImages && p.galleryImages.length > 0) ? p.galleryImages[0] : 'https://placehold.co/100x100';
                        let priceHTML = '';
                        if (onSale) {
                            priceHTML = `<div class="text-right"><p class="font-semibold text-gray-800">Rs. ${p.salePrice.toLocaleString()}</p><p class="text-xs text-gray-500 line-through">Rs. ${p.price.toLocaleString()}</p></div>`;
                        } else {
                            priceHTML = `<p class="font-semibold text-gray-700">Rs. ${p.price.toLocaleString()}</p>`;
                        }
                        return `
                            <div class="flex items-center justify-between gap-4 p-2 hover:bg-gray-100 cursor-pointer search-result-item" data-id="${p.id}">
                                <div class="flex items-center gap-4">
                                    <img src="${defaultImage}" alt="${p.name}" class="w-12 h-12 object-cover rounded-md">
                                    <div><p class="font-semibold text-gray-800">${p.name}</p></div>
                                </div>
                                <div class="pr-2">${priceHTML}</div>
                            </div>`;
                    }).join('');
                });
        
                $('#search-results').addEventListener('click', (e) => {
                    const item = e.target.closest('.search-result-item');
                    if (item) {
                        openProductDetail(item.dataset.id);
                        $('#search-results').classList.add('hidden'); $('#search-bar').value = '';
                    }
                });
        
                $('#checkout-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!currentUser) { showToast("Please log in again.", null, false); return; }
            
                    if (appliedDiscount) {
                        const couponToUpdate = coupons.find(c => c.id === appliedDiscount.id);
                        if (couponToUpdate) {
                            couponToUpdate.currentUses = (couponToUpdate.currentUses || 0) + 1;
                            if (!couponToUpdate.users) couponToUpdate.users = {};
                            couponToUpdate.users[currentUser.uid] = (couponToUpdate.users[currentUser.uid] || 0) + 1;
                        }
                    }

                    const formData = new FormData(e.target);
                    const customerDetails = Object.fromEntries(formData.entries());
                    const paymentMethod = formData.get('paymentMethod');

                    const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                    let discountAmount = 0;
                    if (appliedDiscount) discountAmount = appliedDiscount.type === 'percent' ? subtotal * (appliedDiscount.value / 100) : appliedDiscount.value;
                    const delivery = cart.length > 0 ? Math.max(...cart.map(item => item.deliveryCharge)) : 0;
                    const total = subtotal - discountAmount + delivery;
                    
                    const prefix = siteSettings['order-id-prefix'] || 'NB';
                    const newOrder = { 
                        id: `${prefix}-${Date.now()}`, 
                        date: new Date().toISOString(), 
                        customer: customerDetails, 
                        items: [...cart], 
                        total: total, 
                        status: 'Pending', 
                        userId: currentUser.uid,
                        paymentMethod: paymentMethod
                    };

                    orders.push(newOrder);
                    await removeAbandonedCart(currentUser.uid);
                    
                    const discountCode = $('#discount-code-input').value.toUpperCase();
                    const discountInfo = appliedDiscount ? `Yes (Code: ${discountCode}) -Rs. ${discountAmount.toLocaleString()}` : 'No';
                    const orderItemsList = cart.map(item => `- ${item.name} (${item.variant?.colorName || 'Std.'}) x${item.quantity} = Rs. ${(item.price * item.quantity).toLocaleString()}`).join('\n');
                    const shippingAddress = `${customerDetails.address}, ${customerDetails.city}`;
                    let message = (siteSettings['whatsapp-template'] || defaultWhatsappTemplate)
                        .replace(/{storeName}/g, siteSettings['store-name']).replace(/{orderNumber}/g, newOrder.id)
                        .replace(/{customerName}/g, customerDetails.name).replace(/{phone}/g, customerDetails.phone)
                        .replace(/{orderItems}/g, orderItemsList).replace(/{subtotal}/g, `Rs. ${subtotal.toLocaleString()}`)
                        .replace(/{discountInfo}/g, discountInfo).replace(/{deliveryCharges}/g, `Rs. ${delivery.toLocaleString()}`)
                        .replace(/{total}/g, `Rs. ${total.toLocaleString()}`).replace(/{shippingAddress}/g, shippingAddress)
                        .replace(/{paymentMethod}/g, paymentMethod)
                        .replace(/{storeLogoUrl}/g, siteSettings['store-logo'] || '');
                    window.open(`https://wa.me/${siteSettings.ownerWhatsapp}?text=${encodeURIComponent(message)}`, '_blank');
                    
                    closeModal('checkout'); cart = []; appliedDiscount = null;
                    $('#discount-code-input').value = ''; $('#discount-message').textContent = '';
                    calculateProductSales(); updateCartUI(); renderAdminOrders(); 
                    renderProducts(products.filter(p => p.isFeatured == 1), $('#product-grid-1'));
                    renderProducts(products.filter(p => p.isFeatured == 2), $('#product-grid-2'));
                    showOrderSuccessPopup(); 
                    e.target.reset(); saveDataToFirestore();
                });
        
                $('#sort-products').addEventListener('change', (e) => {
                    const sortBy = e.target.value;
                    let featuredProducts1 = products.filter(p => p.isFeatured == 1);
                    let featuredProducts2 = products.filter(p => p.isFeatured == 2);
                    
                    // If not default, merge, sort, and display in the first row. Clear the second.
                    if (sortBy !== 'default') {
                        let allFeatured = [...featuredProducts1, ...featuredProducts2];
                        if (sortBy === 'price-asc') allFeatured.sort((a, b) => (a.salePrice || a.price) - (b.salePrice || b.price));
                        else if (sortBy === 'price-desc') allFeatured.sort((a, b) => (b.salePrice || b.price) - (a.salePrice || a.price));
                        else if (sortBy === 'sales-desc') allFeatured.sort((a, b) => (productSalesCache[b.id] || 0) - (productSalesCache[a.id] || 0));
                        else if (sortBy === 'review-desc') {
                            const getAvgRating = p => (p.ratings?.length > 0) ? p.ratings.reduce((sum, r) => sum + r.rating, 0) / p.ratings.length : 0;
                            allFeatured.sort((a, b) => getAvgRating(b) - getAvgRating(a));
                        }
                        renderProducts(allFeatured, $('#product-grid-1'));
                        $('#product-grid-2').innerHTML = ''; // Clear second grid
                        $('#featured-row-2-container').classList.add('hidden');
                    } else {
                        // Restore default view
                        renderProducts(featuredProducts1, $('#product-grid-1'));
                        renderProducts(featuredProducts2, $('#product-grid-2'));
                        $('#featured-row-2-container').classList.remove('hidden');
                    }
                });

                $('#rating-input-area').addEventListener('change', async (e) => {
                    if (e.target.name === 'rating' && currentDetailProductId) {
                        const newRating = parseInt(e.target.value);
                        const product = products.find(p => p.id === currentDetailProductId);
                        if (!product || !currentUser) return;
                        const ratingIndex = product.ratings.findIndex(r => r.userId === currentUser.uid);
                        if (ratingIndex > -1) product.ratings[ratingIndex].rating = newRating;
                        else product.ratings.push({ userId: currentUser.uid, rating: newRating });
                        showToast(`You rated this product ${newRating} stars!`);
                        updateProductDetailRatingView(product); 
                        renderProducts(products.filter(p => p.isFeatured == 1), $('#product-grid-1'));
                        renderProducts(products.filter(p => p.isFeatured == 2), $('#product-grid-2'));
                        await saveDataToFirestore({ rerenderProducts: false });
                    }
                });

                $('#add-variant-btn').addEventListener('click', () => addVariantRow());
                $('#product-variants-container').addEventListener('click', e => { if (e.target.classList.contains('remove-variant-btn')) e.target.closest('.variant-card').remove(); });
        
                document.body.addEventListener('click', e => {
                    const card = e.target.closest('.product-card');
                    if (!card) return;

                    const productId = card.dataset.id;
                    const product = products.find(p => p.id === productId);

                    if (e.target.matches('.color-swatch')) {
                        e.stopPropagation();
                        const swatch = e.target;
                        const cardImage = card.querySelector('.product-card-image');
                        card.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
                        swatch.classList.add('selected');
                        if (swatch.dataset.image) {
                            cardImage.src = swatch.dataset.image;
                        }
                    } else if (e.target.closest('.add-to-cart-btn') && !e.target.closest('.add-to-cart-btn').disabled) {
                        e.stopPropagation();
                        const hasVariants = product.variants && product.variants.length > 0;
                        if (hasVariants) {
                            const selectedSwatch = card.querySelector('.color-swatch.selected');
                            if (selectedSwatch) {
                                const selectedVariant = product.variants.find(v => v.colorName === selectedSwatch.dataset.colorName);
                                addToCart(productId, selectedVariant);
                            } else {
                                // Default to first variant if none selected, or open detail if that's preferred
                                addToCart(productId, product.variants[0]);
                            }
                        } else {
                            addToCart(productId, null);
                        }
                    } else if (e.target.closest('.view-product-btn') || e.target.closest('.product-clickable-area')) {
                        e.stopPropagation();
                        openProductDetail(productId);
                    }
                });
                
                $('#product-detail-add-to-cart-btn').addEventListener('click', (e) => {
                    const productId = e.target.dataset.id;
                    const quantity = parseInt($('#product-detail-quantity-selector span').textContent);
                    const product = products.find(p => p.id === productId);
                    if (product.variants && product.variants.length > 0) {
                        const selectedSwatch = $('#product-detail-variants-container .color-swatch.selected');
                        const selectedVariant = product.variants.find(v => v.colorName === selectedSwatch.dataset.colorName);
                        addToCart(productId, selectedVariant, quantity);
                    } else {
                        addToCart(productId, null, quantity);
                    }
                });

                $('#product-detail-quantity-selector').addEventListener('click', e => {
                    const btn = e.target.closest('button');
                    if(!btn) return;
                    const change = parseInt(btn.dataset.change);
                    const span = btn.parentElement.querySelector('span');
                    let currentQuantity = parseInt(span.textContent);
                    currentQuantity = Math.max(1, currentQuantity + change);
                    span.textContent = currentQuantity;

                    const product = products.find(p => p.id == currentDetailProductId);
                    if(product) {
                        const selectedSwatch = $('#product-detail-variants-container .color-swatch.selected');
                        const selectedVariant = selectedSwatch ? product.variants.find(v => v.colorName === selectedSwatch.dataset.colorName) : null;
                        renderStockStatus(product, currentQuantity, selectedVariant);
                        updateAddToCartButtonPrice();
                    }
                });
                
                $('#product-detail-thumbnails, #product-detail-dots').addEventListener('click', e => {
                    const target = e.target.closest('[data-index]');
                    if (target) {
                        stopProductDetailSlideshow();
                        currentDetailMediaIndex = parseInt(target.dataset.index);
                        updateProductMediaView();
                    }
                });
                $('#product-detail-media-container').addEventListener('mouseenter', stopProductDetailSlideshow);
                $('#product-detail-media-container').addEventListener('mouseleave', startProductDetailSlideshow);
        
                // RE-ADDED category button event listener
                $('#category-buttons').addEventListener('click', e => {
                    const btn = e.target.closest('.category-btn');
                    if (btn) handleCategoryClick(btn.dataset.id);
                });

                ['1', '2'].forEach(row => {
                    $(`#featured-scroll-left-btn-${row}`).addEventListener('click', () => { $(`#featured-product-slider-${row}`).scrollLeft -= 300; });
                    $(`#featured-scroll-right-btn-${row}`).addEventListener('click', () => { $(`#featured-product-slider-${row}`).scrollLeft += 300; });
                });

                 // NEW: Product detail variant selection
                $('#product-detail-variants-container').addEventListener('click', e => {
                    if (e.target.matches('.color-swatch')) {
                        const swatch = e.target;
                        $$('#product-detail-variants-container .color-swatch').forEach(s => s.classList.remove('selected'));
                        swatch.classList.add('selected');
                        
                        const product = products.find(p => p.id === currentDetailProductId);
                        if (product) {
                            const selectedVariant = product.variants.find(v => v.colorName === swatch.dataset.colorName);
                            if (selectedVariant) {
                                // Find the index of the variant's image in the media assets
                                const variantMediaIndex = currentDetailMediaAssets.findIndex(asset => asset.url === selectedVariant.image);
                                if (variantMediaIndex > -1) {
                                    stopProductDetailSlideshow();
                                    currentDetailMediaIndex = variantMediaIndex;
                                    updateProductMediaView();
                                }
                                renderStockStatus(product, 1, selectedVariant);
                            }
                        }
                    }
                });

                bindCouponEventListeners();
                bindSettingsEventListeners();
                bindLuckGameEventListeners();
                bindReviewSubmissionEventListeners();
                bindEditorToolbarListeners();
                bindMessagingEventListeners();
                bindCategoryModalSearch();
                bindPaymentMethodEventListeners();
                bindWhatsappPreviewListeners();
                bindProductSEOPreviewListeners();
                bindAbandonedCartEventListeners();
                bindPasswordToggleListener();
                bindOrderActionListeners();
                bindOrderSuccessPreviewListeners();
                bindReviewsAdminListeners();
                bindAdminManagementListeners();
                bindTicketEventListeners();
                bindUserSecurityEventListeners();
                bindFontPreviewListeners();
                bindFloatingButtonEventListeners();
            }
    
            const addVariantRow = (variant = {}) => {
                const container = $('#product-variants-container');
                const newRow = document.createElement('div');
                newRow.className = 'variant-card grid grid-cols-1 md:grid-cols-2 gap-4 border p-4 rounded-lg relative';
                newRow.innerHTML = `
                    <button type="button" class="remove-variant-btn absolute -top-2 -right-2 bg-red-500 text-white rounded-full h-6 w-6 flex items-center justify-center font-bold">&times;</button>
                    <div><label class="admin-label">Color Name</label><input type="text" class="admin-input variant-color-name" placeholder="e.g., Sky Blue" value="${variant.colorName || ''}"></div>
                    <div><label class="admin-label">Color Swatch</label><input type="color" class="admin-input variant-color-hex" value="${variant.colorHex || '#ffffff'}"></div>
                    <div class="md:col-span-2"><label class="admin-label">Image URL</label><input type="text" class="admin-input variant-image-url" placeholder="https://..." value="${variant.image || ''}"></div>
                    <div class="md:col-span-2"><label class="admin-label">Video URL</label><input type="text" class="admin-input variant-video-url" placeholder="https://youtube.com/..." value="${variant.videoUrl || ''}"></div>
                    <div><label class="admin-label">Stock Qty</label><input type="number" class="admin-input variant-stock" min="0" value="${variant.stock !== undefined ? variant.stock : 10}"></div>
                    <div><label class="admin-label">SKU</label><input type="text" class="admin-input variant-sku" placeholder="SKU-001" value="${variant.sku || ''}"></div>`;
                container.appendChild(newRow);
            };

            const handleCategoryClick = (categoryId, shouldUpdateUrl = true) => {
                const category = categories.find(c => c.id === categoryId);
                if (!category) return;
                
                if (shouldUpdateUrl) {
                    const slug = category.name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                    updateUrl(`/categories/${slug}`);
                }

                currentCategoryProducts = products.filter(p => p.categoryId === categoryId);
                $('#category-modal-title').textContent = category.name;
                $('#category-modal-banner').style.backgroundImage = `url('${category.image}')`;
                renderProducts(currentCategoryProducts, $('#category-modal-grid'), `No products found in the "${category.name}" collection.`);
                $('#category-search-input').value = '';
                openModal('category');
            };
    
            const bindCategoryModalSearch = () => {
                $('#category-search-icon').addEventListener('click', () => {
                    $('#category-search-container').classList.toggle('active');
                    if ($('#category-search-container').classList.contains('active')) {
                        $('#category-search-input').focus();
                    }
                });

                const searchCategoryProducts = () => {
                    const searchTerm = $('#category-search-input').value.toLowerCase();
                    const filtered = searchTerm ? currentCategoryProducts.filter(p => p.name.toLowerCase().includes(searchTerm)) : currentCategoryProducts;
                    renderProducts(filtered, $('#category-modal-grid'), 'No matching products found.');
                };

                $('#category-search-input').addEventListener('input', debounce(searchCategoryProducts, 300));
            };
    
            const bindCouponEventListeners = () => {
                $('#coupon-form').addEventListener('submit', (e) => {
                    e.preventDefault(); 
                    const id = $('#coupon-id-input').value;
                    const couponData = { 
                        code: $('#coupon-code-input').value.toUpperCase(), 
                        type: $('#coupon-type-select').value, 
                        value: parseFloat($('#coupon-value-input').value),
                        totalUses: parseInt($('#coupon-total-uses-input').value) || null,
                        perUserUses: parseInt($('#coupon-per-user-uses-input').value) || null,
                    };
                    if(id) {
                        const index = coupons.findIndex(c => c.id == id);
                        if (index !== -1) coupons[index] = { ...coupons[index], ...couponData };
                    } else {
                        couponData.id = Date.now().toString();
                        couponData.currentUses = 0;
                        couponData.users = {};
                        coupons.push(couponData);
                    }
                    showToast('Coupon saved!'); renderAdminCoupons(); e.target.reset();
                    $('#coupon-form-title').textContent = 'Add New Coupon'; $('#cancel-edit-coupon-btn').classList.add('hidden');
                });
        
                $('#admin-coupons-list').addEventListener('click', e => {
                    const card = e.target.closest('.admin-coupon-card'); if (!card) return; const id = card.dataset.id;
                    if (e.target.matches('.edit-coupon-btn')) {
                        const coupon = coupons.find(c => c.id == id);
                        $('#coupon-id-input').value = coupon.id; 
                        $('#coupon-code-input').value = coupon.code;
                        $('#coupon-type-select').value = coupon.type; 
                        $('#coupon-value-input').value = coupon.value;
                        $('#coupon-total-uses-input').value = coupon.totalUses || '';
                        $('#coupon-per-user-uses-input').value = coupon.perUserUses || '';
                        $('#coupon-form-title').textContent = 'Edit Coupon'; 
                        $('#cancel-edit-coupon-btn').classList.remove('hidden');
                    }
                    if (e.target.matches('.delete-coupon-btn') && confirm('Are you sure?')) {
                        coupons = coupons.filter(c => c.id != id); renderAdminCoupons();
                    }
                });

                $('#cancel-edit-coupon-btn').addEventListener('click', () => {
                    $('#coupon-form').reset(); $('#coupon-id-input').value = '';
                    $('#coupon-form-title').textContent = 'Add New Coupon'; $('#cancel-edit-coupon-btn').classList.add('hidden');
                });
            };
    
            const bindSettingsEventListeners = () => {
                $('#password-change-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const currentPass = $('#current-password-input').value, newPass = $('#new-password-input').value, confirmPass = $('#confirm-password-input').value;
                    if (currentPass !== siteSettings.adminPassword) { showToast("Current password is incorrect.", null, false); return; }
                    if (newPass !== confirmPass) { showToast("New passwords do not match.", null, false); return; }
                    if (newPass.length < 6) { showToast("Password must be at least 6 characters.", null, false); return; }
                    siteSettings.adminPassword = newPass; showToast("Password updated successfully!"); e.target.reset();
                });
                $('#tab-title-input, #meta-description-input').addEventListener('input', updateSiteSEOPreview);
            };
            
            function updateSiteSEOPreview() {
                const title = $('#tab-title-input').value || 'Your Site Title';
                const description = $('#meta-description-input').value || "Your site's meta description will appear here. Aim for around 155 characters.";
                
                $('#site-seo-preview-title').textContent = title;
                $('#site-seo-preview-description').textContent = description;
            }

            const renderOrderHistory = () => {
                const container = $('#order-history-container');
                if (!currentUser) { container.innerHTML = '<p>Please log in to see your order history.</p>'; return; }
                const userOrders = orders.filter(order => order.userId === currentUser.uid).reverse();
                if (userOrders.length === 0) { container.innerHTML = '<p>You have not placed any orders yet.</p>'; return; }
                container.innerHTML = userOrders.map(order => `
                    <div class="border rounded-lg p-4 bg-gray-50">
                        <div class="flex justify-between items-center border-b pb-2 mb-2">
                            <div><p class="font-bold">Order #${order.id}</p><p class="text-sm text-gray-500">${new Date(order.date).toLocaleDateString()}</p></div>
                            <span class="px-3 py-1 text-sm font-semibold rounded-full ${order.status === 'Delivered' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${order.status}</span>
                        </div>
                        <div class="space-y-2 mb-2">${order.items.map(item => `<div class="flex justify-between items-center text-sm"><p>${item.name} (${item.variant?.colorName || 'Standard'}) <span class="text-gray-500">x ${item.quantity}</span></p><p>Rs. ${(item.price * item.quantity).toLocaleString()}</p></div>`).join('')}</div>
                        <div class="flex justify-between items-center border-t pt-2 mt-2 font-bold"><p>Total</p><p>Rs. ${order.total.toLocaleString()}</p></div>
                    </div>`).join('');
            };

            const renderSpinWheelAdmin = () => {
                const prizesList = $('#spin-wheel-prizes-list');
                const winnersList = $('#spin-wheel-winners-list');
                const prizes = siteSettings['spin-wheel-prizes'] || [];
        
                prizesList.innerHTML = prizes.map((prize, index) => `
                    <div class="p-2 bg-white rounded-md border">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-6 h-6 rounded border" style="background-color: ${prize.color};"></div>
                                ${prize.image ? `<img src="${prize.image}" class="w-8 h-8 rounded-full object-cover">` : ''}
                                <span class="font-semibold">${prize.name}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button class="text-blue-500 hover:text-blue-700 text-sm font-bold edit-spin-prize-btn" data-index="${index}">EDIT</button>
                                <button class="text-red-500 hover:text-red-700 text-2xl font-bold remove-spin-prize-btn" data-index="${index}">&times;</button>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1 pl-9">Message: ${prize.message || 'None'}</p>
                    </div>
                `).join('') || '<p class="text-gray-500">No prizes added yet.</p>';

                winnersList.innerHTML = spinWinners.length > 0 ? [...spinWinners].reverse().map((w, index) => `
                    <div class="p-2 bg-gray-100 rounded text-sm relative">
                        <button class="delete-winner-btn absolute top-1 right-1 text-red-500 hover:text-red-700" data-index="${index}">&times;</button>
                        <p><strong>Prize:</strong> ${w.prize}</p><p><strong>Name:</strong> ${w.name}</p><p><strong>Phone:</strong> ${w.phone}</p>
                        <p class="text-xs text-gray-500">${new Date(w.date).toLocaleString()}</p>
                    </div>`).join('') : '<p class="text-gray-500">No winners yet.</p>';
                
                renderSpinWheelSVG('spin-wheel-preview-area');
            };

            const applyLuckGameSettings = () => {
                const container = $('#spin-wheel-nav-btn-container');
                const logoEl = $('#spin-wheel-logo');
                if (siteSettings['spin-wheel-enabled']) {
                    container.innerHTML = `<button id="spin-wheel-nav-btn" class="text-gray-600 hover:text-black transition font-semibold text-sm bg-yellow-300 px-3 py-1 rounded-full">Try Your Luck</button>`;
                } else { container.innerHTML = ''; }
        
                if(logoEl) {
                    logoEl.className = 'mx-auto mb-4 h-24 w-auto max-w-[150px] rounded-lg';
                    if(siteSettings['spin-wheel-logo']) {
                        logoEl.src = siteSettings['spin-wheel-logo'];
                        logoEl.classList.remove('hidden');
                    } else {
                        logoEl.classList.add('hidden');
                    }
                    if(siteSettings['spin-wheel-logo-animation']) {
                        logoEl.classList.add(siteSettings['spin-wheel-logo-animation']);
                    }
                }

                const gameType = siteSettings['luck-game-type'] || 'wheel';
                $('#luck-game-title').textContent = gameType === 'wheel' ? 'Spin the Wheel' : 'Unlock the Chest';
                $('#spin-wheel-game-area').style.display = gameType === 'wheel' ? 'flex' : 'none';
                $('#crate-game-area').style.display = gameType === 'crate' ? 'flex' : 'none';
        
                if(gameType === 'wheel') renderSpinWheelSVG('spin-wheel-game-area');
                else renderCrate();
            };
            
            const renderSpinWheelSVG = (containerId) => {
                const container = $(`#${containerId}`);
                if (!container) return;
                let prizes = [...(siteSettings['spin-wheel-prizes'] || [])];
                
                const svgId = containerId.includes('preview') ? 'spin-wheel-preview-svg' : 'spin-wheel-svg';
                const groupId = containerId.includes('preview') ? 'spin-wheel-preview-svg-g' : 'spin-wheel-svg-g';

                if (prizes.length === 0) { 
                    container.innerHTML = `
                        <div class="relative w-full h-full flex items-center justify-center">
                            <svg id="${svgId}" viewBox="-175 -175 350 350">
                                <circle cx="0" cy="0" r="170" fill="#ddd" stroke="#aaa" stroke-width="5"/>
                                <text x="0" y="0" text-anchor="middle" dominant-baseline="middle" fill="#555" font-size="20">Add prizes to see wheel</text>
                            </svg>
                            <div id="spin-wheel-center-overlay"></div>
                            <div id="spin-wheel-pointer" style="border-left-color: #aaa;"></div>
                        </div>`; 
                    return; 
                }
                const numSegments = prizes.length;
                const angle = 360 / numSegments;
                const radius = 175; // Full radius of the containing div
                const pathRadius = 170; // Radius for the path to stay inside border
                const textRadius = 100;

                const svgNS = "http://www.w3.org/2000/svg";

                let svg = `<svg id="${svgId}" viewBox="-${radius} -${radius} ${radius*2} ${radius*2}"><g id="${groupId}">`;

                const getCoordinates = (deg, r) => {
                    const rad = deg * Math.PI / 180.0;
                    return [r * Math.cos(rad), r * Math.sin(rad)];
                };

                for(let i=0; i < numSegments; i++) {
                    const startAngle = i * angle;
                    const endAngle = (i + 1) * angle;

                    const [startX, startY] = getCoordinates(startAngle, pathRadius);
                    const [endX, endY] = getCoordinates(endAngle, pathRadius);
                    const largeArcFlag = angle > 180 ? 1 : 0;
                    
                    svg += `<path d="M 0 0 L ${startX} ${startY} A ${pathRadius} ${pathRadius} 0 ${largeArcFlag} 1 ${endX} ${endY} Z" fill="${prizes[i].color}" stroke="#6b2a0c" stroke-width="2"/>`;

                    // Add text
                    const textAngle = startAngle + angle / 2;
                    svg += `<text fill="${prizes[i].textColor || '#fff'}" font-size="16" font-weight="bold" text-anchor="middle" dominant-baseline="middle" transform="rotate(${textAngle}) translate(${textRadius}, 0) rotate(90)">${prizes[i].name}</text>`;
                }
                svg += `</g></svg>`;

                container.innerHTML = `
                    ${svg}
                    <div id="spin-wheel-center-overlay"></div>
                    <div id="spin-wheel-pointer"></div>
                `;
            };

            const renderCrate = () => {
                const closedCrate = $('#crate-image-closed');
                const openCrate = $('#crate-image-open');
                closedCrate.src = siteSettings['crate-closed-image'] || 'https://i.imgur.com/gO2nB5v.png';
                openCrate.src = siteSettings['crate-open-image'] || 'https://i.imgur.com/3w3e6Wg.png';
                closedCrate.classList.remove('shaking', 'opening');
                closedCrate.classList.add('glowing');
                openCrate.classList.remove('visible');
            }

            const playCrateOpeningAnimation = (callback) => {
                const closedCrate = $('#crate-image-closed');
                const openCrate = $('#crate-image-open');
        
                closedCrate.classList.remove('glowing');
                closedCrate.classList.add('shaking');

                setTimeout(() => {
                    closedCrate.classList.remove('shaking');
                    closedCrate.classList.add('opening');
                    openCrate.classList.add('visible');
            
                    setTimeout(callback, 1000); 
                }, 2000); 
            };

            const bindLuckGameEventListeners = () => {
                document.body.addEventListener('click', e => { 
                    if (e.target.id === 'spin-wheel-nav-btn') {
                        if(currentUser && currentUser.displayName) {
                            $('#spin-user-name').value = currentUser.displayName;
                        }
                        checkSpinCooldown();
                        openModal('spin-wheel'); 
                    }
                });
                $('#spin-wheel-close-btn').addEventListener('click', () => {
                    closeModal('spin-wheel');
                    if(spinTimerInterval) clearInterval(spinTimerInterval);
                });
                $('#spin-result-close-btn').addEventListener('click', () => closeModal('spin-result'));

                $('#spin-wheel-prize-form').addEventListener('submit', e => {
                    e.preventDefault();
                    const prizes = siteSettings['spin-wheel-prizes'] || [];
                    const editIndex = $('#spin-prize-edit-index-input').value;
                    const prizeName = $('#spin-prize-name-input').value;
            
                    if (!prizeName) { 
                        showToast("Prize Name is required.", null, false); 
                        return; 
                    }
            
                    const prizeData = {
                        name: prizeName, color: $('#spin-prize-color-input').value,
                        textColor: $('#spin-prize-text-color-input').value,
                        message: $('#spin-prize-message-input').value, image: $('#spin-prize-image-input').value,
                    };

                    if(editIndex !== '') { prizes[editIndex] = prizeData; showToast('Prize updated! Click "Save Changes".'); } 
                    else {
                        if (prizes.length < 8) {
                            prizes.push(prizeData); siteSettings['spin-wheel-prizes'] = prizes;
                            showToast('Prize added! Click "Save Changes".');
                        } else { showToast("You can add a maximum of 8 prizes.", null, false); }
                    }
                    renderSpinWheelAdmin(); 
                    if (siteSettings['luck-game-type'] === 'wheel') renderSpinWheelSVG('spin-wheel-game-area');
                    $('#spin-wheel-prize-form').reset(); $('#spin-prize-edit-index-input').value = '';
                    $('#spin-prize-form-title').textContent = 'Prizes & Wheel Preview'; $('#cancel-edit-prize-btn').classList.add('hidden');
                });
        
                $('#cancel-edit-prize-btn').addEventListener('click', () => {
                    $('#spin-wheel-prize-form').reset(); $('#spin-prize-edit-index-input').value = '';
                    $('#spin-prize-form-title').textContent = 'Prizes & Wheel Preview'; $('#cancel-edit-prize-btn').classList.add('hidden');
                });

                $('#spin-wheel-prizes-list').addEventListener('click', e => {
                    const prizes = siteSettings['spin-wheel-prizes'];
                    if (e.target.matches('.remove-spin-prize-btn')) {
                        prizes.splice(e.target.dataset.index, 1); 
                        renderSpinWheelAdmin(); 
                        if (siteSettings['luck-game-type'] === 'wheel') renderSpinWheelSVG('spin-wheel-game-area');
                        showToast('Prize removed! Click "Save Changes" to make it permanent.');
                    }
                    if(e.target.matches('.edit-spin-prize-btn')) {
                        const index = e.target.dataset.index; const prize = prizes[index];
                        $('#spin-prize-edit-index-input').value = index; $('#spin-prize-name-input').value = prize.name;
                        $('#spin-prize-color-input').value = prize.color; $('#spin-prize-text-color-input').value = prize.textColor || '#ffffff';
                        $('#spin-prize-message-input').value = prize.message; $('#spin-prize-image-input').value = prize.image || '';
                        $('#spin-prize-form-title').textContent = 'Editing Prize'; $('#cancel-edit-prize-btn').classList.remove('hidden');
                    }
                });
                $('#spin-wheel-winners-list').addEventListener('click', e => {
                    if (e.target.matches('.delete-winner-btn')) {
                        const indexToDelete = e.target.dataset.index; const reversedWinners = [...spinWinners].reverse();
                        reversedWinners.splice(indexToDelete, 1); spinWinners = reversedWinners.reverse();
                        renderSpinWheelAdmin(); showToast('Winner deleted! Click "Save Changes" to make it permanent.');
                    }
                });

                $('#spin-wheel-user-form').addEventListener('submit', e => {
                    e.preventDefault(); 
                    if (isSpinning || !currentUser) return;
            
                    const gameType = siteSettings['luck-game-type'] || 'wheel';
                    isSpinning = true;
            
                    const prizes = [...(siteSettings['spin-wheel-prizes'] || [])];
                    if (prizes.length === 0) { showToast("No prizes are configured for this game!", null, false); isSpinning = false; return; }
                    const winnerIndex = Math.floor(Math.random() * prizes.length);

                    const showResults = () => {
                        const winningPrize = prizes[winnerIndex];
                        const userName = $('#spin-user-name').value; const userPhone = $('#spin-user-phone').value;
                
                        $('#spin-result-prize').textContent = winningPrize.name;
                        $('#spin-result-message').textContent = winningPrize.message || "Your prize will be sent to you shortly.";
                        const resultImage = $('#spin-result-image');
                        if (winningPrize.image) {
                            resultImage.src = winningPrize.image; resultImage.classList.remove('hidden'); 
                        } else {
                            resultImage.classList.add('hidden');
                        }
                        $('#spin-result-title').textContent = winningPrize.name.toLowerCase().includes('better luck') ? "Better Luck Next Time!" : "Congratulations!";
                
                        openModal('spin-result');
                        spinWinners.push({ date: new Date().toISOString(), prize: winningPrize.name, name: userName, phone: userPhone, userId: currentUser.uid });
                
                        const cooldownEndTime = Date.now() + (96 * 60 * 60 * 1000); // MODIFIED: 96 hour cooldown
                        localStorage.setItem(`spinCooldownUntil_${currentUser.uid}`, cooldownEndTime);
                        checkSpinCooldown();
                        renderSpinWheelAdmin(); 
                        saveDataToFirestore(); 
                        isSpinning = false;
                    };

                    if (gameType === 'wheel') {
                        const numSegments = prizes.length;
                        const segmentAngle = 360 / numSegments;
                        const winningAngle = (winnerIndex * segmentAngle) + (segmentAngle / 2);
                        const finalRotation = (360 * 6) - winningAngle;

                        const wheel = $('#spin-wheel-svg-g');
                        if (!wheel) { isSpinning = false; return; }
                        wheel.style.transform = `rotate(${finalRotation}deg)`;
                
                        setTimeout(() => {
                            showResults();
                            wheel.style.transition = 'none'; 
                            wheel.style.transform = `rotate(${finalRotation % 360}deg)`;
                            setTimeout(() => {
                                wheel.style.transition = 'transform 5s cubic-bezier(0.25, 0.1, 0.25, 1)';
                            }, 100);
                        }, 5100);
                    } else { // Crate game
                        playCrateOpeningAnimation(showResults);
                    }
                });
            };
            
            const checkSpinCooldown = () => {
                if (!currentUser) return;
                // NEW: Admin bypass
                if(siteSettings.adminEmails.includes(currentUser.email)) {
                    $('#spin-now-btn').classList.remove('hidden');
                    $('#spin-timer-container').classList.add('hidden');
                    if(spinTimerInterval) clearInterval(spinTimerInterval);
                    return;
                }
                const cooldownEndTime = localStorage.getItem(`spinCooldownUntil_${currentUser.uid}`);
                const now = Date.now();
                if (cooldownEndTime && now < parseInt(cooldownEndTime)) {
                    $('#spin-now-btn').classList.add('hidden');
                    $('#spin-timer-container').classList.remove('hidden');
                    startSpinCooldownTimer(parseInt(cooldownEndTime));
                } else {
                    $('#spin-now-btn').classList.remove('hidden');
                    $('#spin-timer-container').classList.add('hidden');
                    if(spinTimerInterval) clearInterval(spinTimerInterval);
                }
            };
            const startSpinCooldownTimer = (endTime) => {
                if(spinTimerInterval) clearInterval(spinTimerInterval);
                const update = () => {
                    const distance = endTime - Date.now();
                    if(distance < 0) {
                        clearInterval(spinTimerInterval);
                        checkSpinCooldown();
                        return;
                    }
                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                    $('[data-unit="days-spin"]').textContent = String(days).padStart(2, '0');
                    $('[data-unit="hours-spin"]').textContent = String(hours).padStart(2, '0');
                    $('[data-unit="minutes-spin"]').textContent = String(minutes).padStart(2, '0');
                    $('[data-unit="seconds-spin"]').textContent = String(seconds).padStart(2, '0');
                };
                update();
                spinTimerInterval = setInterval(update, 1000);
            };

            const bindReviewSubmissionEventListeners = () => {
                $('#review-submission-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const name = $('#review-submission-name').value;
                    const quote = $('#review-submission-quote').value;
                    const rating = e.target.querySelector('input[name="review-rating"]:checked');
                    if (!rating) {
                        showToast("Please select a rating.", null, false);
                        return;
                    }
                    const newReview = {
                        id: Date.now().toString(),
                        name: name,
                        quote: quote,
                        rating: parseInt(rating.value)
                    };
                    reviews.push(newReview);
                    showToast("Thank you for your review!", null, true);

                    renderReviews();
                    renderAdminPanels();
                    saveDataToFirestore({ rerenderProducts: false, showAdminToast: false });
                    e.target.reset();
                    closeModal('review-submission');
                });
            };

            const setupProductScrollAnimation = () => {
                const observer = new IntersectionObserver((entries, obs) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('is-visible');
                            obs.unobserve(entry.target);
                        }
                    });
                }, { threshold: 0.1 });
                $$('.product-fade-in').forEach(card => observer.observe(card));
            };
            
            const bindEditorToolbarListeners = () => {
                document.body.addEventListener('click', e => {
                    const toolbar = e.target.closest('.editor-toolbar');
                    if (!toolbar) return;
                    
                    const btn = e.target.closest('button');
                    if (!btn) return;

                    const targetId = toolbar.dataset.target;
                    const textarea = $(`#${targetId}`);
                    const action = btn.textContent;
                    const openTag = action === 'B' ? '<b>' : '<i>';
                    const closeTag = action === 'B' ? '</b>' : '</i>';

                    if (action === 'B' || action === 'I') {
                        const start = textarea.selectionStart, end = textarea.selectionEnd;
                        const selectedText = textarea.value.substring(start, end);
                        const newText = `${openTag}${selectedText}${closeTag}`;
                        textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
                        textarea.focus();
                        textarea.setSelectionRange(start + openTag.length, end + openTag.length);
                    } else if (action === 'Image') {
                        const imageUrl = prompt("Enter image URL:");
                        if (imageUrl) {
                            const imgTag = `<img src="${imageUrl}" alt="" style="max-width: 100%; height: auto; border-radius: 8px;">`;
                            const start = textarea.selectionStart;
                            textarea.value = textarea.value.substring(0, start) + imgTag + textarea.value.substring(start);
                        }
                    }
                });
            };
    
            // --- MESSAGING FUNCTIONS ---
            async function fetchUsers() {
                const usersCollection = collection(db, "users");
                const userSnapshot = await getDocs(usersCollection);
                currentUsersList = userSnapshot.docs.map(doc => doc.data());
                return currentUsersList;
            }

            async function renderAdminUsers(searchTerm = '') {
                const listContainer = $('#admin-users-list');
                if(currentUsersList.length === 0) await fetchUsers();
                
                Object.values(userCooldownIntervals).forEach(clearInterval);
                
                let filteredUsers = currentUsersList;
                if(searchTerm) {
                    searchTerm = searchTerm.toLowerCase();
                    filteredUsers = currentUsersList.filter(user => 
                        (user.name && user.name.toLowerCase().includes(searchTerm)) ||
                        (user.email && user.email.toLowerCase().includes(searchTerm)) ||
                        (user.uid && user.uid.toLowerCase().includes(searchTerm))
                    );
                }
        
                if(filteredUsers.length === 0) {
                    listContainer.innerHTML = `<p class="text-gray-500">No users found.</p>`;
                    return;
                }

                const header = `<div class="grid grid-cols-5 gap-4 font-bold p-2 border-b"><span>Name</span><span>Email</span><span class="col-span-2">User ID</span><span>Spin Cooldown</span></div>`;
                listContainer.innerHTML = header + filteredUsers.map(user => `
                    <div class="grid grid-cols-5 gap-4 p-2 border-b items-center text-sm">
                        <span class="truncate">${user.name || user.displayName || 'N/A'}</span>
                        <span class="truncate">${user.email || 'N/A'}</span>
                        <span class="col-span-2 selectable-uid" title="Click to copy">${user.uid}</span>
                        <div class="flex items-center gap-2">
                             <span id="cooldown-timer-${user.uid}" class="text-xs font-mono"></span>
                             <button class="reset-cooldown-btn text-xs bg-red-100 text-red-700 px-2 py-1 rounded" data-uid="${user.uid}">Reset</button>
                        </div>
                    </div>
                `).join('');

                filteredUsers.forEach(user => {
                    const timerEl = $(`#cooldown-timer-${user.uid}`);
                    if (!timerEl) return;
                    
                    const updateTimer = () => {
                        const endTime = localStorage.getItem(`spinCooldownUntil_${user.uid}`);
                        if (endTime && Date.now() < parseInt(endTime)) {
                            const distance = parseInt(endTime) - Date.now();
                            const hours = Math.floor(distance / (1000 * 60 * 60));
                            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                            timerEl.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                        } else {
                            timerEl.textContent = 'Ready';
                            if (userCooldownIntervals[user.uid]) clearInterval(userCooldownIntervals[user.uid]);
                        }
                    };
                    updateTimer();
                    userCooldownIntervals[user.uid] = setInterval(updateTimer, 10000);
                });
            }
    
            async function initAdminMessaging(searchTerm = '') {
                const userListPanel = $('#message-user-list');
                if(currentUsersList.length === 0) await fetchUsers();
        
                let filteredUsers = currentUsersList;
                if(searchTerm) {
                    searchTerm = searchTerm.toLowerCase();
                    filteredUsers = currentUsersList.filter(user => 
                        (user.name && user.name.toLowerCase().includes(searchTerm)) ||
                        (user.email && user.email.toLowerCase().includes(searchTerm))
                    );
                }

                if(filteredUsers.length === 0) {
                    userListPanel.innerHTML = `<p class="p-4 text-center text-gray-500">No users found.</p>`;
                    return;
                }
                userListPanel.innerHTML = filteredUsers.map(user => `
                    <div class="user-list-item" data-uid="${user.uid}">
                        <p class="font-bold">${user.name || user.displayName}</p>
                        <p class="text-sm text-gray-500">${user.email}</p>
                    </div>
                `).join('');
            }

            function loadAdminConversation(userId, userName) {
                currentAdminChatUserId = userId;
                $('#admin-chat-header').textContent = `Chat with ${userName}`;
                const msgInput = $('#admin-message-input');
                const sendBtn = $('#admin-message-send-btn');
                msgInput.disabled = false; sendBtn.disabled = false;

                $$('#message-user-list .user-list-item').forEach(el => el.classList.remove('active'));
                $(`#message-user-list .user-list-item[data-uid="${userId}"]`).classList.add('active');

                if (currentMessageListener) currentMessageListener();

                const messagesRef = collection(db, "messages", userId, "conversation");
                const q = query(messagesRef, orderBy("timestamp"));
        
                currentMessageListener = onSnapshot(q, (querySnapshot) => {
                    const messages = querySnapshot.docs.map(doc => doc.data());
                    renderMessages(messages, 'admin-messages-area', 'admin', userId);
                    markMessagesAsRead('admin', userId);
                });
            }
    
            async function loadUserConversation(userId) {
                if (currentMessageListener) currentMessageListener(); 
                const messagesRef = collection(db, "messages", userId, "conversation");
                const q = query(messagesRef, orderBy("timestamp"));
                currentMessageListener = onSnapshot(q, (querySnapshot) => {
                    const messages = querySnapshot.docs.map(doc => doc.data());
                    renderMessages(messages, 'user-messages-area', userId, 'admin');
                    markMessagesAsRead(userId, userId);
                });
            }

            function renderMessages(messages, containerId, viewerId, otherParticipantId) {
                const container = $(`#${containerId}`);
                if (!container) return;
                container.innerHTML = messages.length > 0 ? messages.map(msg => {
                    const isSent = msg.senderId === viewerId;
                    const isSeen = msg.readBy && msg.readBy.includes(otherParticipantId);
                    
                    let ticks = '';
                    if (isSent) {
                        ticks = `<span class="message-ticks ${isSeen ? 'seen' : ''}"></span>`;
                    }
                    
                    let time = '';
                    if(msg.timestamp && msg.timestamp.toDate) {
                        time = new Date(msg.timestamp.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    }

                    let content = '';
                    if(msg.text) content += `<div>${msg.text}</div>`;
                    if(msg.imageUrl) content += `<img src="${msg.imageUrl}" alt="Uploaded image" class="mt-2 max-w-full rounded-lg">`;

                    return `<div class="message-bubble ${isSent ? 'message-sent' : 'message-received'}">
                                ${content}
                                <div class="msg-meta">${time} ${ticks}</div>
                            </div>`;
                }).join('') : `<p class="text-center text-gray-500">No messages yet. Start the conversation!</p>`;
                container.scrollTop = container.scrollHeight;
            }

            async function sendMessage(receiverId, text, senderId, senderName, imageUrl = null) {
                if (!text.trim() && !imageUrl) return;
                const conversationRef = collection(db, "messages", receiverId, "conversation");
                await addDoc(conversationRef, {
                    text: text,
                    senderId: senderId,
                    senderName: senderName,
                    receiverId: receiverId,
                    timestamp: Timestamp.now(),
                    readBy: [senderId],
                    imageUrl: imageUrl
                });

                await setDoc(doc(db, "messages", receiverId), {
                    lastMessage: text || "Image",
                    lastSender: senderId,
                    lastTimestamp: Timestamp.now(),
                    participants: [senderId, receiverId],
                    readBy: [senderId]
                }, { merge: true });
            }

            function bindMessagingEventListeners() {
                $('#message-user-list').addEventListener('click', e => {
                    const userItem = e.target.closest('.user-list-item');
                    if (userItem) {
                        const user = currentUsersList.find(u => u.uid === userItem.dataset.uid);
                        loadAdminConversation(user.uid, user.name || user.displayName);
                    }
                });

                $('#admin-message-form').addEventListener('submit', async e => {
                    e.preventDefault();
                    if (!currentAdminChatUserId) return;
                    const input = $('#admin-message-input');
                    await sendMessage(currentAdminChatUserId, input.value, 'admin', 'Admin');
                    input.value = '';
                });

                $('#user-message-form').addEventListener('submit', async e => {
                    e.preventDefault();
                    if (!currentUser) return;
                    const input = $('#user-message-input');
                    const userName = currentUser.displayName || "Customer";
                    await sendMessage(currentUser.uid, input.value, currentUser.uid, userName);
                    input.value = '';
                });

                $('#admin-upload-image-btn').addEventListener('click', () => $('#admin-message-image-upload').click());
                $('#user-upload-image-btn').addEventListener('click', () => $('#user-message-image-upload').click());
        
                $('#admin-message-image-upload').addEventListener('change', async e => {
                    const file = e.target.files[0];
                    if(file && currentAdminChatUserId) {
                        const imageUrl = await uploadImage(file, `chats/${currentAdminChatUserId}`);
                        if(imageUrl) await sendMessage(currentAdminChatUserId, '', 'admin', 'Admin', imageUrl);
                    }
                    e.target.value = '';
                });

                $('#user-message-image-upload').addEventListener('change', async e => {
                    const file = e.target.files[0];
                    if(file && currentUser) {
                        const imageUrl = await uploadImage(file, `chats/${currentUser.uid}`);
                        if(imageUrl) {
                            const userName = currentUser.displayName || "Customer";
                            await sendMessage(currentUser.uid, '', currentUser.uid, userName, imageUrl);
                        }
                    }
                    e.target.value = '';
                });

                $('#messaging-search-input').addEventListener('input', debounce(e => initAdminMessaging(e.target.value), 300));
                $('#users-search-input').addEventListener('input', debounce(e => renderAdminUsers(e.target.value), 300));

                $('#admin-users-list').addEventListener('click', e => {
                    if (e.target.classList.contains('reset-cooldown-btn')) {
                        const uid = e.target.dataset.uid;
                        localStorage.removeItem(`spinCooldownUntil_${uid}`);
                        showToast(`Cooldown reset for user ${uid.slice(0,8)}...`);
                        renderAdminUsers($('#users-search-input').value);
                    }
                });
            }

            function listenForAdminNotifications() {
                if(adminNotificationListener) adminNotificationListener();
                
                const q = query(collection(db, "messages"));

                adminNotificationListener = onSnapshot(q, (snapshot) => {
                    let unreadCount = 0;
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        if (data.lastSender !== 'admin' && !data.readBy.includes('admin')) {
                            unreadCount++;
                        }
                    });
                    updateNotificationBadge('admin-login-btn', unreadCount);
                    updateNotificationBadge('admin-tab', unreadCount, '[data-tab="messaging"]');
                });
            }

            function listenForUserNotifications(userId) {
                if(userNotificationListener) userNotificationListener();
                const q = doc(db, "messages", userId);

                userNotificationListener = onSnapshot(q, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        if (data.lastSender === 'admin' && !data.readBy.includes(userId)) {
                            updateNotificationBadge('account-toggle-btn', 1);
                            updateNotificationBadge('account-tab', 1, '[data-tab="messages"]');
                        } else {
                            updateNotificationBadge('account-toggle-btn', 0);
                            updateNotificationBadge('account-tab', 0, '[data-tab="messages"]');
                        }
                    }
                });
            }
    
            function updateNotificationBadge(targetId, count, selector = null) {
                const targetElement = selector ? $(selector) : $(`#${targetId}`);
                if (!targetElement) return;
                const container = targetElement.closest('.notification-badge-container');
                if(!container) return;
        
                let badge = container.querySelector('.notification-badge');
                if(count > 0) {
                    if(!badge) {
                        badge = document.createElement('span');
                        badge.className = 'notification-badge';
                        container.appendChild(badge);
                    }
                    badge.textContent = count > 9 ? '9+' : count;
                } else {
                    if (badge) badge.remove();
                }
            }

            async function markMessagesAsRead(viewerId, conversationId) {
                if (!conversationId) return;
                try {
                    const topLevelDocRef = doc(db, "messages", conversationId);
                    await updateDoc(topLevelDocRef, { readBy: arrayUnion(viewerId) });
                } catch (error) {
                    // This error is expected for new conversations, so we can ignore it.
                    if (error.code !== 'not-found') {
                        console.warn("Could not mark messages as read:", error.message);
                    }
                }
            }
            
            async function saveAbandonedCart(user) {
                if (!user || !user.uid || cart.length === 0) return;
                const cartRef = doc(db, "abandonedCarts", user.uid);
                await setDoc(cartRef, {
                    userId: user.uid,
                    userName: user.displayName || 'N/A',
                    userEmail: user.email,
                    cart: cart,
                    lastUpdated: Timestamp.now()
                });
            }
            
            async function removeAbandonedCart(userId) {
                if (!userId) return;
                const cartRef = doc(db, "abandonedCarts", userId);
                await deleteDoc(cartRef).catch(err => console.log("No abandoned cart to remove or error:", err.message));
            }

            function renderAbandonedCarts() {
                const container = $('#admin-abandoned-carts-list');
                if (!container) return;

                const oneHourAgo = Date.now() - (60 * 60 * 1000);
                const filteredCarts = abandonedCarts
                    .filter(c => c.lastUpdated.toMillis() < oneHourAgo)
                    .sort((a, b) => b.lastUpdated.toMillis() - a.lastUpdated.toMillis());

                if (filteredCarts.length === 0) {
                    container.innerHTML = `<p class="text-gray-500">No abandoned carts found.</p>`;
                    return;
                }

                container.innerHTML = filteredCarts.map(cartData => {
                    const cartTotal = cartData.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                    return `
                        <div class="admin-abandoned-cart-card" data-id="${cartData.id}">
                            <div class="flex justify-between items-start">
                               <div>
                                    <p class="font-bold text-lg">${cartData.userName}</p>
                                    <p class="text-sm text-gray-600">${cartData.userEmail}</p>
                                    <p class="text-xs text-gray-500 mt-1">Last updated: ${new Date(cartData.lastUpdated.toDate()).toLocaleString()}</p>
                               </div>
                               <div class="text-right">
                                   <p class="font-bold text-lg">Rs. ${cartTotal.toLocaleString()}</p>
                                   <p class="text-sm text-gray-500">${cartData.cart.length} item(s)</p>
                               </div>
                            </div>
                            <div class="mt-4 pt-4 border-t">
                                <h4 class="font-semibold text-sm mb-2">Items in Cart:</h4>
                                <ul class="list-disc list-inside text-sm space-y-1">
                                    ${cartData.cart.map(item => `<li>${item.name} (x${item.quantity})</li>`).join('')}
                                </ul>
                            </div>
                            <div class="mt-4 flex gap-4">
                                <a href="#" class="email-client-btn w-full text-center px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-sm" data-email="${cartData.userEmail}" data-name="${cartData.userName}">Email Client</a>
                                <button class="delete-abandoned-cart-btn w-full px-4 py-2 bg-red-100 text-red-700 rounded-md hover:bg-red-200 text-sm">Delete</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            function bindAbandonedCartEventListeners() {
                $('#admin-abandoned-carts-list').addEventListener('click', async e => {
                    const card = e.target.closest('.admin-abandoned-cart-card');
                    if (!card) return;
                    const cartId = card.dataset.id;
                    
                    if (e.target.matches('.email-client-btn')) {
                        e.preventDefault();
                        const email = e.target.dataset.email;
                        const name = e.target.dataset.name;
                        const subject = `You left something in your cart at ${siteSettings['store-name']}!`;
                        const body = `Hi ${name},\n\nWe noticed you left some items in your shopping cart. Don't miss out! Your items are waiting for you.\n\nClick here to complete your purchase: ${window.location.href}\n\nThanks,\nThe ${siteSettings['store-name']} Team`;
                        window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    }

                    if (e.target.matches('.delete-abandoned-cart-btn')) {
                        if (confirm('Are you sure you want to delete this abandoned cart record?')) {
                            await deleteDoc(doc(db, "abandonedCarts", cartId));
                            abandonedCarts = abandonedCarts.filter(c => c.id !== cartId);
                            renderAbandonedCarts();
                            showToast('Abandoned cart record deleted.');
                        }
                    }
                });
            }

            async function signInWithGoogle() {
                const provider = new GoogleAuthProvider();
                try {
                    const result = await signInWithPopup(auth, provider);
                    const user = result.user;
                    const userDocRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);
                    if (!userDoc.exists()) {
                        await setDoc(userDocRef, {
                            name: user.displayName,
                            email: user.email,
                            uid: user.uid,
                            displayName: user.displayName,
                            photoURL: user.photoURL
                        });
                        await fetchUsers();
                    }
                    closeModal('login');
                } catch (error) {
                    console.error("Google sign-in error:", error);
                    $('#login-error').textContent = `Google Sign-In Failed: ${error.message}`;
                    $('#login-error').classList.remove('hidden');
                }
            }
    
            async function uploadImage(file, path) {
                const storageRef = ref(storage, `${path}/${Date.now()}-${file.name}`);
                try {
                    const snapshot = await uploadBytes(storageRef, file);
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    showToast("Image uploaded successfully!", null, true);
                    return downloadURL;
                } catch (error) {
                    console.error("Image upload failed:", error);
                    showToast("Image upload failed. This usually happens when running the page as a local file. Please use a web server.", null, false);
                    return null;
                }
            }
            
            function bindPaymentMethodEventListeners() {
                $('#add-payment-method-btn').addEventListener('click', () => {
                    const newMethod = {
                        id: Date.now().toString(),
                        title: 'New Method',
                        image: 'https://placehold.co/200x150/ccc/999?text=Image',
                        details: 'Account Title: \nAccount Number: '
                    };
                    siteSettings['payment-methods'].push(newMethod);
                    renderPaymentMethodsAdmin();
                });
                $('#payment-methods-list').addEventListener('click', e => {
                    const card = e.target.closest('.payment-method-card');
                    if (!card) return;
                    if (e.target.matches('.delete-payment-method-btn')) {
                        if (confirm('Are you sure you want to delete this payment method?')) {
                            const idToDelete = card.dataset.id;
                            siteSettings['payment-methods'] = siteSettings['payment-methods'].filter(m => m.id !== idToDelete);
                            renderPaymentMethodsAdmin();
                        }
                    }
                });
                $('#payment-methods-modal-content').addEventListener('click', e => {
                    const item = e.target.closest('.payment-method-item');
                    if (item) {
                        const method = siteSettings['payment-methods'].find(m => m.id === item.dataset.id);
                        if (method) {
                            $('#payment-detail-image').src = method.image;
                            $('#payment-detail-title').textContent = method.title;
                            $('#payment-detail-details').textContent = method.details;
                            openModal('payment-detail');
                        }
                    }
                });
            }

            function renderPaymentMethodsAdmin() {
                const container = $('#payment-methods-list');
                const methods = siteSettings['payment-methods'] || [];
                if (methods.length === 0) {
                    container.innerHTML = `<p class="text-gray-500">No payment methods added yet.</p>`;
                    return;
                }
                container.innerHTML = methods.map(method => `
                    <div class="p-4 border rounded-lg bg-gray-50 payment-method-card" data-id="${method.id}">
                        <div class="flex justify-end mb-2">
                             <button class="delete-payment-method-btn text-red-500 hover:text-red-700 font-bold" type="button">&times; Delete</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="admin-label">Title</label>
                                <input type="text" class="admin-input payment-title-input" value="${method.title}">
                            </div>
                             <div>
                                <label class="admin-label">Image URL</label>
                                <div class="flex items-center gap-4">
                                  <input id="payment-image-input-${method.id}" type="text" value="${method.image}" class="admin-input payment-image-input">
                                  <label class="upload-btn"><input type="file" class="hidden file-input" data-target="payment-image-input-${method.id}">Upload</label>
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                <label class="admin-label">Account Details</label>
                                <textarea class="admin-textarea payment-details-input" rows="4">${method.details}</textarea>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            function bindWhatsappPreviewListeners() {
                $('#whatsapp-message-template').addEventListener('input', () => renderWhatsappPreviews());
                $('#whatsapp-contact-template').addEventListener('input', () => renderWhatsappPreviews());
            }

            function renderWhatsappPreviews() {
                const customerPreviewContainer = $('#whatsapp-customer-preview');
                const adminPreviewContainer = $('#whatsapp-admin-preview');

                const dummyData = {
                    storeName: siteSettings['store-name'] || 'Your Store',
                    orderNumber: `${siteSettings['order-id-prefix'] || 'NB'}-12345`,
                    customerName: 'John Doe',
                    phone: '923001234567',
                    orderItems: '- Product A (Red) x1 = Rs. 1,000\n- Product B x2 = Rs. 1,500',
                    subtotal: 'Rs. 2,500',
                    discountInfo: 'Yes (Code: SALE10) -Rs. 250',
                    deliveryCharges: 'Rs. 200',
                    total: 'Rs. 2,450',
                    shippingAddress: '123 Main St, Karachi',
                    paymentMethod: 'Cash on Delivery',
                    storeLogoUrl: siteSettings['store-logo'] || ''
                };

                // Customer checkout message preview
                let customerMessage = $('#whatsapp-message-template').value;
                for (const key in dummyData) {
                    customerMessage = customerMessage.replace(new RegExp(`{${key}}`, 'g'), dummyData[key]);
                }
                customerPreviewContainer.innerHTML = `<div class="whatsapp-preview-bubble">${customerMessage}</div>`;

                // Admin contact message preview
                let adminMessage = $('#whatsapp-contact-template').value;
                for (const key in dummyData) {
                    adminMessage = adminMessage.replace(new RegExp(`{${key}}`, 'g'), dummyData[key]);
                }
                adminPreviewContainer.innerHTML = `<div class="whatsapp-preview-bubble received">${adminMessage}</div>`;
            }

            function bindProductSEOPreviewListeners() {
                $('#product-name-input').addEventListener('input', updateProductSEOPreview);
                $('#product-meta-description-input').addEventListener('input', updateProductSEOPreview);
                $('#product-meta-keywords-input').addEventListener('input', updateProductSEOPreview);
            }
            
            function updateProductSEOPreview() {
                const name = $('#product-name-input').value || 'Product Name';
                const description = $('#product-meta-description-input').value || 'This is where the meta description for the product will appear.';
                const keywords = $('#product-meta-keywords-input').value;
            
                $('.seo-preview-title').textContent = name;
                $('.seo-preview-url').textContent = `https://yourstore.com/products/${name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '')}`;
                $('.seo-preview-description').textContent = description;
            
                const descCounter = $('#product-meta-description-counter');
                const descLength = description.length;
                descCounter.textContent = `${descLength} / 160`;
                descCounter.className = 'char-counter ';
                if (descLength > 160) descCounter.classList.add('over');
                else if (descLength > 130) descCounter.classList.add('warn');
                else if (descLength > 0) descCounter.classList.add('ok');
            
                const keywordCounter = $('#product-meta-keywords-counter');
                const keywordLength = keywords.length;
                keywordCounter.textContent = `${keywordLength} / 255`;
                keywordCounter.className = 'char-counter ';
                if (keywordLength > 255) keywordCounter.classList.add('over');
                else if (keywordLength > 200) keywordCounter.classList.add('warn');
                else if (keywordLength > 0) keywordCounter.classList.add('ok');
            }
            
            function bindPasswordToggleListener() {
                const toggle = $('#password-toggle-icon');
                const input = $('#password-input');
                if (toggle && input) {
                    toggle.addEventListener('click', () => {
                        const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                        input.setAttribute('type', type);
                        toggle.querySelector('svg').classList.toggle('text-blue-500'); 
                    });
                }
            }

            function bindOrderActionListeners() {
                $('#admin-orders-list').addEventListener('click', e => {
                    if (e.target.matches('.delete-order-btn')) {
                        const card = e.target.closest('.admin-order-card');
                        const orderId = card.dataset.id;
                        if (confirm(`Are you sure you want to delete Order #${orderId}? This will move it to the Deleted Orders tab.`)) {
                            const orderIndex = orders.findIndex(o => o.id === orderId);
                            if (orderIndex > -1) {
                                const [deletedOrder] = orders.splice(orderIndex, 1);
                                deletedOrders.push(deletedOrder);
                                renderAdminOrders($('.order-filter-btn.active').dataset.status);
                                renderDeletedOrders();
                                showToast(`Order #${orderId} moved to deleted.`);
                            }
                        }
                    }
                });

                $('#admin-deleted-orders-list').addEventListener('click', e => {
                    if (e.target.matches('.restore-order-btn')) {
                        const orderId = e.target.dataset.id;
                        const orderIndex = deletedOrders.findIndex(o => o.id === orderId);
                        if (orderIndex > -1) {
                            const [restoredOrder] = deletedOrders.splice(orderIndex, 1);
                            orders.push(restoredOrder);
                            renderAdminOrders($('.order-filter-btn.active').dataset.status);
                            renderDeletedOrders();
                            showToast(`Order #${orderId} has been restored.`);
                        }
                    }
                });
            }
            
            function showOrderSuccessPopup() {
                $('#order-success-image').src = siteSettings['order-success-header'] || 'https://placehold.co/300x150/dcfce7/22c55e?text=Success!';
                $('#order-success-message').innerHTML = siteSettings['order-success-message'] || '<h2>Order Placed!</h2><p>Thank you for your purchase.</p>';
                openModal('order-success');
            }

            function bindOrderSuccessPreviewListeners() {
                $('#order-success-header-input').addEventListener('input', e => {
                    $('#order-success-preview-image').src = e.target.value || 'https://placehold.co/300x150/dcfce7/22c55e?text=Success!';
                });
                $('#order-success-message-input').addEventListener('input', e => {
                    $('#order-success-preview-message').innerHTML = e.target.value || 'Your message will appear here.';
                });
            }
            
            function renderAllReviewsModal() {
                const grid = $('#all-reviews-grid');
                if (!grid) return;
                if (reviews.length === 0) {
                    grid.innerHTML = '<p class="text-gray-500 col-span-full text-center p-8">No customer reviews yet. Be the first!</p>';
                    return;
                }
                grid.innerHTML = reviews.map((r, index) => `
                    <div class="review-card" style="animation-delay: ${index * 100}ms;">
                        <div class="review-card-stars">${getStarRatingHTML(r.rating, null, false)}</div>
                        <p class="text-gray-600 italic mb-4 flex-grow review-quote">"${r.quote}"</p>
                        <p class="font-bold text-gray-800 text-right">- ${r.name}</p>
                    </div>
                `).join('');

                const urlContainer = $('#all-reviews-url-container');
                const url = siteSettings['all-reviews-url'];
                const text = siteSettings['all-reviews-url-text'];
                if(url && text) {
                    urlContainer.innerHTML = `<a href="${url}" class="category-btn">${text}</a>`;
                } else {
                    urlContainer.innerHTML = '';
                }
            }

            function updateReviewsButtonPreview() {
                const btn = $('#floating-reviews-btn-preview');
                const color1 = $('#reviews-btn-color1-input').value;
                const color2 = $('#reviews-btn-color2-input').value;
                const textColor = $('#reviews-btn-text-color-input').value;
                btn.style.background = `linear-gradient(135deg, ${color1}, ${color2})`;
                btn.style.color = textColor;
            }

            function bindReviewsAdminListeners() {
                $('#reviews-btn-color1-input').addEventListener('input', updateReviewsButtonPreview);
                $('#reviews-btn-color2-input').addEventListener('input', updateReviewsButtonPreview);
                $('#reviews-btn-text-color-input').addEventListener('input', updateReviewsButtonPreview);
                
                $('#review-font-family-select').addEventListener('input', updateReviewStylePreview);
                $('#review-font-weight-select').addEventListener('input', updateReviewStylePreview);
                $('#review-text-color-input').addEventListener('input', updateReviewStylePreview);
                $('#review-font-size-input').addEventListener('input', updateReviewStylePreview);
            }
            
            function renderAdminUserManagement() {
                const container = $('#admin-users-list-container');
                const admins = siteSettings.adminEmails || [];
                container.innerHTML = admins.map(email => `
                    <div class="admin-user-management-card flex justify-between items-center" data-email="${email}">
                        <p class="font-mono text-sm">${email}</p>
                        ${email !== 'saeedilyas59@gmail.com' ? `<button class="remove-admin-btn text-red-500 hover:text-red-700 font-bold" type="button">&times;</button>` : '<span class="text-xs text-gray-400">Primary</span>'}
                    </div>
                `).join('');
            }

            function bindAdminManagementListeners() {
                $('#add-admin-form').addEventListener('submit', e => {
                    e.preventDefault();
                    const input = $('#new-admin-email-input');
                    const newEmail = input.value.trim().toLowerCase();
                    if (newEmail && !siteSettings.adminEmails.includes(newEmail)) {
                        siteSettings.adminEmails.push(newEmail);
                        renderAdminUserManagement();
                        showToast('Admin added. Save changes to make it permanent.');
                        input.value = '';
                    } else {
                        showToast('Email is invalid or already an admin.', null, false);
                    }
                });

                $('#admin-users-list-container').addEventListener('click', e => {
                    if (e.target.matches('.remove-admin-btn')) {
                        const emailToRemove = e.target.closest('.admin-user-management-card').dataset.email;
                        if (confirm(`Are you sure you want to remove ${emailToRemove} as an admin?`)) {
                            siteSettings.adminEmails = siteSettings.adminEmails.filter(email => email !== emailToRemove);
                            renderAdminUserManagement();
                             showToast('Admin removed. Save changes to make it permanent.');
                        }
                    }
                });
            }

            function bindTicketEventListeners() {
                $('#support-ticket-close-btn').addEventListener('click', () => closeModal('support-ticket'));
                $('#support-ticket-form').addEventListener('submit', e => {
                    e.preventDefault();
                    if (!currentUser) return;
                    
                    const subject = $('#support-ticket-subject').value;
                    const newTicket = {
                        id: Date.now().toString(),
                        userId: currentUser.uid,
                        userName: currentUser.displayName || 'N/A',
                        subject: subject,
                        query: $('#support-ticket-query').value,
                        status: 'Open',
                        createdAt: new Date().toISOString(),
                        lastUserView: Date.now(),
                        replies: [{
                            by: 'admin',
                            text: `We have received your ticket regarding "${subject}". A support agent will be in contact with you shortly.`,
                            date: new Date().toISOString()
                        }]
                    };
                    tickets.push(newTicket);
                    saveDataToFirestore({ showAdminToast: false });
                    showToast('Support ticket submitted successfully!');
                    closeModal('support-ticket');
                    e.target.reset();
                });

                $('#add-ticket-subject-form').addEventListener('submit', e => {
                    e.preventDefault();
                    const input = $('#new-ticket-subject-input');
                    const newSubject = input.value.trim();
                    if(newSubject && !siteSettings.ticketSubjects.includes(newSubject)) {
                        siteSettings.ticketSubjects.push(newSubject);
                        renderAdminTicketSubjects();
                        input.value = '';
                    }
                });
                
                $('#admin-ticket-subjects-list').addEventListener('click', e => {
                    if (e.target.matches('.delete-ticket-subject-btn')) {
                        const subjectToRemove = e.target.dataset.subject;
                        siteSettings.ticketSubjects = siteSettings.ticketSubjects.filter(s => s !== subjectToRemove);
                        renderAdminTicketSubjects();
                    }
                });

                $('#admin-tickets-list').addEventListener('click', e => {
                    const card = e.target.closest('.admin-ticket-card');
                    if (!card) return;
                    const ticketId = card.dataset.id;
                    const ticket = tickets.find(t => t.id === ticketId);
                    if (!ticket) return;

                    if (e.target.matches('.delete-ticket-btn')) {
                        if (confirm(`This will mark the ticket as 'Deleted'. Are you sure?`)) {
                            ticket.status = 'Deleted';
                            renderAdminTickets($('.ticket-filter-btn.active').dataset.status);
                        }
                    } else if (e.target.matches('.ticket-reply-btn')) {
                        const replyText = card.querySelector('.ticket-reply-input').value;
                        if (replyText) {
                            ticket.replies = ticket.replies || [];
                            ticket.replies.push({ by: 'admin', text: replyText, date: new Date().toISOString() });
                            renderAdminTickets($('.ticket-filter-btn.active').dataset.status);
                            card.querySelector('.ticket-reply-input').value = '';
                        }
                    }
                });

                $('#admin-tickets-list').addEventListener('change', e => {
                     if (e.target.matches('.ticket-status-select')) {
                        const ticketId = e.target.dataset.id;
                        const ticket = tickets.find(t => t.id === ticketId);
                        if (ticket) ticket.status = e.target.value;
                        renderAdminTickets($('.ticket-filter-btn.active').dataset.status);
                    }
                });

                 $$('.ticket-filter-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        $$('.ticket-filter-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        renderAdminTickets(btn.dataset.status);
                    });
                });

                // Live preview for support button
                $('#support-btn-color1-input, #support-btn-color2-input, #support-btn-text-color-input').addEventListener('input', updateSupportButtonPreview);
                $('#ticket-button-enabled-input').addEventListener('change', e => {
                     $('#floating-support-btn').style.display = e.target.checked ? 'flex' : 'none';
                });
            }
             // MODIFIED: Floating button behavior
            function bindFloatingButtonEventListeners() {
                const reviewsBtn = $('#floating-reviews-btn');
                const supportBtn = $('#floating-support-btn');

                reviewsBtn.addEventListener('click', () => {
                    if (reviewsBtn.classList.contains('is-open')) {
                        renderAllReviewsModal();
                        openModal('all-reviews');
                    } else {
                        reviewsBtn.classList.add('is-open');
                        supportBtn.classList.remove('is-open'); // Close other button
                    }
                });
        
                supportBtn.addEventListener('click', () => {
                    if (supportBtn.classList.contains('is-open')) {
                        if (!currentUser) { 
                            showToast("Please login to create a support ticket.", null, false);
                            openModal('login'); 
                            return; 
                        }
                        const subjectSelect = $('#support-ticket-subject');
                        subjectSelect.innerHTML = `<option value="">-- Select a Topic --</option>` + (siteSettings.ticketSubjects || []).map(s => `<option value="${s}">${s}</option>`).join('');
                        openModal('support-ticket');
                    } else {
                        supportBtn.classList.add('is-open');
                        reviewsBtn.classList.remove('is-open'); // Close other button
                    }
                });

                // Close when clicking away
                document.addEventListener('click', (e) => {
                    if (!reviewsBtn.contains(e.target) && !e.target.closest('#all-reviews-modal')) {
                        reviewsBtn.classList.remove('is-open');
                    }
                     if (!supportBtn.contains(e.target) && !e.target.closest('#support-ticket-modal')) {
                        supportBtn.classList.remove('is-open');
                    }
                });
            }

            function renderAdminTicketSubjects() {
                const container = $('#admin-ticket-subjects-list');
                const subjects = siteSettings.ticketSubjects || [];
                container.innerHTML = subjects.map(s => `
                    <div class="flex items-center gap-2 mb-2">
                        <input type="text" class="admin-input ticket-subject-input" value="${s}">
                        <button type="button" class="delete-ticket-subject-btn text-red-500 hover:text-red-700 font-bold" data-subject="${s}">&times;</button>
                    </div>
                `).join('');
            }
            
            function renderAdminTickets(filter = 'All') {
                const container = $('#admin-tickets-list');
                let filteredTickets = tickets;
                if(filter !== 'All') {
                    filteredTickets = tickets.filter(t => t.status === filter);
                }

                container.innerHTML = filteredTickets.length > 0 ? [...filteredTickets].reverse().map(ticket => `
                    <div class="admin-ticket-card" data-id="${ticket.id}">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold text-lg">Ticket #${ticket.id}</p>
                                <p>From: ${ticket.userName} <span class="text-sm text-gray-500">(${new Date(ticket.createdAt).toLocaleString()})</span></p>
                            </div>
                            <button class="delete-ticket-btn text-red-500 hover:text-red-700 text-sm">Delete</button>
                        </div>
                        <p class="mt-4 p-4 bg-white border rounded">${ticket.query}</p>
                        <div class="mt-4 border-t pt-4">
                            <h4 class="font-semibold text-sm mb-2">Replies</h4>
                            <div class="space-y-2 mb-4 text-sm">
                                ${(ticket.replies || []).map(reply => `
                                    <div class="p-2 rounded ${reply.by === 'admin' ? 'bg-blue-50 text-right' : 'bg-gray-50'}">
                                        <p>${reply.text}</p>
                                        <p class="text-xs text-gray-400 mt-1">${new Date(reply.date).toLocaleString()}</p>
                                    </div>
                                `).join('') || '<p class="text-xs text-gray-500">No replies yet.</p>'}
                            </div>
                            <div class="flex items-center gap-2">
                                <textarea class="admin-textarea ticket-reply-input" rows="2" placeholder="Type your reply..."></textarea>
                                <button class="ticket-reply-btn px-4 py-2 bg-blue-500 text-white rounded-md text-sm">Reply</button>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="admin-label">Status</label>
                            <select class="admin-select ticket-status-select" data-id="${ticket.id}">
                                <option value="Open" ${ticket.status === 'Open' ? 'selected' : ''}>Open</option>
                                <option value="In Progress" ${ticket.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                <option value="Solved" ${ticket.status === 'Solved' ? 'selected' : ''}>Solved</option>
                                <option value="Closed" ${ticket.status === 'Closed' ? 'selected' : ''}>Closed</option>
                                <option value="Deleted" ${ticket.status === 'Deleted' ? 'selected' : ''}>Deleted</option>
                            </select>
                        </div>
                    </div>
                `).join('') : '<p class="text-gray-500 text-center">No support tickets found.</p>';
            }

            function renderUserTickets() {
                const container = $('#user-tickets-container');
                if (!currentUser) return;
                const userTickets = tickets.filter(t => t.userId === currentUser.uid && t.status !== 'Deleted').reverse();
                 if (userTickets.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center">You have not submitted any tickets.</p>';
                    return;
                }
                container.innerHTML = userTickets.map(ticket => `
                    <div class="border rounded-lg p-4 bg-gray-50">
                        <div class="flex justify-between items-center border-b pb-2 mb-2">
                            <div><p class="font-bold">${ticket.subject}</p><p class="text-sm text-gray-500">${new Date(ticket.createdAt).toLocaleDateString()}</p></div>
                             <span class="px-3 py-1 text-sm font-semibold rounded-full ${ticket.status === 'Solved' || ticket.status === 'Closed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${ticket.status}</span>
                        </div>
                        <p class="text-sm my-2 p-2 bg-white rounded"><strong>Your Query:</strong> ${ticket.query}</p>
                        ${(ticket.replies || []).length > 0 ? `
                        <div class="mt-2 pt-2 border-t">
                             <h4 class="font-semibold text-xs mb-1">Replies:</h4>
                             <div class="space-y-1 text-sm">
                                 ${(ticket.replies || []).map(reply => `
                                    <div class="p-2 rounded ${reply.by === 'admin' ? 'bg-blue-50' : 'bg-gray-50'}">
                                        <p>${reply.text}</p>
                                        <p class="text-xs text-gray-400 mt-1">${new Date(reply.date).toLocaleString()}</p>
                                    </div>
                                `).join('')}
                             </div>
                        </div>` : ''}
                    </div>
                `).join('');
            }
        
            function updateIcon(container, url, defaultSvg) {
                let element = typeof container === 'string' ? $(`#${container}`) : container;
                if (!element) return;
                
                if (url && url.trim() !== '') {
                    if (url.trim().startsWith('<svg')) {
                        element.innerHTML = url;
                        const svg = element.querySelector('svg');
                        if (svg) svg.classList.add('w-6', 'h-6');
                    } else if (url.endsWith('.svg')) {
                        fetch(url)
                            .then(response => response.text())
                            .then(svgText => {
                                const parser = new DOMParser();
                                const svgDoc = parser.parseFromString(svgText, "image/svg+xml");
                                const svgElement = svgDoc.querySelector('svg');
                                if (svgElement) {
                                    svgElement.classList.add('w-6', 'h-6');
                                    element.innerHTML = '';
                                    element.appendChild(svgElement);
                                } else {
                                    element.innerHTML = defaultSvg;
                                }
                            }).catch(() => element.innerHTML = defaultSvg);
                    } else {
                        element.innerHTML = `<img src="${url}" class="w-6 h-6 object-contain" alt="icon">`;
                    }
                } else {
                    element.innerHTML = defaultSvg;
                }
            }

            function bindUserSecurityEventListeners() {
                $('#user-password-change-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newPassword = $('#user-new-password').value;
                    const confirmPassword = $('#user-confirm-password').value;
                    const user = auth.currentUser;

                    if (!user) {
                        showToast('You must be logged in to change your password.', null, false);
                        return;
                    }
                    if (newPassword.length < 6) {
                        showToast('Password must be at least 6 characters long.', null, false);
                        return;
                    }
                    if (newPassword !== confirmPassword) {
                        showToast('Passwords do not match.', null, false);
                        return;
                    }

                    try {
                        await updatePassword(user, newPassword);
                        showToast('Your password has been updated successfully!');
                        e.target.reset();
                    } catch (error) {
                        console.error("Password update error:", error);
                        showToast(`Error: ${error.message}. You may need to log out and log back in to perform this action.`, null, false);
                    }
                });
            }

            function updateSupportButtonPreview() {
                const btn = $('#floating-support-btn-preview');
                const color1 = $('#support-btn-color1-input').value;
                const color2 = $('#support-btn-color2-input').value;
                const textColor = $('#support-btn-text-color-input').value;
                btn.style.background = `linear-gradient(135deg, ${color1}, ${color2})`;
                btn.style.color = textColor;
            }
            
            function updateFontPreview() {
                const nameFont = $('#product-name-font-select').value;
                const nameWeight = $('#product-name-font-weight-select').value;
                const priceFont = $('#product-price-font-select').value;
                const priceWeight = $('#product-price-font-weight-select').value;
                
                const namePreview = $('#font-preview-name');
                const priceOriginalPreview = $('#font-preview-price-original');
                const priceSalePreview = $('#font-preview-price-sale');

                namePreview.style.fontFamily = nameFont;
                namePreview.style.fontWeight = nameWeight;
                priceOriginalPreview.style.fontFamily = priceFont;
                priceOriginalPreview.style.fontWeight = priceWeight;
                priceSalePreview.style.fontFamily = priceFont;
                priceSalePreview.style.fontWeight = priceWeight;
            }

            function updateAddToCartButtonPrice() {
                const btn = $('#product-detail-add-to-cart-btn');
                const quantity = parseInt($('#product-detail-quantity-selector span').textContent);

                // Get the actual product data instead of parsing displayed text
                const product = products.find(p => p.id == currentDetailProductId);
                if (!product) return;

                // Determine the correct price to use
                const displayPrice = product.salePrice && product.salePrice < product.price 
                    ? parseFloat(product.salePrice) 
                    : parseFloat(product.price);

                const total = displayPrice * quantity;
                btn.textContent = `Add to Cart - Rs. ${total.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            };
             
            function updateReviewStylePreview() {
                const preview = $('#review-style-preview p:first-child');
                preview.style.fontFamily = $('#review-font-family-select').value;
                preview.style.fontWeight = $('#review-font-weight-select').value;
                preview.style.color = $('#review-text-color-input').value;
                preview.style.fontSize = `${$('#review-font-size-input').value}px`;
            }
            
            function bindFontPreviewListeners() {
                $('#product-name-font-select').addEventListener('change', updateFontPreview);
                $('#product-name-font-weight-select').addEventListener('change', updateFontPreview);
                $('#product-price-font-select').addEventListener('change', updateFontPreview);
                $('#product-price-font-weight-select').addEventListener('change', updateFontPreview);
            }

            function listenForUserTicketNotifications(userId) {
                if(userTicketNotificationListener) userTicketNotificationListener();
                userTicketNotificationListener = onSnapshot(siteDataRef, (doc) => {
                    const data = doc.data();
                    const userTickets = data.tickets.filter(t => t.userId === userId);
                    let unreadCount = 0;
                    userTickets.forEach(ticket => {
                        const lastReply = (ticket.replies || []).slice(-1)[0];
                        if (lastReply && lastReply.by === 'admin' && new Date(lastReply.date).getTime() > (ticket.lastUserView || 0)) {
                            unreadCount++;
                        }
                    });
                    updateNotificationBadge('account-tab', unreadCount, '[data-tab="tickets"]');
                });
            }

            async function updateUserTicketView(userId) {
                const now = Date.now();
                let changed = false;
                tickets.forEach(ticket => {
                    if (ticket.userId === userId) {
                        ticket.lastUserView = now;
                        changed = true;
                    }
                });
                if(changed) await saveDataToFirestore({rerenderProducts: false, showAdminToast: false});
            }

            function debounce(func, timeout = 300){ let timer; return (...args) => { clearTimeout(timer); timer = setTimeout(() => { func.apply(this, args); }, timeout); }; }

            init();
        });
    </script>
</body>
</html>
